{
  "name": "Document Upload Error Handler",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Error handler for failed document processing\nconst error = $input.all()[0];\nconst errorMessage = error.json?.error || error.error || 'Unknown error occurred';\nconst originalData = error.json?.originalData || {};\n\n// Log the error for debugging\nconsole.error('Document processing failed:', {\n    error: errorMessage,\n    client: originalData.client,\n    fileName: originalData.fileName,\n    timestamp: new Date().toISOString()\n});\n\n// Determine error type and appropriate response\nlet errorType = 'GENERAL_ERROR';\nlet userMessage = 'Document processing failed. Please try again.';\nlet statusCode = 500;\n\nif (errorMessage.includes('BlobUrl') && errorMessage.includes('required')) {\n    errorType = 'MISSING_PARAMETERS';\n    userMessage = 'Missing required parameters for document conversion. Please check the upload configuration.';\n    statusCode = 400;\n} else if (errorMessage.includes('timeout')) {\n    errorType = 'TIMEOUT';\n    userMessage = 'Document processing timed out. The file may be too large or complex.';\n    statusCode = 408;\n} else if (errorMessage.includes('404')) {\n    errorType = 'NOT_FOUND';\n    userMessage = 'Document not found in storage. Please try uploading again.';\n    statusCode = 404;\n} else if (errorMessage.includes('403') || errorMessage.includes('401')) {\n    errorType = 'AUTHORIZATION';\n    userMessage = 'Authorization error. Please check Azure SAS token configuration.';\n    statusCode = 403;\n}\n\nreturn [{\n    json: {\n        success: false,\n        errorType: errorType,\n        message: userMessage,\n        details: errorMessage,\n        client: originalData.client || 'unknown',\n        fileName: originalData.fileName || 'unknown',\n        timestamp: new Date().toISOString(),\n        statusCode: statusCode\n    }\n}];"
      },
      "id": "error-handler",
      "name": "Process Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseCode": "={{ $json.statusCode }}",
        "responseBody": "{\n  \"success\": false,\n  \"error\": \"={{ $json.message }}\",\n  \"errorType\": \"={{ $json.errorType }}\",\n  \"details\": \"={{ $json.details }}\",\n  \"client\": \"={{ $json.client }}\",\n  \"fileName\": \"={{ $json.fileName }}\",\n  \"timestamp\": \"={{ $json.timestamp }}\"\n}",
        "options": {}
      },
      "id": "error-response",
      "name": "Error Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [650, 300]
    }
  ],
  "connections": {
    "Process Error": {
      "main": [
        [
          {
            "node": "Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "id": "error-handler-workflow"
}

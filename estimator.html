<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ForemanAI - Estimating Assistant</title>
    
    <!-- Mobile Detection and Redirection -->
    <script>
      (function() {
        // Function to detect mobile devices
        function isMobileDevice() {
          // Check user agent
          const userAgent = navigator.userAgent || navigator.vendor || window.opera;
          
          // Check for mobile devices
          const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i;
          
          // Check screen size as additional validation
          const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
          const isMobileScreen = screenWidth <= 768;
          
          // Check if it's a touch device
          const isTouchDevice = ('ontouchstart' in window) || 
                              (navigator.maxTouchPoints > 0) || 
                              (navigator.msMaxTouchPoints > 0);
          
          // Return true if mobile user agent AND (mobile screen OR touch device)
          return mobileRegex.test(userAgent.toLowerCase()) && (isMobileScreen || isTouchDevice);
        }
        
        // Function to get URL parameter
        function getUrlParameter(name) {
          name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
          const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
          const results = regex.exec(location.search);
          return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        // Check if user forced desktop or mobile view
        const forceDesktop = getUrlParameter('desktop') === 'true';
        const forceMobile = getUrlParameter('mobile') === 'true';
        
        // Store user preference if explicitly set
        if (forceDesktop) {
          localStorage.setItem('viewPreference', 'desktop');
        } else if (forceMobile) {
          localStorage.setItem('viewPreference', 'mobile');
        }
        
        // Get stored preference
        const viewPreference = localStorage.getItem('viewPreference');
        
        // Determine where to redirect - redirect to the mobile site hosted on Azure
        if (!forceDesktop && (forceMobile || (isMobileDevice() && viewPreference !== 'desktop'))) {
          // Redirect to mobile version hosted on Azure Static Web Apps (m.html to bypass all caching)
          window.location.replace('https://gentle-pond-0c4e3b90f.2.azurestaticapps.net/m.html');
        }
        // If it's desktop or forced desktop, continue loading this page normally
      })();
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --construction-orange: #ff6b35;
        --safety-yellow: #ffc107;
        --concrete-gray: #424242;
        --steel-gray: #616161;
        --blueprint-blue: #1565c0;
        --hi-vis-green: #76ff03;
        --warning-red: #d32f2f;
        --white: #ffffff;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --dark-gray: #212121;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
        /* Estimating Theme Colors */
        --estimating-gold: #FFD700;
        --calculator-blue: #2E7D32;
        --spreadsheet-green: #107C41;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 35px,
            rgba(255, 193, 7, 0.03) 35px,
            rgba(255, 193, 7, 0.03) 70px
          ),
          repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 35px,
            rgba(255, 107, 53, 0.03) 35px,
            rgba(255, 107, 53, 0.03) 70px
          );
        pointer-events: none;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--dark-gray) 0%,
          var(--concrete-gray) 100%
        );
        color: white;
        padding: 1rem 2rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--estimating-gold);
        position: relative;
        z-index: 10;
      }

      .header::before {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 4px;
        background: repeating-linear-gradient(
          90deg,
          var(--safety-yellow) 0px,
          var(--safety-yellow) 20px,
          var(--dark-gray) 20px,
          var(--dark-gray) 40px
        );
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .page-logo {
        width: 50px;
        height: 50px;
        object-fit: contain;
        margin-right: 1rem;
      }

      .logo-icon {
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        overflow: hidden;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .logo h1 {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--estimating-gold);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .logo .tagline {
        font-size: 1rem;
        color: var(--medium-gray);
        font-weight: 500;
        margin-top: -0.25rem;
      }

      .nav-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
        color: var(--dark-gray);
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(118, 255, 3, 0.1);
        border: 2px solid var(--hi-vis-green);
        border-radius: 20px;
        position: relative;
        cursor: help;
        transition: all 0.3s ease;
      }
      
      .status-indicator:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(118, 255, 3, 0.3);
      }
      
      .status-details {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border: 2px solid var(--medium-gray);
        border-radius: 8px;
        padding: 1rem;
        box-shadow: var(--shadow-lg);
        display: none;
        min-width: 250px;
        z-index: 1000;
      }
      
      .status-indicator:hover .status-details {
        display: block;
        animation: fadeIn 0.2s ease-out;
      }
      
      .status-details h4 {
        margin: 0 0 0.5rem 0;
        color: var(--concrete-gray);
        font-size: 0.9rem;
        border-bottom: 1px solid var(--medium-gray);
        padding-bottom: 0.5rem;
      }
      
      .status-details p {
        margin: 0.25rem 0;
        font-size: 0.85rem;
        color: var(--steel-gray);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .search-stats {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
      }
      
      .search-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
      }
      
      .search-stat:not(:last-child)::after {
        content: "";
        position: absolute;
        right: -0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 1px;
        height: 60%;
        background: rgba(255, 255, 255, 0.2);
      }
      
      .search-stat-value {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--safety-yellow);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }
      
      .search-stat-value.loading {
        opacity: 0.5;
        animation: pulse 1.5s infinite;
      }
      
      .search-stat-label {
        font-size: 0.7rem;
        color: rgba(255, 255, 255, 0.8);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
      }
      
      .maintenance-btn {
        margin-left: 1rem;
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--warning-red), #b71c1c);
        color: white;
        border: 2px solid var(--warning-red);
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .maintenance-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        background: var(--hi-vis-green);
        border-radius: 50%;
        animation: pulse 2s infinite;
        box-shadow: 0 0 10px var(--hi-vis-green);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.2);
        }
      }

      .container {
        flex: 1;
        display: grid;
        grid-template-columns: 400px 1fr 400px;
        gap: 2rem;
        padding: 2rem;
        max-width: 1800px;
        margin: 0 auto;
        width: 100%;
        position: relative;
        z-index: 1;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .rightbar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--medium-gray);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--construction-orange);
      }

      .client-selector {
        margin-bottom: 1rem;
        padding: 1rem;
        background: linear-gradient(
          135deg,
          var(--light-gray) 0%,
          var(--white) 100%
        );
        border-radius: 8px;
        border: 2px solid var(--construction-orange);
      }

      .client-selector label {
        display: block;
        font-weight: 600;
        color: var(--concrete-gray);
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .client-selector select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 1rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .client-selector select:hover {
        border-color: var(--construction-orange);
      }

      .client-selector select:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .document-categories {
        margin-top: 1rem;
      }

      .document-categories h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .document-categories h3::before {
        content: "📁";
        font-size: 1.5rem;
      }

      .category-group {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .category-item {
        background: linear-gradient(
          135deg,
          var(--light-gray) 0%,
          var(--white) 100%
        );
        border: 2px solid var(--medium-gray);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
      }

      .category-item:hover {
        border-color: var(--construction-orange);
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
      }

      .category-header input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--safety-yellow);
      }

      .category-header label {
        flex: 1;
        font-weight: 600;
        color: var(--concrete-gray);
        cursor: pointer;
        font-size: 1rem;
      }

      .category-files {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding-left: 2rem;
      }

      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input-wrapper input[type="file"] {
        display: none;
      }

      .choose-files-btn {
        background: linear-gradient(
          135deg,
          var(--safety-yellow) 0%,
          #f57f17 100%
        );
        color: var(--dark-gray);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .choose-files-btn:hover {
        background: linear-gradient(
          135deg,
          #f57f17 0%,
          var(--safety-yellow) 100%
        );
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.4);
      }

      .file-count {
        font-size: 0.85rem;
        color: var(--steel-gray);
        font-weight: 500;
      }

      .file-list {
        margin-top: 1.5rem;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        border: 1px solid var(--medium-gray);
        background: white;
        border-radius: 4px;
      }

      .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: linear-gradient(135deg, var(--blueprint-blue), #0d47a1);
        color: white;
        border-radius: 8px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .file-list-header h4 {
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .file-list-header h4::before {
        content: "📂";
        font-size: 1.2rem;
      }

      .refresh-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85rem;
      }

      .refresh-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .existing-file-item {
        display: flex;
        flex-direction: column;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid transparent;
        margin: 0 0.5rem 4px 0.5rem;
        transition: all 0.1s ease;
        cursor: pointer;
        user-select: none;
        min-height: 60px;
      }

      .existing-file-item:hover {
        background: #e8f4fd;
        border: 1px solid #0078d4;
      }
      
      .existing-file-item.selected {
        background: #cce8ff;
        border: 1px solid #0078d4;
      }
      
      .folder-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid transparent;
        margin: 0 0.5rem 2px 0.5rem;
        cursor: pointer;
        user-select: none;
        transition: all 0.1s ease;
        min-height: 40px;
      }
      
      .folder-item:hover {
        background: #e8f4fd;
        border: 1px solid #0078d4;
      }
      
      .folder-item.selected {
        background: #cce8ff;
        border: 1px solid #0078d4;
      }
      
      .file-browser-navigation {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: #f8f8f8;
        border-bottom: 1px solid var(--medium-gray);
        margin-bottom: 0.75rem;
        gap: 0.75rem;
      }
      
      .nav-button {
        padding: 0.5rem;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        border-radius: 3px;
        font-size: 1.2rem;
        line-height: 1;
        transition: all 0.1s ease;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        white-space: nowrap;
      }
      
      .nav-button:hover:not(:disabled) {
        background: #e8f4fd;
        border-color: #0078d4;
      }
      
      .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .breadcrumb {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #ccc;
        border-radius: 3px;
        overflow-x: auto;
        min-height: 36px;
        white-space: nowrap;
      }
      
      .breadcrumb-item {
        color: #0078d4;
        cursor: pointer;
        white-space: nowrap;
      }
      
      .breadcrumb-item:hover {
        text-decoration: underline;
      }
      
      .breadcrumb-separator {
        color: #666;
        margin: 0 0.25rem;
      }

      .existing-file-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        margin-bottom: 0.5rem;
      }
      
      .file-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
      }
      
      .file-icon svg {
        width: 100%;
        height: 100%;
      }

      .existing-file-name {
        flex: 1;
        color: var(--concrete-gray);
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }

      .existing-file-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: var(--steel-gray);
        align-items: center;
      }
      
      .file-meta-item {
        min-width: 70px;
        text-align: left;
      }
      
      .file-meta-date {
        min-width: 100px;
      }

      .existing-file-category {
        display: none;
      }

      .existing-file-actions {
        display: flex;
        gap: 0.4rem;
        align-items: center;
        margin-left: auto;
      }

      .file-action-btn {
        padding: 0.3rem 0.6rem;
        border: 1px solid #d0d0d0;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.75rem;
        transition: all 0.1s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.2rem;
        white-space: nowrap;
        color: var(--concrete-gray);
      }

      .file-action-btn:hover {
        background: #f0f0f0;
        border-color: #999;
      }
      
      .file-details-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding-left: 28px;
      }
      
      .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        border-radius: 3px;
        padding: 0.25rem 0;
        z-index: 1000;
        display: none;
        min-width: 150px;
      }
      
      .context-menu.show {
        display: block;
      }
      
      .context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--concrete-gray);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .context-menu-item:hover {
        background: #e8f4fd;
      }
      
      .context-menu-separator {
        height: 1px;
        background: #e0e0e0;
        margin: 0.25rem 0;
      }

      .file-action-btn.reindex {
        background: var(--hi-vis-green);
        color: var(--dark-gray);
      }

      .file-action-btn.reindex:hover {
        background: #64dd17;
        transform: scale(1.05);
      }

      .no-files-message {
        text-align: center;
        padding: 2rem;
        color: var(--steel-gray);
        font-style: italic;
        background: var(--light-gray);
        border-radius: 8px;
        border: 2px dashed var(--medium-gray);
      }

      .loading-indicator {
        display: none;
        text-align: center;
        padding: 1.5rem;
        color: var(--steel-gray);
        background: var(--light-gray);
        border-radius: 8px;
        margin: 0.5rem 0;
      }

      .loading-indicator.active {
        display: block;
      }

      .loading-indicator::before {
        content: "⏳";
        font-size: 1.5rem;
        display: block;
        margin-bottom: 0.5rem;
        animation: pulse 1.5s infinite;
      }

      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: var(--light-gray);
        border-left: 4px solid var(--construction-orange);
        margin-bottom: 0.5rem;
        border-radius: 0 5px 5px 0;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .file-item .file-name {
        flex: 1;
        font-size: 0.9rem;
        color: var(--concrete-gray);
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-item .file-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .file-item .file-category {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        background: var(--construction-orange);
        color: white;
        border-radius: 3px;
        font-weight: 600;
      }

      .file-item .file-size {
        font-size: 0.8rem;
        color: var(--steel-gray);
      }

      .remove-file {
        background: var(--warning-red);
        color: white;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        font-weight: bold;
      }

      .remove-file:hover {
        background: #b71c1c;
        transform: scale(1.1);
      }

      .process-button {
        width: 100%;
        background: linear-gradient(
          135deg,
          var(--hi-vis-green) 0%,
          #64dd17 100%
        );
        color: var(--dark-gray);
        border: none;
        padding: 1rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 8px rgba(118, 255, 3, 0.3);
      }

      .process-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(118, 255, 3, 0.4);
      }

      .process-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
        position: relative;
      }

      .chat-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--construction-orange);
      }

      .chat-header {
        background: linear-gradient(
          135deg,
          var(--concrete-gray) 0%,
          var(--steel-gray) 100%
        );
        color: white;
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--safety-yellow);
      }

      .chat-header h2 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .chat-header h2::before {
        content: "👷";
        font-size: 1.8rem;
      }

      .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        display: flex;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.assistant .message-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--safety-yellow) 0%,
          #f57f17 100%
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        font-size: 20px;
        color: var(--dark-gray);
      }

      .message-content {
        max-width: 70%;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(
          135deg,
          #ffab70 0%,
          #ff8a50 100%
        );
        color: white;
        border-bottom-right-radius: 3px;
      }

      .message.user .message-time {
        color: #2c2c2c;
        font-weight: 500;
      }

      .message.assistant .message-content {
        background: white;
        color: var(--concrete-gray);
        border-bottom-left-radius: 3px;
        border: 1px solid var(--medium-gray);
      }

      /* Enhanced message content styling */
      .message-content .formatted-content {
        line-height: 1.6;
        word-wrap: break-word;
      }

      .message-content .formatted-content a {
        color: var(--blueprint-blue);
        text-decoration: underline;
        word-break: break-all;
        transition: color 0.2s ease;
      }

      .message-content .formatted-content a:hover {
        color: var(--construction-orange);
      }

      .message-content .formatted-content strong {
        font-weight: 600;
        color: var(--concrete-gray);
      }

      .message-content .formatted-content em {
        font-style: italic;
        color: var(--steel-gray);
      }

      .message-content .formatted-content p {
        margin-bottom: 0.75rem;
      }

      .message-content .formatted-content p:last-child {
        margin-bottom: 0;
      }

      .message-content .formatted-content ul,
      .message-content .formatted-content ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }

      .message-content .formatted-content li {
        margin-bottom: 0.25rem;
      }

      .message-content .formatted-content hr {
        border: none;
        border-top: 2px solid var(--medium-gray);
        margin: 1rem 0;
        opacity: 0.5;
      }

      .message-time {
        font-size: 0.75rem;
        color: #95a5a6;
        margin-top: 0.5rem;
      }

      .chat-input-container {
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 10px 10px;
        border-top: 2px solid var(--medium-gray);
      }

      .ai-disclaimer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--dark-gray);
      }

      .disclaimer-icon {
        font-size: 1rem;
        flex-shrink: 0;
      }

      .disclaimer-text {
        line-height: 1.4;
      }

      .disclaimer-text strong {
        color: #d68910;
        font-weight: 600;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .chat-context-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: var(--light-gray);
        border-radius: 8px;
        border: 1px solid var(--medium-gray);
      }

      .chat-context-selector label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--concrete-gray);
        white-space: nowrap;
      }

      .chat-context-selector select {
        padding: 0.5rem;
        border: 1px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
      }

      .chat-context-selector select:hover {
        border-color: var(--construction-orange);
      }

      .chat-context-selector select:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
      }

      .chat-input-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        width: 100%;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--medium-gray);
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }
      
      /* Image paste and analysis styles */
      .image-preview-area {
        display: none;
        padding: 1rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%);
        border: 2px dashed var(--blueprint-blue);
        border-radius: 8px;
        margin-bottom: 1rem;
        position: relative;
        min-height: 120px;
        max-height: 300px;
        overflow-x: auto;
        white-space: nowrap;
      }
      
      .image-preview-area.active {
        display: block;
      }
      
      .image-preview-item {
        display: inline-block;
        margin: 0.5rem;
        position: relative;
        border: 2px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        background: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
      }
      
      .image-preview-item:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      .image-preview-item img {
        max-width: 200px;
        max-height: 200px;
        display: block;
      }
      
      .image-preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255,0,0,0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        transition: all 0.2s ease;
      }
      
      .image-preview-item .remove-btn:hover {
        background: rgba(255,0,0,1);
        transform: scale(1.1);
      }
      
      .analysis-status {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.25rem;
        font-size: 0.75rem;
        text-align: center;
      }
      
      .analysis-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 25px;
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 0.5rem;
        display: none;
        overflow-y: auto;
        font-size: 0.8rem;
      }
      
      .image-preview-item:hover .analysis-overlay {
        display: block;
      }
      
      .image-attach-button {
        background: linear-gradient(135deg, var(--blueprint-blue), #0d47a1);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 50%;
        cursor: pointer;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 1.2rem;
      }
      
      .image-attach-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(21, 101, 192, 0.4);
      }
      
      .chat-container.drag-over {
        background: linear-gradient(135deg, rgba(21, 101, 192, 0.1), rgba(255, 107, 53, 0.1));
        border: 3px dashed var(--blueprint-blue);
      }
      
      .chat-container.drag-over::after {
        content: "Drop images here to analyze";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        color: var(--blueprint-blue);
        font-weight: bold;
        pointer-events: none;
        z-index: 1000;
        background: white;
        padding: 1rem 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .send-button {
        background: linear-gradient(
          135deg,
          #ffab70 0%,
          #ff8a50 100%
        );
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(255, 171, 112, 0.3);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        width: fit-content;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-left: 3.5rem;
      }

      .typing-indicator.active {
        display: flex;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--construction-orange);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      .metadata-panel {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 10px;
        border: 2px solid var(--construction-orange);
        box-shadow: var(--shadow-lg);
      }

      .metadata-panel h3 {
        margin-bottom: 1rem;
        color: var(--concrete-gray);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .metadata-panel h3::before {
        content: "📊";
        font-size: 1.5rem;
      }

      .metadata-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        border-bottom: 1px solid var(--medium-gray);
        background: var(--light-gray);
        margin-bottom: 0.5rem;
        border-radius: 5px;
      }

      .metadata-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .metadata-label {
        font-weight: 600;
        color: var(--concrete-gray);
        font-size: 0.95rem;
      }

      .metadata-value {
        color: var(--steel-gray);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .metadata-value.status-active {
        color: var(--hi-vis-green);
        font-weight: bold;
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: var(--medium-gray);
        border-radius: 15px;
        overflow: hidden;
        margin-top: 1rem;
        display: none;
        border: 2px solid var(--steel-gray);
      }

      .progress-bar.active {
        display: block;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--construction-orange),
          var(--safety-yellow)
        );
        border-radius: 13px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--dark-gray);
        font-weight: bold;
      }

      .error-message {
        background: linear-gradient(135deg, var(--warning-red), #b71c1c);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
      }

      .error-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      /* Capabilities button hover effect */
      .capabilities-btn:hover .capabilities-dropdown {
        display: block !important;
        animation: fadeInUp 0.2s ease-out;
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateX(-50%) translateY(0);
        }
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(-10px);
        }
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }

        .sidebar {
          order: 2;
        }

        .chat-container {
          height: 500px;
          order: 1;
        }

        .message-content {
          max-width: 85%;
        }

        .category-item {
          padding: 0.75rem;
        }

        .category-files {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .logo-icon {
          width: 80px;
          height: 80px;
        }

        .logo h1 {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <img src="estimator.png" alt="Estimating Assistant" />
        </div>
        <div>
          <h1>ASK FOREMAN AI</h1>
          <p class="tagline">Construction Estimating Assistant</p>
        </div>
      </div>
      <div class="nav-buttons">
        <a href="index.html" class="nav-btn">🏠 Home</a>
        <a href="general-chat.html" class="nav-btn">💬 General</a>
        <a href="projects.html" class="nav-btn">📁 Projects</a>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <div class="card">
          <div class="client-selector">
            <label for="clientSelect">🏢 Select Project:</label>
            <select id="clientSelect">
              <option value="">-- Choose a Project --</option>
            </select>
          </div>

          <div class="document-categories">
            <h3>Document Upload Center</h3>
            <div class="category-group">
              <div class="category-item">
                <div class="category-header">
                  <input
                    type="checkbox"
                    id="drawings"
                    value="drawings"
                  />
                  <label for="drawings">📐 Drawings & Plans</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="drawingsFiles"
                      multiple
                      accept=".pdf,.doc,.docx,.xlsx,.xls"
                      data-category="drawings"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('drawingsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="drawingsCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input
                    type="checkbox"
                    id="estimates"
                    value="estimates"
                  />
                  <label for="estimates">💰 Estimates</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="estimatesFiles"
                      multiple
                      accept=".pdf,.doc,.docx,.xlsx,.xls"
                      data-category="estimates"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('estimatesFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="estimatesCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input
                    type="checkbox"
                    id="proposals"
                    value="proposals"
                  />
                  <label for="proposals">📊 Proposals</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="proposalsFiles"
                      multiple
                      accept=".pdf,.doc,.docx,.xlsx,.xls"
                      data-category="proposals"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('proposalsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="proposalsCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input type="checkbox" id="specs" value="specs" />
                  <label for="specs">📋 Specs</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="specsFiles"
                      multiple
                      accept=".pdf,.doc,.docx,.xlsx,.xls"
                      data-category="specs"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('specsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="specsCount">0 files</span>
                </div>
              </div>

              <div class="category-item">
                <div class="category-header">
                  <input type="checkbox" id="signed-contracts" value="signed-contracts" />
                  <label for="signed-contracts">📝 Signed Contracts</label>
                </div>
                <div class="category-files">
                  <div class="file-input-wrapper">
                    <input
                      type="file"
                      id="signed-contractsFiles"
                      multiple
                      accept=".pdf,.doc,.docx,.xlsx,.xls"
                      data-category="signed-contracts"
                    />
                    <button
                      class="choose-files-btn"
                      onclick="document.getElementById('signed-contractsFiles').click()"
                    >
                      Choose Files
                    </button>
                  </div>
                  <span class="file-count" id="signed-contractsCount">0 files</span>
                </div>
              </div>
            </div>
          </div>

          <div class="file-list" id="fileList">
            <div class="loading-indicator" id="filesLoadingIndicator">
              Loading existing files...
            </div>
          </div>

          <div class="error-message" id="errorMessage"></div>

          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>

          <button
            class="process-button"
            id="processButton"
            disabled
          >
            🚧 Process Documents
          </button>

          <button
            class="process-button"
            id="createClientButton"
            style="
              background: linear-gradient(
                135deg,
                var(--safety-yellow),
                #f57f17
              );
              color: var(--dark-gray);
              margin-top: 0.5rem;
            "
          >
            ➕ Create New Project
          </button>
        </div>

        <!-- Index Status moved to admin.html -->
      </aside>

      <main class="card chat-container">
        <div class="chat-header">
          <h2>Construction AI Assistant</h2>
          <span style="font-size: 0.9rem; opacity: 0.8"
            >Powered by SAX Technology Advisors</span
          >
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-avatar">🔨</div>
            <div class="message-content">
              <div class="formatted-content">
                <p><strong>Hi, I'm your AI Foreman!</strong></p>
                <p>
                  I help with construction estimating, specifications, and project questions.
                  <span class="capabilities-btn" style="
                    display: inline-block;
                    margin-left: 0.5rem;
                    padding: 0.2rem 0.6rem;
                    background: linear-gradient(135deg, var(--blueprint-blue), #0d47a1);
                    color: white;
                    border-radius: 12px;
                    font-size: 0.85rem;
                    cursor: help;
                    position: relative;
                    font-weight: 500;
                    transition: all 0.2s ease;
                  ">
                    View Capabilities
                    <div class="capabilities-dropdown" style="
                      position: absolute;
                      bottom: 100%;
                      left: 50%;
                      transform: translateX(-50%) translateY(-10px);
                      background: white;
                      border: 2px solid var(--blueprint-blue);
                      border-radius: 8px;
                      padding: 1rem;
                      min-width: 320px;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                      display: none;
                      z-index: 1000;
                      color: var(--concrete-gray);
                      font-weight: normal;
                      font-size: 0.9rem;
                      line-height: 1.5;
                    ">
                      <div style="
                        position: absolute;
                        bottom: -6px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 12px;
                        height: 12px;
                        background: white;
                        border-right: 2px solid var(--blueprint-blue);
                        border-bottom: 2px solid var(--blueprint-blue);
                        transform: translateX(-50%) rotate(45deg);
                      "></div>
                      <h4 style="margin: 0 0 0.75rem 0; color: var(--blueprint-blue); font-size: 1rem;">🛠️ I can help with:</h4>
                      <ul style="margin: 0; padding-left: 1.2rem; list-style: none;">
                        <li style="margin: 0.4rem 0;">🎨 Paint scope, quantities, and color schedules</li>
                        <li style="margin: 0.4rem 0;">🏗️ Floor coatings and finish specifications</li>
                        <li style="margin: 0.4rem 0;">📐 Room schedules and area calculations</li>
                        <li style="margin: 0.4rem 0;">📋 Material specifications and building codes</li>
                        <li style="margin: 0.4rem 0;">🚪 Door/frame schedules and hardware</li>
                        <li style="margin: 0.4rem 0;">🏢 Structural steel and CMU calculations</li>
                        <li style="margin: 0.4rem 0;">💰 Cost estimates and construction takeoffs</li>
                      </ul>
                    </div>
                  </span>
                </p>
                <p>
                  <strong>💡 Pro tip:</strong> Use the "Focus on" dropdown below
                  to search specific project documents.
                </p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>

        <div class="chat-input-container">
          <!-- Image preview area for pasted/attached images -->
          <div id="imagePreviewArea" class="image-preview-area" style="display: none;"></div>
          
          <div class="chat-input-wrapper">
            <div class="chat-context-selector">
              <label for="chatClientSelect">🎯 Focus on:</label>
              <select id="chatClientSelect">
                <option value="general">General Construction Knowledge</option>
              </select>
            </div>
            <div class="chat-input-row">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Ask about construction estimating, specifications, or any project questions..."
              />
              <!-- Hidden file input for image attachments -->
              <input type="file" id="imageFileInput" accept="image/*,.pdf" style="display: none;" multiple />
              <!-- Attachment button -->
              <button class="image-attach-button" id="attachButton" title="Attach images or drawings">
                📎
              </button>
              <button class="send-button" id="sendButton">
                <span>Send</span>
                <span>→</span>
              </button>
            </div>
          </div>

          <!-- AI Disclaimer -->
          <div class="ai-disclaimer">
            <span class="disclaimer-icon">⚠️</span>
            <span class="disclaimer-text">
              Ask Foreman AI <strong>can make mistakes</strong> and you should verify important information.
            </span>
          </div>
        </div>
      </main>

      <!-- Right Sidebar -->
      <aside class="rightbar">
        <!-- Quick Tools Section -->
        <div class="card">
          <h3 style="color: var(--concrete-gray); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">🛠️</span> Quick Estimating Tools
          </h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <button onclick="openCostCalculator()" 
               class="quick-tool-btn"
               style="
                 display: flex;
                 align-items: center;
                 gap: 0.75rem;
                 padding: 1rem;
                 background: linear-gradient(135deg, var(--estimating-gold) 0%, #FFB300 100%);
                 color: var(--dark-gray);
                 text-decoration: none;
                 border-radius: 8px;
                 transition: all 0.3s ease;
                 border: 2px solid transparent;
               " 
               onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(255, 215, 0, 0.3)';"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';"
               style="
                 width: 100%;
                 cursor: pointer;
                 font-family: inherit;
               ">
              <span style="font-size: 1.5rem;">🧮</span>
              <div style="text-align: left;">
                <div style="font-weight: 600; font-size: 1rem;">Construction Cost Calculator</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Quick material and labor estimates</div>
              </div>
            </button>
            
            <button onclick="openEstimatorForm()" 
               class="quick-tool-btn" 
               style="
                 display: flex;
                 align-items: center;
                 gap: 0.75rem;
                 padding: 1rem;
                 background: linear-gradient(135deg, #FFB300 0%, #FF6F00 100%);
                 color: white;
                 text-decoration: none;
                 border-radius: 8px;
                 transition: all 0.3s ease;
                 border: 2px solid transparent;
                 width: 100%;
                 border: none;
                 cursor: pointer;
                 font-family: inherit;
                 margin-bottom: 0.75rem;
               "
               onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(255, 111, 0, 0.3)';"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
              <span style="font-size: 1.5rem;">📊</span>
              <div style="text-align: left;">
                <div style="font-weight: 600; font-size: 1rem;">Professional Estimator</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Complete estimate builder</div>
              </div>
            </button>
            
            <button onclick="openDigitalTakeoffAssistant()"
               class="quick-tool-btn" 
               style="
                 display: flex;
                 align-items: center;
                 gap: 0.75rem;
                 padding: 1rem;
                 background: linear-gradient(135deg, var(--spreadsheet-green) 0%, #0E5C2F 100%);
                 color: white;
                 text-decoration: none;
                 border-radius: 8px;
                 transition: all 0.3s ease;
                 border: 2px solid transparent;
                 width: 100%;
                 border: none;
                 cursor: pointer;
                 font-family: inherit;
               "
               onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(16, 124, 65, 0.3)';"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
              <span style="font-size: 1.5rem;">📐</span>
              <div style="text-align: left;">
                <div style="font-weight: 600; font-size: 1rem;">Digital Takeoff Assistant</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">AI-powered drawing analysis</div>
              </div>
            </button>
          </div>
        </div>

        <!-- Knowledge Graph Tips for Estimating -->
        <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #f0f8ff, #e8f4fd); border: 2px solid var(--blueprint-blue);">
          <h3 style="color: var(--blueprint-blue); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">💡</span> Estimating Knowledge Graph
          </h3>
          <div style="font-size: 0.9rem; color: var(--concrete-gray); line-height: 1.6;">
            <p style="margin-bottom: 0.75rem;">
              <strong>Smart Estimate Creation:</strong> The Knowledge Graph helps you create accurate estimates by:
            </p>
            <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
              <li style="margin-bottom: 0.5rem;">📊 Finding similar past estimates from completed projects</li>
              <li style="margin-bottom: 0.5rem;">💰 Comparing material costs across different suppliers</li>
              <li style="margin-bottom: 0.5rem;">⚡ Identifying cost-saving alternatives from other projects</li>
              <li style="margin-bottom: 0.5rem;">📈 Tracking price trends and escalation factors</li>
            </ul>
            <p style="margin-bottom: 0.5rem;">
              <strong>Try asking:</strong> <em>"What was the cost per square foot for similar painting projects?"</em> or 
              <em>"Compare flooring material costs from our last three commercial projects"</em>
            </p>
          </div>
        </div>
      </aside>
    </div>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Enhanced Image Handler Script with Azure Computer Vision -->
    <script src="js/chat-image-handler-v2.js"></script>
    
    <!-- Knowledge Graph Integration -->
    <script src="js/knowledge-graph.js"></script>
    
    <!-- Comprehensive Fixes for UI/UX and Performance -->
    <script src="js/comprehensive-fixes.js"></script>
    
    <!-- Enhanced Takeoff System with Azure AI -->
    <script src="js/drawing-highlight-analyzer.js"></script>
    <script src="js/enhanced-takeoff-module.js"></script>
    <script type="module" src="js/drawing-analyzer-ai.js"></script>
    
    <script>
      // Configuration - Production webhook URLs
      const API_CONFIG = {
        chatWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/EstimatorChat", // Estimator-specific webhook
        uploadWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/upload",
        createClientWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/clients/create",
        listClientsWebhookUrl:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/clients/list",
        indexName: "fcs-construction-docs-index-v2", // Updated index name
        knowledgeGraphWebhook:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/knowledge-graph",
        calculatorWebhook:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/tools/cost-calculator",
        googleSearchWebhook:
          "https://workflows.saxtechnology.com/webhook/ask-foreman/tools/google-search",
      };
      
      // Azure AI Services Configuration
      const AZURE_AI_CONFIG = {
        // Document Intelligence (Form Recognizer) for layout extraction
        documentIntelligence: {
          endpoint: "https://saxtechfcs-docintell.cognitiveservices.azure.com/",
          apiKey: "4bb39c8e89144f9c808f2cfaa887e3d6", // Production key
          apiVersion: "2023-07-31"
        },
        // Computer Vision for image analysis and OCR
        computerVision: {
          endpoint: "https://askforeman-vision.cognitiveservices.azure.com/",
          apiKey: "3afa37e3f6ec4cf891e0f5f6e5cf896c", // Production key
          apiVersion: "2023-02-01-preview"
        },
        // Custom Vision for symbol detection (if trained)
        customVision: {
          predictionEndpoint: "https://saxtechfcs-customvision.cognitiveservices.azure.com/",
          predictionKey: "YOUR_CUSTOM_VISION_KEY", // Replace with your key when available
          projectId: "YOUR_PROJECT_ID", // Replace with your project ID when available
          iterationName: "YOUR_ITERATION_NAME" // Replace with your iteration when available
        }
      };

      // Azure Blob Storage Configuration
      const AZURE_STORAGE = {
        account: "saxtechfcs",
        container: "fcs-clients", // Single container with two folders: FCS-OriginalClients and FCS-ConvertedClients
        sasToken: "?sp=racwdl&st=2025-08-08T05:00:57Z&se=2030-08-08T13:15:57Z&spr=https&sv=2024-11-04&sr=c&sig=lJKK9jDZ59pJSNkKSgwaQIrCdBaJzx4XPzgEB2%2FrnIg%3D"
      };

      // File Management
      let uploadedFiles = {
        drawings: [],
        estimates: [],
        proposals: [],
        specs: [],
        "signed-contracts": [],
      };
      let processedDocuments = 0;
      let totalDocumentCount = 0; // Track total documents across all clients
      let selectedClient = "";

      // DOM Elements
      const fileList = document.getElementById("fileList");
      const processButton = document.getElementById("processButton");
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      const chatMessages = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const clientSelect = document.getElementById("clientSelect");
      const chatClientSelect = document.getElementById("chatClientSelect");
      const errorMessage = document.getElementById("errorMessage");
      const createClientButton = document.getElementById("createClientButton");

      // Track chat context separately from upload client
      let chatContext = "general";

      // Enhanced message formatting function - ChatGPT style
      function formatMessageContent(content) {
        if (!content) return '';
        
        // Ensure content is a string
        content = String(content);
        
        // Handle file references with clickable links
        // Format: [[filename.pdf]] or [[Category/filename.pdf]] or [[ClientName/Category/filename.pdf]]
        content = content.replace(/\[\[([^\]]+)\]\]/g, (match, filePath) => {
          const pathParts = filePath.split('/');
          const fileName = pathParts[pathParts.length - 1];
          
          // Determine the client context - use chatContext for chat messages
          let clientName = chatContext || 'general';
          let finalPath = filePath;
          
          // If path has 3 parts, first might be client name
          if (pathParts.length === 3) {
            clientName = pathParts[0];
            finalPath = pathParts.slice(1).join('/');
          } else if (pathParts.length === 2) {
            // Category/filename format - use current chat context
            finalPath = filePath;
          } else {
            // Just filename - try to determine category from filename
            if (fileName.toLowerCase().includes('proposal')) {
              finalPath = `proposals/${fileName}`;
            } else if (fileName.toLowerCase().includes('drawing') || fileName.toLowerCase().includes('plan')) {
              finalPath = `drawings/${fileName}`;
            } else if (fileName.toLowerCase().includes('estimate')) {
              finalPath = `estimates/${fileName}`;
            } else if (fileName.toLowerCase().includes('spec')) {
              finalPath = `specs/${fileName}`;
            } else if (fileName.toLowerCase().includes('contract')) {
              finalPath = `signed-contracts/${fileName}`;
            } else {
              // Default to documents folder
              finalPath = `documents/${fileName}`;
            }
          }
          
          // Generate Azure Blob URL for the file
          const encodedPath = finalPath.split('/').map(segment => encodeURIComponent(segment)).join('/');
          const fileUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${clientName}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          // Add Content-Disposition inline to force browser display instead of download
          const displayUrl = fileUrl + '&response-content-disposition=' + encodeURIComponent('inline');
          
          return `<a href="${displayUrl}" target="_blank" class="file-reference" style="color: var(--blueprint-blue); text-decoration: underline; font-weight: 500;">📄 ${fileName}</a>`;
        });
        
        // Handle code blocks with proper formatting
        content = content.replace(/```([\s\S]*?)```/g, '<pre style="background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow-x: auto; margin: 1rem 0;"><code>$1</code></pre>');
        content = content.replace(/`([^`]+)`/g, '<code style="background: #f6f8fa; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace;">$1</code>');
        
        // Handle numbered lists
        content = content.replace(/^(\d+)\.\s+(.*)$/gm, (match, num, text) => {
          return `<li style="margin-left: 1.5rem; list-style: decimal;">${text}</li>`;
        });
        
        // Wrap consecutive list items in <ol> tags
        content = content.replace(/(<li style="margin-left: 1\.5rem; list-style: decimal;">.*<\/li>\s*)+/g, (match) => {
          return `<ol style="margin: 0.5rem 0; padding-left: 1rem;">${match}</ol>`;
        });
        
        // Handle bullet lists (multiple formats)
        content = content.replace(/^[•\-\*]\s+(.*)$/gm, '<li style="margin-left: 1.5rem; list-style: disc;">$1</li>');
        
        // Wrap consecutive bullet items in <ul> tags
        content = content.replace(/(<li style="margin-left: 1\.5rem; list-style: disc;">.*<\/li>\s*)+/g, (match) => {
          return `<ul style="margin: 0.5rem 0; padding-left: 1rem;">${match}</ul>`;
        });
        
        // Handle headers (markdown style)
        content = content.replace(/^### (.*)$/gm, '<h3 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; font-weight: 600; color: var(--concrete-gray);">$1</h3>');
        content = content.replace(/^## (.*)$/gm, '<h2 style="margin: 1rem 0 0.5rem 0; font-size: 1.3rem; font-weight: 600; color: var(--concrete-gray);">$1</h2>');
        content = content.replace(/^# (.*)$/gm, '<h1 style="margin: 1rem 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--concrete-gray);">$1</h1>');
        
        // Convert line breaks to proper HTML paragraphs
        const lines = content.split(/\n\n+/);
        content = lines.map(line => {
          // Don't wrap if already wrapped in HTML tags
          if (line.trim().startsWith('<') || line.trim() === '') {
            return line;
          }
          // Don't wrap list items or headers
          if (line.includes('<li') || line.includes('<h1') || line.includes('<h2') || line.includes('<h3') || line.includes('<ul') || line.includes('<ol') || line.includes('<pre')) {
            return line;
          }
          return `<p style="margin: 0.75rem 0; line-height: 1.6;">${line}</p>`;
        }).join('\n');
        
        // Convert single line breaks to <br> within paragraphs
        content = content.replace(/([^>])\n([^<])/g, '$1<br>$2');
        
        // Convert markdown-style formatting
        content = content.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
        content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\*(.+?)\*/g, '<em>$1</em>');
        content = content.replace(/__(.+?)__/g, '<strong>$1</strong>');
        content = content.replace(/_(.+?)_/g, '<em>$1</em>');
        
        // Convert URLs to clickable links with better styling (but not those already in anchor tags)
        const urlRegex = /(?<!href=")(?<!src=")(https?:\/\/[^\s<>"]+)(?![^<]*<\/a>)/g;
        content = content.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: var(--blueprint-blue); text-decoration: underline;">$1</a>');
        
        // Handle horizontal rules
        content = content.replace(/^---+$/gm, '<hr style="border: none; border-top: 1px solid var(--medium-gray); margin: 1rem 0;">');
        
        // Handle source citations with file links
        content = content.replace(/📎\s*Source:\s*(.+?)(?=<|$)/g, (match, source) => {
          // Check if it's a URL
          if (source.startsWith('http')) {
            return `<div style="margin: 0.75rem 0; padding: 0.75rem; background: linear-gradient(135deg, #f0f8ff, #e8f4fd); border-left: 3px solid var(--blueprint-blue); border-radius: 4px;">
              <span style="font-size: 0.9rem; color: var(--steel-gray); font-weight: 500;">📎 Source:</span>
              <a href="${source}" target="_blank" rel="noopener noreferrer" style="font-size: 0.9rem; color: var(--blueprint-blue); margin-left: 0.5rem;">${source}</a>
            </div>`;
          } else {
            // It's a file name - create Azure Blob link
            const clientName = chatContext || 'general';
            const fileName = source.trim();
            const encodedFile = encodeURIComponent(fileName);
            // Add Content-Disposition inline to force browser display
            const fileUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${clientName}/${encodedFile}${AZURE_STORAGE.sasToken}&response-content-disposition=${encodeURIComponent('inline')}`;
            
            return `<div style="margin: 0.75rem 0; padding: 0.75rem; background: linear-gradient(135deg, #f0f8ff, #e8f4fd); border-left: 3px solid var(--blueprint-blue); border-radius: 4px;">
              <span style="font-size: 0.9rem; color: var(--steel-gray); font-weight: 500;">📎 Source:</span>
              <a href="${fileUrl}" target="_blank" rel="noopener noreferrer" style="font-size: 0.9rem; color: var(--blueprint-blue); margin-left: 0.5rem;">📄 ${fileName}</a>
            </div>`;
          }
        });
        
        // Handle tables (simple markdown tables)
        content = content.replace(/\|(.+)\|/g, (match) => {
          const rows = match.split('\n').filter(row => row.trim());
          if (rows.length > 0) {
            let tableHtml = '<table style="border-collapse: collapse; margin: 1rem 0; width: 100%;">';
            rows.forEach((row, index) => {
              const cells = row.split('|').filter(cell => cell.trim());
              const tag = index === 0 ? 'th' : 'td';
              const style = index === 0 ? 
                'style="padding: 0.5rem; border: 1px solid var(--medium-gray); background: var(--light-gray); font-weight: 600;"' : 
                'style="padding: 0.5rem; border: 1px solid var(--medium-gray);"';
              tableHtml += '<tr>';
              cells.forEach(cell => {
                tableHtml += `<${tag} ${style}>${cell.trim()}</${tag}>`;
              });
              tableHtml += '</tr>';
            });
            tableHtml += '</table>';
            return tableHtml;
          }
          return match;
        });
        
        // Clean up any empty paragraphs
        content = content.replace(/<p[^>]*>\s*<\/p>/g, '');
        content = content.replace(/<p[^>]*>\s*<br>\s*<\/p>/g, '');
        
        // Add overall container for better styling
        return `<div style="font-size: 0.95rem; color: var(--concrete-gray);">${content}</div>`;
      }

      // Enhanced addMessage function with better formatting
      function addMessage(content, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        // Format the content for proper display
        const formattedContent = sender === "assistant" ? formatMessageContent(content) : escapeHtml(content);

        if (sender === "assistant") {
          messageDiv.innerHTML = `
            <div class="message-avatar">🔨</div>
            <div class="message-content">
              <div class="formatted-content">${formattedContent}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="formatted-content">${formattedContent}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        }

        // Safely insert message before typing indicator
        try {
          if (typingIndicator && typingIndicator.parentNode === chatMessages) {
            chatMessages.insertBefore(messageDiv, typingIndicator);
          } else {
            chatMessages.appendChild(messageDiv);
          }
        } catch (error) {
          console.error("Error inserting message:", error);
          chatMessages.appendChild(messageDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Helper function to escape HTML for user messages
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Create Client button handler
      createClientButton.addEventListener("click", () => {
        openCreateClientModal();
      });

      // Chat context selection handler
      chatClientSelect.addEventListener("change", (e) => {
        chatContext = e.target.value;
        const contextName =
          chatClientSelect.options[chatClientSelect.selectedIndex].text;

        if (chatContext === "general") {
          addSystemMessage(
            "🌐 Chat context set to General Construction Knowledge. I'll provide industry-standard guidance and best practices."
          );
          chatInput.placeholder =
            "Ask about construction estimating, specifications, or any project questions...";
        } else if (chatContext === "combined-projects") {
          addSystemMessage(
            "🔍 Knowledge Graph mode activated! I can now search and correlate information across ALL client projects. This allows me to:\n" +
            "• Find similar solutions from other projects\n" +
            "• Compare specifications and costs across clients\n" +
            "• Identify patterns and best practices\n" +
            "• Cross-reference materials and methods"
          );
          chatInput.placeholder = "Search across all projects for patterns, comparisons, or insights...";
        } else {
          addSystemMessage(
            `🎯 Chat context focused on ${contextName}. I'll prioritize information from this project's documents.`
          );
          chatInput.placeholder = `Ask about ${contextName} project details, specifications, or requirements...`;
        }
      });

      // Client selection handler (for document uploads)
      clientSelect.addEventListener("change", async (e) => {
        if (e.target.value === 'retry') {
          await loadClients();
          return;
        }
        selectedClient = e.target.value;
        if (selectedClient) {
          addSystemMessage(
            `📁 Upload context set to "${
              clientSelect.options[clientSelect.selectedIndex].text
            }". New documents will be organized under this project.`
          );
          updateProcessButton();
          // Load existing files for this client
          await loadClientFiles(selectedClient);
        } else {
          // Clear file list if no client selected
          initializeFileList();
        }
        updateChatAvailability();
      });

      // Setup file inputs for each category
      const categories = [
        "drawings",
        "estimates", 
        "proposals",
        "specs",
        "signed-contracts",
      ];

      categories.forEach((category) => {
        const inputId = category + "Files";
        const fileInput = document.getElementById(inputId);

        if (fileInput) {
          fileInput.addEventListener("change", (e) => {
            handleCategoryFiles(e.target.files, category);
          });
        }
      });

      function handleCategoryFiles(files, category) {
        // Auto-check the category checkbox when files are selected
        const checkboxId = category === "signed-contracts" ? "signed-contracts" : category;
        const checkbox = document.getElementById(checkboxId);
        if (checkbox && files.length > 0) {
          checkbox.checked = true;
        }
        
        let addedCount = 0;
        let duplicateCount = 0;
        
        for (let file of files) {
          if (isValidFile(file)) {
            // Check for duplicate files in the same category
            const isDuplicate = uploadedFiles[category].some(
              existingFile => existingFile.name === file.name
            );
            
            if (isDuplicate) {
              duplicateCount++;
              console.log(`Skipping duplicate file: ${file.name} in ${category}`);
            } else {
              const fileWithCategory = new File([file], file.name, {
                type: file.type,
              });
              fileWithCategory.category = category;
              uploadedFiles[category].push(fileWithCategory);
              addedCount++;
            }
          } else {
            showError(
              `Invalid file type: ${file.name}. Please upload PDF, DOCX, or Excel files.`
            );
          }
        }
        
        // Show feedback about added/skipped files
        if (duplicateCount > 0) {
          const message = addedCount > 0 
            ? `Added ${addedCount} new file(s) to ${category}. Skipped ${duplicateCount} duplicate(s).`
            : `All ${duplicateCount} file(s) were duplicates and already queued for upload.`;
          addSystemMessage(`ℹ️ ${message}`);
        }
        
        updateFileCounts();
        renderFileList();
        updateProcessButton();
      }

      function isValidFile(file) {
        const validTypes = [".pdf", ".doc", ".docx", ".xlsx", ".xls"];
        const extension = file.name
          .toLowerCase()
          .substring(file.name.lastIndexOf("."));
        return validTypes.includes(extension);
      }

      function updateFileCounts() {
        document.getElementById(
          "drawingsCount"
        ).textContent = `${uploadedFiles.drawings.length} files`;
        document.getElementById(
          "estimatesCount"
        ).textContent = `${uploadedFiles.estimates.length} files`;
        document.getElementById(
          "proposalsCount"
        ).textContent = `${uploadedFiles.proposals.length} files`;
        document.getElementById(
          "specsCount"
        ).textContent = `${uploadedFiles.specs.length} files`;
        document.getElementById(
          "signed-contractsCount"
        ).textContent = `${uploadedFiles["signed-contracts"].length} files`;
      }

      function renderFileList() {
        fileList.innerHTML = "";

        Object.keys(uploadedFiles).forEach((category) => {
          uploadedFiles[category].forEach((file) => {
            const fileItem = document.createElement("div");
            fileItem.className = "file-item";

            const categoryLabel =
              category.charAt(0).toUpperCase() + category.slice(1);

            fileItem.innerHTML = `
              <span class="file-name" title="${file.name}">${file.name}</span>
              <div class="file-info">
                <span class="file-category">${categoryLabel}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
                <button class="remove-file" onclick="removeFile('${
                  file.name
                }', '${category}')">×</button>
              </div>
            `;
            fileList.appendChild(fileItem);
          });
        });
      }

      function removeFile(fileName, category) {
        uploadedFiles[category] = uploadedFiles[category].filter(
          (file) => file.name !== fileName
        );
        updateFileCounts();
        renderFileList();
        updateProcessButton();
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      function updateProcessButton() {
        const totalFiles = Object.values(uploadedFiles).reduce(
          (sum, files) => sum + files.length,
          0
        );
        const hasClient = selectedClient !== "";
        processButton.disabled = totalFiles === 0 || !hasClient;

        if (totalFiles > 0 && !hasClient) {
          processButton.textContent = "⚠️ Select Client First";
        } else {
          processButton.textContent = "🚧 Process Documents";
        }
      }

      // System status checking (lightweight - no execution tokens)
      let systemStatus = {
        chat: true, // Assume online until proven otherwise
        upload: true,
        clients: true
      };

      // Simple network connectivity check (doesn't trigger n8n executions)
      async function checkSystemStatus() {
        const statusIndicator = document.querySelector('.status-indicator');
        if (!statusIndicator) {
          console.log('Status indicator not found, skipping status check');
          return;
        }
        const statusDot = statusIndicator.querySelector('.status-dot');
        const statusText = statusIndicator.querySelector('span:last-child');
        
        try {
          // Simple network connectivity test to your domain (doesn't hit webhook endpoints)
          const connectivityTest = fetch('https://workflows.saxtechnology.com/', {
            method: 'HEAD',
            mode: 'no-cors', // Avoid CORS issues, just test connectivity
            cache: 'no-cache'
          }).then(() => true).catch(() => false);
          
          const isConnected = await Promise.race([
            connectivityTest,
            new Promise(resolve => setTimeout(() => resolve(false), 3000))
          ]);
          
          if (isConnected) {
            if (statusText) statusText.textContent = 'System Online';
            if (statusDot) {
              statusDot.style.background = 'var(--hi-vis-green)';
              statusDot.style.boxShadow = '0 0 10px var(--hi-vis-green)';
            }
            if (statusIndicator) {
              statusIndicator.style.borderColor = 'var(--hi-vis-green)';
              statusIndicator.style.background = 'rgba(118, 255, 3, 0.1)';
            }
            
            // Assume all services are online if network is reachable
            systemStatus.chat = true;
            systemStatus.clients = true;
            systemStatus.upload = true;
          } else {
            if (statusText) statusText.textContent = 'Network Offline';
            if (statusDot) {
              statusDot.style.background = 'var(--warning-red)';
              statusDot.style.boxShadow = '0 0 10px var(--warning-red)';
            }
            if (statusIndicator) {
              statusIndicator.style.borderColor = 'var(--warning-red)';
              statusIndicator.style.background = 'rgba(211, 47, 47, 0.1)';
            }
            
            systemStatus.chat = false;
            systemStatus.clients = false;
            systemStatus.upload = false;
          }
          
          updateChatAvailability();
          
        } catch (error) {
          console.error('Connectivity check failed:', error);
          statusText.textContent = 'Connection Error';
          statusDot.style.background = 'var(--warning-red)';
          statusDot.style.boxShadow = '0 0 10px var(--warning-red)';
          statusIndicator.style.borderColor = 'var(--warning-red)';
          statusIndicator.style.background = 'rgba(211, 47, 47, 0.1)';
        }
      }

      // Enhanced chat availability function
      function updateChatAvailability() {
        const isSystemOnline = systemStatus.chat;
        
        // Update chat input and button states
        chatInput.disabled = !isSystemOnline;
        sendButton.disabled = !isSystemOnline;
        
        if (!isSystemOnline) {
          chatInput.placeholder = "Network offline - chat unavailable";
          sendButton.style.opacity = '0.5';
        } else {
          // Update placeholder based on current chat context
          if (chatContext === "general") {
            chatInput.placeholder =
              "Ask about construction estimating, specifications, or any project questions...";
          } else {
            const contextName =
              chatClientSelect.options[chatClientSelect.selectedIndex].text;
            chatInput.placeholder = `Ask about ${contextName} project details, specifications, or requirements...`;
          }
          sendButton.style.opacity = '1';
        }
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.add("show");
          setTimeout(() => {
            errorElement.classList.remove("show");
          }, 5000);
        } else {
          // Fallback if errorMessage element doesn't exist
          console.error("Error:", message);
          alert("Error: " + message);
        }
      }

      // Process Documents
      processButton.addEventListener("click", async () => {
        if (!selectedClient) {
          showError(
            "Please select a client project before processing documents."
          );
          return;
        }

        const allFiles = [];
        const selectedCategories = [];

        // Collect all files and active categories
        categories.forEach((category) => {
          const checkboxId = category === "signed-contracts" ? "signed-contracts" : category;
          const checkbox = document.getElementById(checkboxId);

          if (
            checkbox &&
            checkbox.checked &&
            uploadedFiles[category].length > 0
          ) {
            selectedCategories.push(category);
            allFiles.push(...uploadedFiles[category]);
          }
        });

        if (allFiles.length === 0) {
          showError(
            "Please select at least one category with files to process."
          );
          return;
        }

        processButton.disabled = true;
        progressBar.classList.add("active");

        let successCount = 0;
        let errorCount = 0;

        for (let i = 0; i < allFiles.length; i++) {
          const file = allFiles[i];
          const progress = Math.round(((i + 1) / allFiles.length) * 100);
          updateProgress(progress);

          try {
            await processFile(file, file.category);
            successCount++;
          } catch (error) {
            errorCount++;
            console.error(`Error processing ${file.name}:`, error);
          }
        }

        // Update metadata
        processedDocuments += successCount;
        updateMetadata();

        // Reset UI but keep categories selected for continuous upload
        setTimeout(() => {
          progressBar.classList.remove("active");
          
          // Clear only the successfully uploaded files from each category
          // This allows users to continue adding more files without refreshing
          selectedCategories.forEach((category) => {
            // Clear the uploaded files for this category
            uploadedFiles[category] = [];
          });
          
          // Update counts and UI to reflect cleared categories
          updateFileCounts();
          renderFileList();
          
          // Reset file inputs so users can select the same files again if needed
          categories.forEach((category) => {
            const inputId = category + "Files";
            const fileInput = document.getElementById(inputId);
            if (fileInput) {
              fileInput.value = ''; // Clear the input so same files can be selected again
            }
          });
          
          // Keep checkboxes checked so users can continue uploading to same categories
          // Re-enable the process button if there are new files
          updateProcessButton();

          if (errorCount > 0) {
            addSystemMessage(
              `⚠️ Processed ${successCount} documents successfully, ${errorCount} failed. You can continue adding more files to the selected categories or ask questions about uploaded documents.`
            );
          } else {
            addSystemMessage(
              `✅ All ${successCount} documents processed successfully for ${
                clientSelect.options[clientSelect.selectedIndex].text
              }! You can continue adding more files to the selected categories or ask questions about your construction documents.`
            );
          }
          
          // Auto-refresh the file browser to show newly uploaded files
          if (selectedClient && successCount > 0) {
            setTimeout(async () => {
              await loadClientFiles(selectedClient);
              addSystemMessage(`📁 File browser refreshed to show your newly uploaded documents.`);
            }, 2000);
          }
          
          // Show a helpful tip about continuous upload
          setTimeout(() => {
            addSystemMessage(
              `💡 Tip: The selected categories remain active. You can add more files without refreshing the page!`
            );
          }, 4000);
        }, 1000);
      });

      function updateProgress(percent) {
        progressFill.style.width = percent + "%";
        progressFill.textContent = percent + "%";
      }

      async function processFile(file, category) {
        const MAX_WEBHOOK_SIZE = 50 * 1024 * 1024; // 50MB limit for webhook
        
        // Check file size
        if (file.size > MAX_WEBHOOK_SIZE) {
          // Large file - use direct Azure upload + Function App
          console.log(`Large file detected (${formatFileSize(file.size)}), using direct Azure upload...`);
          return processLargeFile(file, category);
        } else {
          // Small file - use existing webhook approach
          console.log(`Standard file size (${formatFileSize(file.size)}), using webhook upload...`);
          return processStandardFile(file, category);
        }
      }
      
      // Process standard files under 50MB via webhook
      async function processStandardFile(file, category) {
        const reader = new FileReader();
        
        return new Promise((resolve, reject) => {
          reader.onload = async () => {
            try {
              // Get base64 string (remove data:type;base64, prefix)
              const base64String = reader.result.split(',')[1];
              
              // Send as JSON with base64-encoded file
              const uploadData = {
                file: base64String,
                fileName: file.name,
                mimeType: file.type || 'application/pdf',
                category: category,
                client: selectedClient || 'general',
                clientName: selectedClient || 'General'
              };
              
              const response = await fetch(API_CONFIG.uploadWebhookUrl, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(uploadData)
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
              }

              const result = await response.json();
              resolve(result);
            } catch (error) {
              console.error("Error processing file:", error);
              reject(error);
            }
          };
          
          reader.onerror = () => {
            reject(new Error(`Failed to read file: ${file.name}`));
          };
          
          // Read file as base64
          reader.readAsDataURL(file);
        });
      }
      
      // Process large files over 50MB via direct Azure upload
      async function processLargeFile(file, category) {
        try {
          const clientName = selectedClient || 'general';
          
          // Step 1: Upload directly to Azure Blob Storage
          const blobPath = `FCS-OriginalClients/${clientName}/${category}/${file.name}`;
          const uploadUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${encodeURIComponent(blobPath)}${AZURE_STORAGE.sasToken}`;
          
          console.log(`Uploading large file directly to Azure: ${blobPath}`);
          addSystemMessage(`📤 Uploading large file "${file.name}" (${formatFileSize(file.size)}) directly to Azure Storage...`);
          
          const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': file.type || 'application/octet-stream',
              'x-ms-blob-content-disposition': `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`,
            },
            body: file
          });
          
          if (!uploadResponse.ok && uploadResponse.status !== 201) {
            throw new Error(`Azure upload failed with status ${uploadResponse.status}`);
          }
          
          console.log('File uploaded to Azure successfully');
          
          // Step 2: Trigger the Azure Function to process the uploaded file
          // The Function App URL should be configured for processing large PDFs
          const functionUrl = 'https://saxtech-functionapps.azurewebsites.net/api/ProcessLargePDF';
          
          const processingData = {
            blobPath: blobPath,
            fileName: file.name,
            fileSize: file.size,
            mimeType: file.type || 'application/pdf',
            category: category,
            client: clientName,
            containerName: AZURE_STORAGE.container,
            storageAccount: AZURE_STORAGE.account
          };
          
          console.log('Triggering Azure Function to process the file...');
          addSystemMessage(`⚙️ Processing "${file.name}" with Azure Function (this may take a few minutes for large files)...`);
          
          const functionResponse = await fetch(functionUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-functions-key': 'KRitpiKC4_teemeHVrLWt8-vJdIvpSkzBFW0co3J4Q3FAzFuYbOMng==' // Master key for SAXTech-FunctionApps
            },
            body: JSON.stringify(processingData)
          });
          
          if (functionResponse.ok) {
            const result = await functionResponse.json();
            console.log('Azure Function processing initiated:', result);
            addSystemMessage(`✅ Large file "${file.name}" uploaded and processing started. The document will be indexed shortly.`);
            return result;
          } else {
            // If Function App is not available, fall back to webhook notification
            console.warn('Azure Function not available, notifying via webhook...');
            
            // Notify the n8n workflow about the uploaded file (without the file content)
            const notifyData = {
              action: 'process-large-file',
              blobPath: blobPath,
              fileName: file.name,
              fileSize: file.size,
              mimeType: file.type || 'application/pdf',
              category: category,
              client: clientName
            };
            
            const notifyResponse = await fetch(API_CONFIG.uploadWebhookUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(notifyData)
            });
            
            if (notifyResponse.ok) {
              addSystemMessage(`✅ Large file "${file.name}" uploaded. Processing will continue in the background.`);
              return await notifyResponse.json();
            } else {
              console.warn('Webhook notification also failed');
              // File is uploaded but not processed - still consider it a partial success
              addSystemMessage(`⚠️ File "${file.name}" uploaded to storage but automatic processing failed. Please trigger reindexing manually.`);
              return { uploaded: true, processed: false, blobPath: blobPath };
            }
          }
          
        } catch (error) {
          console.error('Error processing large file:', error);
          throw error;
        }
      }

      // Chat Functionality
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener("click", sendMessage);

      // Enhanced send message function with system status check
      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        // Check if chat system is online
        if (!systemStatus.chat) {
          addSystemMessage("⚠️ Chat system is currently offline. Please wait for system to come back online.");
          return;
        }

        // Add user message
        addMessage(message, "user");

        // Clear input
        chatInput.value = "";

        // Show typing indicator
        typingIndicator.classList.add("active");
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await fetch(API_CONFIG.chatWebhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              client: chatContext, // Use chat context instead of upload client
              conversationId: `conv_${chatContext}_${Date.now()}`,
              sessionId: chatContext,
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();

          // Hide typing indicator
          typingIndicator.classList.remove("active");

          // Add assistant response with enhanced formatting
          addMessage(
            data.response ||
              "I received your message but couldn't generate a response. Please try again.",
            "assistant"
          );
        } catch (error) {
          typingIndicator.classList.remove("active");
          
          // Check if it's a network error
          if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            systemStatus.chat = false;
            checkSystemStatus(); // Recheck system status
            addMessage(
              "Network connection lost. The system appears to be offline. Please check your connection and try again.",
              "assistant"
            );
          } else {
            addMessage(
              "Sorry, I encountered an error processing your request. Please try again or contact support.",
              "assistant"
            );
          }
          
          console.error("Chat error:", error);
          showError(`Chat error: ${error.message}`);
        }
      }

      function addSystemMessage(content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant";

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
          <div class="message-avatar">⚠️</div>
          <div class="message-content" style="background: linear-gradient(135deg, var(--safety-yellow), #f57f17); color: var(--dark-gray);">
            <div class="formatted-content"><strong>${content}</strong></div>
            <div class="message-time">${time}</div>
          </div>
        `;

        // Safely insert system message
        try {
          if (typingIndicator && typingIndicator.parentNode === chatMessages) {
            chatMessages.insertBefore(messageDiv, typingIndicator);
          } else {
            chatMessages.appendChild(messageDiv);
          }
        } catch (error) {
          console.error("Error inserting system message:", error);
          chatMessages.appendChild(messageDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function updateMetadata() {
        // Removed index statistics update - not needed on estimator page
      }

      // Create Client Modal functionality
      function openCreateClientModal() {
        // Create modal HTML
        const modalHTML = `
          <div id="clientModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 10px;
              width: 90%;
              max-width: 500px;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
              <h2 style="margin-bottom: 1.5rem; color: var(--concrete-gray);">🏗️ Create New Project</h2>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Name *</label>
                <input type="text" id="clientNameInput" placeholder="e.g. ABC Construction" style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                " />
              </div>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Type</label>
                <select id="projectTypeSelect" style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                ">
                  <option value="Commercial">Commercial</option>
                  <option value="Residential">Residential</option>
                  <option value="Industrial">Industrial</option>
                  <option value="Healthcare">Healthcare</option>
                  <option value="Educational">Educational</option>
                  <option value="Government">Government</option>
                  <option value="Infrastructure">Infrastructure</option>
                  <option value="Mixed-Use">Mixed-Use</option>
                </select>
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Description</label>
                <textarea id="projectDescInput" placeholder="Brief description of the project..." style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                  min-height: 80px;
                  resize: vertical;
                "></textarea>
              </div>
              
              <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeClientModal()" style="
                  padding: 0.75rem 1.5rem;
                  border: 2px solid var(--medium-gray);
                  background: white;
                  color: var(--concrete-gray);
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Cancel</button>
                <button onclick="createClient()" style="
                  padding: 0.75rem 1.5rem;
                  border: none;
                  background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
                  color: var(--dark-gray);
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Create Project</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.getElementById('clientNameInput').focus();
      }
      
      function closeClientModal() {
        const modal = document.getElementById('clientModal');
        if (modal) {
          modal.remove();
        }
      }
      
      async function createClient() {
        const clientName = document.getElementById('clientNameInput').value.trim();
        const projectType = document.getElementById('projectTypeSelect').value;
        const projectDescription = document.getElementById('projectDescInput').value.trim();
        
        if (!clientName) {
          alert('Project name is required');
          return;
        }
        
        // Show loading state in the create button
        const createBtn = event.target || document.querySelector('#clientModal button[onclick="createClient()"]');
        if (createBtn) {
          createBtn.disabled = true;
          createBtn.textContent = 'Creating project folders...';
        }
        
        try {
          console.log('Creating client:', { clientName, projectType });
          
          // Step 1: Call the webhook to create the client (this should handle n8n workflow)
          const response = await fetch(API_CONFIG.createClientWebhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              clientName: clientName,
              projectName: clientName, // Use client name as project name for backwards compatibility
              projectType: projectType,
              projectDescription: projectDescription
            }),
          });
          
          console.log('Create client response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Create client error response:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText || 'Server error'}`);
          }
          
          let data;
          try {
            data = await response.json();
            console.log('Create client response data:', data);
          } catch (e) {
            console.warn('Response was not JSON, treating as success');
            data = { client: { id: clientName.replace(/\s+/g, '-') } };  // Keep original capitalization
          }
          
          // Step 2: Create folder structure in both containers
          if (createBtn) {
            createBtn.textContent = 'Setting up folders...';
          }
          
          // Create folders in fcs-clients container (for raw documents)
          const clientFolderName = clientName;
          const categories = ['drawings', 'estimates', 'proposals', 'specs', 'signed-contracts'];
          
          // Create placeholder files in each category folder in FCS-OriginalClients
          for (const category of categories) {
            const placeholderPath = `FCS-OriginalClients/${clientFolderName}/${category}/.placeholder`;
            await createPlaceholderFile(AZURE_STORAGE.container, placeholderPath);
          }
          
          // Create folder structure in FCS-ConvertedClients (for converted data and metadata)
          const convertedCategories = ['converted', 'metadata', 'chunks', 'embeddings', 'index'];
          for (const category of convertedCategories) {
            const placeholderPath = `FCS-ConvertedClients/${clientFolderName}/${category}/.placeholder`;
            await createPlaceholderFile(AZURE_STORAGE.container, placeholderPath);
          }
          
          // Create initial metadata file in FCS-ConvertedClients
          const metadata = {
            clientName: clientName,
            projectType: projectType,
            projectDescription: projectDescription,
            createdAt: new Date().toISOString(),
            documentsCount: 0,
            lastUpdated: new Date().toISOString(),
            categories: categories,
            indexStatus: 'initialized'
          };
          
          await createMetadataFile(AZURE_STORAGE.container, `FCS-ConvertedClients/${clientFolderName}/metadata/client-info.json`, metadata);
          
          // Close modal
          closeClientModal();
          
          // Add success message
          addSystemMessage(`✅ Client "${clientName}" created successfully! Folders have been set up in both storage containers.`);
          
          // Wait a moment for Azure to process, then reload clients
          setTimeout(async () => {
            await loadClients();
            
            // Try to set the new client as selected
            const clientId = data.client?.folderName || data.client?.id || clientName;
            
            // Check if the client appears in the dropdown
            const options = Array.from(clientSelect.options);
            const clientOption = options.find(opt => 
              opt.value === clientId || 
              opt.value === clientName ||
              opt.value.toLowerCase() === clientId.toLowerCase()
            );
            
            if (clientOption) {
              clientSelect.value = clientOption.value;
              selectedClient = clientOption.value;
              addSystemMessage(`✅ Client "${clientName}" is now selected and ready for document uploads.`);
              
              // Auto-refresh the file browser to show the new client's folder structure
              await loadClientFiles(clientOption.value);
              addSystemMessage(`📁 File browser refreshed for "${clientName}".`);
            } else {
              console.log('Client not found in dropdown yet, it may take a moment to appear');
              addSystemMessage(`⚠️ Client "${clientName}" was created but may take a moment to appear in the list. Please refresh the page if it doesn't appear shortly.`);
            }
            
            updateProcessButton();
          }, 3000); // Wait 3 seconds for Azure to create the folders
          
        } catch (error) {
          console.error('Create client error:', error);
          alert(`Error creating client: ${error.message}`);
          
          // Re-enable the create button
          if (createBtn) {
            createBtn.disabled = false;
            createBtn.textContent = 'Create Client';
          }
        }
      }
      
      // Helper function to create placeholder files in Azure Blob Storage
      async function createPlaceholderFile(containerName, path) {
        try {
          // Encode path segments properly
          const pathSegments = path.split('/');
          const encodedPath = pathSegments.map(segment => encodeURIComponent(segment)).join('/');
          
          const placeholderUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${containerName}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          const response = await fetch(placeholderUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': 'text/plain',
              'Content-Length': '0'
            },
            body: '' // Empty placeholder file
          });
          
          if (!response.ok && response.status !== 201) {
            console.warn(`Failed to create placeholder at ${path}: ${response.status}`);
          } else {
            console.log(`Created placeholder: ${containerName}/${path}`);
          }
        } catch (error) {
          console.error(`Error creating placeholder file: ${error.message}`);
        }
      }
      
      // Helper function to create metadata JSON file in Azure Blob Storage
      async function createMetadataFile(containerName, path, metadata) {
        try {
          // Encode path segments properly
          const pathSegments = path.split('/');
          const encodedPath = pathSegments.map(segment => encodeURIComponent(segment)).join('/');
          
          const metadataUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${containerName}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          const metadataContent = JSON.stringify(metadata, null, 2);
          
          const response = await fetch(metadataUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': 'application/json',
              'Content-Length': new Blob([metadataContent]).size.toString()
            },
            body: metadataContent
          });
          
          if (!response.ok && response.status !== 201) {
            console.warn(`Failed to create metadata at ${path}: ${response.status}`);
          } else {
            console.log(`Created metadata: ${containerName}/${path}`);
          }
        } catch (error) {
          console.error(`Error creating metadata file: ${error.message}`);
        }
      }
      
      async function loadClients() {
        try {
          // Show loading state in dropdowns
          clientSelect.innerHTML = '<option value="">Loading clients...</option>';
          
          const clients = [];
          const clientSet = new Set(); // To avoid duplicates
          
          // First, check if there's an FCS-OriginalClients folder
          const topLevelUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&delimiter=/`;
          
          let response = await fetch(topLevelUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/xml'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          let xmlText = await response.text();
          console.log('Top-level Azure Blob Response:', xmlText); // Debug log
          
          // Parse the XML response
          const parser = new DOMParser();
          let xmlDoc = parser.parseFromString(xmlText, "text/xml");
          
          // Check if FCS-OriginalClients folder exists
          const topLevelPrefixes = xmlDoc.getElementsByTagName("BlobPrefix");
          let hasFCSFolder = false;
          
          for (let i = 0; i < topLevelPrefixes.length; i++) {
            const nameElement = topLevelPrefixes[i].getElementsByTagName("Name")[0];
            if (nameElement && nameElement.textContent === 'FCS-OriginalClients/') {
              hasFCSFolder = true;
              break;
            }
          }
          
          // If FCS-OriginalClients exists, list its contents
          if (hasFCSFolder) {
            const fcsUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
            
            response = await fetch(fcsUrl, {
              method: 'GET',
              headers: {
                'Accept': 'application/xml'
              }
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            xmlText = await response.text();
            console.log('FCS-OriginalClients contents:', xmlText); // Debug log
            
            // Parse the FCS folder contents
            xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const fcsPrefixes = xmlDoc.getElementsByTagName("BlobPrefix");
            
            for (let i = 0; i < fcsPrefixes.length; i++) {
              const nameElement = fcsPrefixes[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const fullPath = nameElement.textContent.replace(/\/$/, ''); // Remove trailing slash
                const pathParts = fullPath.split('/');
                
                // Get the client name (should be the second part after FCS-OriginalClients)
                if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                  const clientName = pathParts[1];
                  
                  // Skip if already added or if it's a system folder
                  if (!clientSet.has(clientName) && !clientName.startsWith('.') && clientName.length > 0) {
                    clientSet.add(clientName);
                    clients.push({
                      id: clientName,  // Keep original capitalization for folder name
                      name: formatClientName(clientName)
                    });
                  }
                }
              }
            }
          } else {
            // If no FCS-OriginalClients folder, check top-level folders
            for (let i = 0; i < topLevelPrefixes.length; i++) {
              const nameElement = topLevelPrefixes[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const folderName = nameElement.textContent.replace(/\/$/, ''); // Remove trailing slash
                
                // Skip system folders or hidden folders
                if (!folderName.startsWith('.') && folderName.length > 0 && folderName !== 'FCS-OriginalClients') {
                  clients.push({
                    id: folderName,  // Keep original capitalization for folder name
                    name: formatClientName(folderName)
                  });
                }
              }
            }
          }
          
          // If no blob prefixes found, try getting individual blobs and extract unique folder names
          if (clients.length === 0) {
            const blobs = xmlDoc.getElementsByTagName("Blob");
            const uniqueClients = new Set();
            
            for (let i = 0; i < blobs.length; i++) {
              const nameElement = blobs[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const fullPath = nameElement.textContent;
                const pathParts = fullPath.split('/');
                
                // Check if this is under FCS-OriginalClients folder
                if (pathParts[0] === 'FCS-OriginalClients' && pathParts.length >= 2) {
                  const clientName = pathParts[1]; // Get the client name (second part)
                  
                  if (clientName && !clientName.startsWith('.')) {
                    uniqueClients.add(clientName);
                  }
                }
              }
            }
            
            uniqueClients.forEach(clientName => {
              clients.push({
                id: clientName,  // Keep original capitalization for folder name
                name: formatClientName(clientName)
              });
            });
          }
          
          // Sort clients alphabetically
          clients.sort((a, b) => a.name.localeCompare(b.name));
          
          // Update the dropdowns with Azure Storage clients
          updateClientDropdowns(clients);
          
          console.log(`Loaded ${clients.length} clients from Azure Blob Storage`);
          
          // Store clients for later use
          window.availableClients = clients;
          
          // Count total documents across all clients (async operation)
          countAllDocuments().then(count => {
            totalDocumentCount = count;
            console.log(`Total documents across all clients: ${totalDocumentCount}`);
          }).catch(err => {
            console.warn('Could not count documents:', err);
          });
          
        } catch (error) {
          console.error('Error loading clients from Azure:', error);
          
          // Show error state
          clientSelect.innerHTML = '<option value="">-- Error loading clients --</option>';
          
          // Add a retry option
          const retryOption = document.createElement('option');
          retryOption.value = 'retry';
          retryOption.textContent = 'Click to retry...';
          clientSelect.appendChild(retryOption);
          
          // Show error message to user
          showError(`Failed to load clients from Azure Storage: ${error.message}`);
        }
      }
      
      // Format client name for display
      function formatClientName(name) {
        // Handle different naming conventions
        // Example: "Baruch" stays "Baruch", "smith" becomes "Smith"
        return name
          .split(/[-_]/) // Split by dash or underscore
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
      }
      
      // Count all documents across all clients
      async function countAllDocuments() {
        let totalCount = 0;
        
        try {
          // If we have clients loaded, count documents for each
          if (window.availableClients && window.availableClients.length > 0) {
            // For performance, we'll estimate based on a sample or use a lighter query
            // In production, this could be optimized with a server-side count endpoint
            
            for (const client of window.availableClients) {
              try {
                const prefix = `FCS-OriginalClients/${client.id}/`;
                const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}&maxresults=1000`;
                
                const response = await fetch(listUrl, {
                  method: 'GET',
                  headers: {
                    'Accept': 'application/xml'
                  }
                });
                
                if (response.ok) {
                  const xmlText = await response.text();
                  const parser = new DOMParser();
                  const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                  const blobs = xmlDoc.getElementsByTagName("Blob");
                  
                  // Count actual files (not placeholders)
                  for (let i = 0; i < blobs.length; i++) {
                    const nameElement = blobs[i].getElementsByTagName("Name")[0];
                    if (nameElement) {
                      const fullPath = nameElement.textContent;
                      const fileName = fullPath.split('/').pop();
                      // Skip placeholder files and empty names
                      if (fileName && fileName.length > 0 && !fileName.startsWith('.')) {
                        totalCount++;
                      }
                    }
                  }
                }
              } catch (err) {
                console.warn(`Could not count documents for client ${client.id}:`, err);
              }
            }
          }
        } catch (error) {
          console.error('Error counting all documents:', error);
        }
        
        return totalCount;
      }
      
      function updateClientDropdowns(clients) {
        // Update upload client dropdown
        const currentUploadValue = clientSelect.value;
        clientSelect.innerHTML = '<option value="">-- Choose a Client --</option>';
        
        // Update chat client dropdown  
        const currentChatValue = chatClientSelect.value;
        chatClientSelect.innerHTML = '';
        
        // Add General option
        const generalOption = document.createElement('option');
        generalOption.value = 'general';
        generalOption.textContent = 'General Construction Knowledge';
        chatClientSelect.appendChild(generalOption);
        
        // Add All Clients option for knowledge graph
        const allClientsOption = document.createElement('option');
        allClientsOption.value = 'combined-projects';
        allClientsOption.textContent = '🌐 Combined Projects';
        allClientsOption.style.fontWeight = '600';
        allClientsOption.style.color = 'var(--blueprint-blue)';
        chatClientSelect.appendChild(allClientsOption);
        
        // Add separator
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = '──────────────';
        chatClientSelect.appendChild(separator);
        
        clients.forEach(client => {
          // Upload dropdown
          const uploadOption = document.createElement('option');
          uploadOption.value = client.id;
          uploadOption.textContent = client.name;
          clientSelect.appendChild(uploadOption);
          
          // Chat dropdown
          const chatOption = document.createElement('option');
          chatOption.value = client.id;
          chatOption.textContent = client.name;
          chatClientSelect.appendChild(chatOption);
        });
        
        // Restore previous selections if they still exist
        if (currentUploadValue && clientSelect.querySelector(`option[value="${currentUploadValue}"]`)) {
          clientSelect.value = currentUploadValue;
        }
        if (currentChatValue && chatClientSelect.querySelector(`option[value="${currentChatValue}"]`)) {
          chatClientSelect.value = currentChatValue;
        }
      }

      // Removed updateSearchStatistics function - not needed on estimator page
      
      // Update detailed status indicators
      function updateDetailedStatus() {
        const chatStatusEl = document.getElementById('chatStatus');
        const searchStatusEl = document.getElementById('searchStatus');
        const uploadStatusEl = document.getElementById('uploadStatus');
        const lastCheckEl = document.getElementById('lastStatusCheck');
        
        // Update service status indicators
        if (systemStatus.chat) {
          chatStatusEl.innerHTML = '🟢 Online';
          chatStatusEl.style.color = '#4caf50';
        } else {
          chatStatusEl.innerHTML = '🔴 Offline';
          chatStatusEl.style.color = '#f44336';
        }
        
        if (systemStatus.clients) {
          searchStatusEl.innerHTML = '🟢 Online';
          searchStatusEl.style.color = '#4caf50';
        } else {
          searchStatusEl.innerHTML = '🔴 Offline';
          searchStatusEl.style.color = '#f44336';
        }
        
        if (systemStatus.upload) {
          uploadStatusEl.innerHTML = '🟢 Online';
          uploadStatusEl.style.color = '#4caf50';
        } else {
          uploadStatusEl.innerHTML = '🔴 Offline';
          uploadStatusEl.style.color = '#f44336';
        }
        
        // Update last check time
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        lastCheckEl.textContent = timeString;
      }

      // Initialize system with lightweight status check
      window.addEventListener("load", async () => {
        try {
          // Initialize View Capabilities button
          const capabilitiesBtn = document.querySelector('.capabilities-btn');
          const capabilitiesDropdown = document.querySelector('.capabilities-dropdown');
          
          if (capabilitiesBtn && capabilitiesDropdown) {
            // Handle click to toggle dropdown
            capabilitiesBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const isVisible = capabilitiesDropdown.style.display === 'block';
              capabilitiesDropdown.style.display = isVisible ? 'none' : 'block';
            });
            
            // Make the button look more clickable
            capabilitiesBtn.style.cursor = 'pointer';
            
            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
              if (capabilitiesDropdown) {
                capabilitiesDropdown.style.display = 'none';
              }
            });
            
            // Prevent dropdown from closing when clicking inside it
            capabilitiesDropdown.addEventListener('click', (e) => {
              e.stopPropagation();
            });
          }
          
          // Lightweight connectivity check (no n8n executions)
          await checkSystemStatus();
          
          updateFileCounts();
          updateMetadata();
          if (document.getElementById('chatStatus')) { updateDetailedStatus(); }

          // Initialize file list with default message
          initializeFileList();
          
          // Load existing clients (only if system is online)
          if (systemStatus.clients) {
            await loadClients();
          }
          
          // Set up periodic connectivity checks (every 5 minutes - much less frequent)
          setInterval(async () => {
            await checkSystemStatus();
            updateDetailedStatus();
          }, 300000);
          
          // Removed periodic search statistics update - not needed on estimator page
          
        } catch (error) {
          console.error("Initialization error:", error);
        }
      });

      function initializeFileList() {
        const fileList = document.getElementById("fileList");
        const loadingIndicator = document.getElementById(
          "filesLoadingIndicator"
        );

        if (fileList && loadingIndicator) {
          fileList.innerHTML = "";
          fileList.appendChild(loadingIndicator);

          const noClientMessage = document.createElement("div");
          noClientMessage.className = "no-files-message";
          noClientMessage.innerHTML =
            "📁 Select a client project above to view existing files and upload new documents.";
          fileList.appendChild(noClientMessage);
        }
      }
      
      // File browser state
      let currentPath = [];
      let fileStructure = {};
      let selectedFiles = new Set();
      
      // Build hierarchical file structure from flat file list
      function buildFileStructure(files) {
        const structure = {};
        
        files.forEach(file => {
          const pathParts = file.fullPath.split('/');
          // Remove the client prefix parts (FCS-OriginalClients/ClientName/)
          const relevantParts = pathParts.slice(2);
          
          let current = structure;
          
          relevantParts.forEach((part, index) => {
            if (index === relevantParts.length - 1) {
              // It's a file
              if (!current._files) current._files = [];
              current._files.push({
                ...file,
                name: part
              });
            } else {
              // It's a folder
              if (!current[part]) {
                current[part] = {};
              }
              current = current[part];
            }
          });
        });
        
        return structure;
      }
      
      // Get current folder content based on path
      function getCurrentFolder() {
        let current = fileStructure;
        currentPath.forEach(folder => {
          current = current[folder];
        });
        return current;
      }
      
      // Navigate to a folder
      function navigateToFolder(folderName) {
        currentPath.push(folderName);
        renderFileBrowser();
      }
      
      // Navigate back
      function navigateBack() {
        if (currentPath.length > 0) {
          currentPath.pop();
          renderFileBrowser();
        }
      }
      
      // Navigate to specific path level
      function navigateToPath(pathIndex) {
        currentPath = currentPath.slice(0, pathIndex);
        renderFileBrowser();
      }
      
      // Handle file/folder click
      function handleItemClick(event, itemName, isFolder) {
        const item = event.currentTarget;
        
        if (event.detail === 2) {
          // Double click
          if (isFolder) {
            navigateToFolder(itemName);
          } else {
            // Open file
            openFile(itemName);
          }
        } else {
          // Single click - selection
          if (event.ctrlKey || event.metaKey) {
            // Multi-select
            item.classList.toggle('selected');
            if (item.classList.contains('selected')) {
              selectedFiles.add(itemName);
            } else {
              selectedFiles.delete(itemName);
            }
          } else {
            // Single select
            document.querySelectorAll('.existing-file-item, .folder-item').forEach(el => {
              el.classList.remove('selected');
            });
            selectedFiles.clear();
            item.classList.add('selected');
            selectedFiles.add(itemName);
          }
        }
      }
      
      // Right-click context menu
      function showContextMenu(event, itemName, isFolder) {
        event.preventDefault();
        
        // Remove existing context menu if any
        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) existingMenu.remove();
        
        const menu = document.createElement('div');
        menu.className = 'context-menu show';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        if (isFolder) {
          menu.innerHTML = `
            <div class="context-menu-item" onclick="navigateToFolder('${itemName}'); closeContextMenu();">📂 Open</div>
            <div class="context-menu-item" onclick="openInNewTab('${itemName}', true); closeContextMenu();">🗂️ Open in new tab</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="renameItem('${itemName}', true); closeContextMenu();">✏️ Rename</div>
            <div class="context-menu-item" onclick="deleteFolder('${itemName}'); closeContextMenu();">🗑️ Delete</div>
          `;
        } else {
          const currentFolder = getCurrentFolder();
          const file = currentFolder._files.find(f => f.name === itemName);
          
          menu.innerHTML = `
            <div class="context-menu-item" onclick="openFile('${itemName}'); closeContextMenu();">📄 Open</div>
            <div class="context-menu-item" onclick="window.open('${file.blobUrl}', '_blank'); closeContextMenu();"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" style="vertical-align: -2px; margin-right: 4px;"><path d="M8 11l-4-4h2.5V2h3v5H12l-4 4z"/><path d="M13 13H3v1h10v-1z"/></svg> Download</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="editFile('${itemName}'); closeContextMenu();">✏️ Edit</div>
            <div class="context-menu-item" onclick="renameItem('${itemName}', false); closeContextMenu();">📝 Rename</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="deleteFile('${file.fullPath}'); closeContextMenu();">🗑️ Delete</div>
            <div class="context-menu-item" onclick="reindexFile('${file.fullPath}'); closeContextMenu();">🔄 Reindex</div>
          `;
        }
        
        document.body.appendChild(menu);
        
        // Close menu when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeContextMenu);
        }, 100);
      }
      
      function closeContextMenu() {
        const menu = document.querySelector('.context-menu');
        if (menu) menu.remove();
        document.removeEventListener('click', closeContextMenu);
      }
      
      // Open file handler
      async function openFile(fileName) {
        const currentFolder = getCurrentFolder();
        const file = currentFolder._files.find(f => f.name === fileName);
        
        if (!file) return;
        
        // Get file icon based on extension
        const ext = fileName.split('.').pop().toLowerCase();
        let fileIcon = getFileIcon(ext);
        
        // Format file information
        const fileSize = formatFileSize(file.size);
        const lastModified = file.lastModified ? new Date(file.lastModified).toLocaleString() : 'Unknown';
        
        // Show dialog for open options
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          padding: 0;
          border-radius: 10px;
          max-width: 600px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          position: relative;
        `;
        
        modalContent.innerHTML = `
          <!-- Header with file info and close button -->
          <div style="
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
          ">
            <!-- Close X button -->
            <button id="modalCloseBtn" style="
              position: absolute;
              top: 1rem;
              right: 1rem;
              background: transparent;
              border: none;
              font-size: 1.5rem;
              cursor: pointer;
              color: #666;
              width: 32px;
              height: 32px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 4px;
              transition: all 0.2s;
            ">
              <span style="line-height: 1;">×</span>
            </button>
            
            <!-- File icon and name -->
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding-right: 3rem;">
              <div style="width: 32px; height: 32px; flex-shrink: 0;">
                ${fileIcon}
              </div>
              <h3 style="
                margin: 0;
                font-size: 1.1rem;
                word-break: break-word;
                line-height: 1.4;
                color: #333;
              ">${fileName}</h3>
            </div>
            
            <!-- File metadata -->
            <div style="
              display: flex;
              gap: 2rem;
              font-size: 0.85rem;
              color: #666;
              padding-left: 3rem;
            ">
              <div>
                <strong>Size:</strong> ${fileSize}
              </div>
              <div>
                <strong>Modified:</strong> ${lastModified}
              </div>
            </div>
          </div>
          
          <!-- Body with actions -->
          <div style="padding: 1.5rem 2rem;">
            <p style="margin-bottom: 1.5rem; color: #666;">Choose an action:</p>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <!-- Download and Edit Option -->
              <div style="
                padding: 1rem;
                background: #f0f8ff;
                border: 1px solid #0078d4;
                border-radius: 8px;
              ">
                <h4 style="margin: 0 0 0.5rem 0; color: #0078d4;">✏️ Edit in Native Application</h4>
                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                  Download the file, edit it in Word/Excel/etc., then upload the updated version
                </p>
                <button id="downloadEditBtn" style="
                  padding: 0.75rem 1.5rem;
                  background: var(--blueprint-blue);
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  width: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 0.5rem;
                "><svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"><path d="M10 14l-5-5h3V3h4v6h3l-5 5z"/><path d="M16 16H4v2h12v-2z"/></svg> Download for Editing</button>
              </div>
              
              <!-- View Only Options -->
              <div style="
                padding: 1rem;
                background: #fffef5;
                border: 1px solid #ffc107;
                border-radius: 8px;
              ">
                <h4 style="margin: 0 0 0.5rem 0; color: #f57f17;">👁️ View Only</h4>
                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                  Open the file directly in your browser for viewing
                </p>
                <button id="viewBrowserBtn" style="
                  padding: 0.75rem 1rem;
                  background: white;
                  color: #333;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  cursor: pointer;
                  width: 100%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 0.5rem;
                ">🌐 View in Browser</button>
              </div>
            </div>
            
            <button id="modalCancelBtn" style="
              margin-top: 1rem;
              padding: 0.75rem 1.5rem;
              background: #f0f0f0;
              color: #666;
              border: 1px solid #ccc;
              border-radius: 5px;
              cursor: pointer;
              width: 100%;
            ">Cancel</button>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Add event listeners after the modal is in the DOM
        const closeModal = () => modal.remove();
        
        // Close button
        modalContent.querySelector('#modalCloseBtn').addEventListener('click', closeModal);
        
        // Cancel button
        modalContent.querySelector('#modalCancelBtn').addEventListener('click', closeModal);
        
        // Download for editing button
        modalContent.querySelector('#downloadEditBtn').addEventListener('click', () => {
          downloadAndTrackForEdit(file.blobUrl, fileName, file.fullPath);
          closeModal();
        });
        
        // View in browser button
        modalContent.querySelector('#viewBrowserBtn').addEventListener('click', () => {
          openInBrowser(file.blobUrl);
          closeModal();
        });
      }
      
      // Helper function to get file icon SVG
      function getFileIcon(ext) {
        // PDF files
        if (ext === 'pdf') {
          return `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <rect width="32" height="32" rx="2" fill="#DC372C"/>
            <path fill="white" d="M8.5 10.5h2.8c1.7 0 2.7 1 2.7 2.5s-1 2.5-2.7 2.5h-1.6v2.5H8.5v-7.5zm1.2 1v3h1.6c1 0 1.5-.6 1.5-1.5s-.5-1.5-1.5-1.5H9.7z"/>
            <path fill="white" d="M14.5 10.5h2.3c2.2 0 3.5 1.3 3.5 3.7s-1.3 3.8-3.5 3.8h-2.3v-7.5zm1.2 1v5.5h1.1c1.5 0 2.3-.9 2.3-2.8 0-1.8-.8-2.7-2.3-2.7h-1.1z"/>
            <path fill="white" d="M21 10.5h4.5v1H22.2v2.5h2.8v1h-2.8v3H21v-7.5z"/>
          </svg>`;
        }
        // Word documents
        else if (ext === 'docx' || ext === 'doc') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#2B579A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M9.5 11.5h1l.9 4.2h.05l1.05-4.2h1.5l1.05 4.2h.05l.9-4.2h1l-1.45 6h-1.55l-1-3.85h-.05l-1 3.85H10.95z"/>
          </svg>`;
        }
        // Excel spreadsheets
        else if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#107C41" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M8.5 11.5h1.5l1.5 3 1.5-3h1.5l-2.25 4.5 2.25 4.5h-1.5L12 17.5l-1.5 3H9l2.25-4.5z"/>
          </svg>`;
        }
        // PowerPoint
        else if (ext === 'pptx' || ext === 'ppt') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#B7472A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M9 11.5h3.5c1.93 0 3 1.07 3 2.75s-1.07 2.75-3 2.75H10.5v3.5H9v-9zm1.5 1.25v3h2c.83 0 1.5-.42 1.5-1.5s-.67-1.5-1.5-1.5h-2z"/>
          </svg>`;
        }
        // CAD/Drawing files
        else if (ext === 'dwg' || ext === 'dxf' || ext === 'rvt') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <rect fill="#E51937" width="24" height="24" rx="2"/>
            <text x="12" y="15" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">DWG</text>
          </svg>`;
        }
        // Images
        else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'].includes(ext)) {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <rect fill="#4285F4" width="24" height="24" rx="2"/>
            <circle cx="8" cy="8" r="2" fill="#FFF"/>
            <path fill="#FFF" d="M4 18h16l-5-6-4 4.5-2.5-3z"/>
          </svg>`;
        }
        // Default document icon
        else {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="32" height="32">
            <path fill="#757575" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
            <path fill="#FFF" d="M7 11h10v1H7zm0 2h10v1H7zm0 2h7v1H7z"/>
          </svg>`;
        }
      }
      
      // Track file for editing and show upload prompt
      function downloadAndTrackForEdit(blobUrl, fileName, fullPath) {
        // Download the file
        window.open(blobUrl, '_blank');
        
        // Store the file info for tracking
        const editSession = {
          fileName: fileName,
          fullPath: fullPath,
          downloadTime: new Date().toISOString(),
          clientName: selectedClient
        };
        
        // Store in sessionStorage so it persists during the session
        sessionStorage.setItem('editingFile', JSON.stringify(editSession));
        
        // Show notification with upload instructions
        setTimeout(() => {
          showEditNotification(fileName, fullPath);
        }, 1000);
      }
      
      // Show notification for file being edited
      function showEditNotification(fileName, fullPath) {
        // Remove any existing edit notification
        const existingNotification = document.getElementById('editNotification');
        if (existingNotification) existingNotification.remove();
        
        const notification = document.createElement('div');
        notification.id = 'editNotification';
        notification.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: white;
          border: 2px solid var(--blueprint-blue);
          border-radius: 8px;
          padding: 1rem;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 9999;
          max-width: 400px;
          animation: slideIn 0.3s ease-out;
        `;
        
        // Truncate long filenames for display
        const displayName = fileName.length > 40 ? fileName.substring(0, 37) + '...' : fileName;
        
        notification.innerHTML = `
          <div style="display: flex; align-items: start; gap: 1rem;">
            <div style="font-size: 2rem;">📝</div>
            <div style="flex: 1;">
              <h4 style="margin: 0 0 0.5rem 0; color: var(--concrete-gray); word-break: break-word;" title="${fileName}">Editing: ${displayName}</h4>
              <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                After editing in your application, click below to upload the updated version.
              </p>
              <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="showUploadDialog('${fileName.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '${fullPath.replace(/'/g, "\\'").replace(/"/g, "&quot;")}')" style="
                  padding: 0.5rem 1rem;
                  background: var(--blueprint-blue);
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  font-size: 0.9rem;
                  white-space: nowrap;
                ">📤 Upload Updated</button>
                <button onclick="confirmDismissEdit()" style="
                  padding: 0.5rem 1rem;
                  background: #f0f0f0;
                  color: #666;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  cursor: pointer;
                  font-size: 0.9rem;
                ">Dismiss</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(notification);
      }
      
      // Helper function to show errors in modal
      function showModalError(modal, message) {
        // Remove any existing error message
        const existingError = modal.querySelector('.modal-error-message');
        if (existingError) {
          existingError.remove();
        }
        
        // Create error message element
        const errorDiv = document.createElement('div');
        errorDiv.className = 'modal-error-message';
        errorDiv.style.cssText = `
          background: #fee;
          border: 1px solid #fcc;
          border-radius: 5px;
          padding: 0.75rem;
          margin: 1rem 0;
          color: #c00;
          font-size: 0.9rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        `;
        errorDiv.innerHTML = `
          <span style="font-size: 1.2rem;">⚠️</span>
          <span>${message}</span>
        `;
        
        // Insert error after the title
        const modalContent = modal.querySelector('div[style*="background: white"]');
        if (modalContent) {
          const title = modalContent.querySelector('h3');
          if (title) {
            title.insertAdjacentElement('afterend', errorDiv);
          } else {
            modalContent.insertBefore(errorDiv, modalContent.firstChild);
          }
        }
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.remove();
          }
        }, 5000);
      }
      
      // Show upload dialog for edited file - make it global
      window.showUploadDialog = function(originalFileName, originalPath) {
        const modal = document.createElement('div');
        modal.id = 'uploadEditModal';
        
        // Truncate long filenames for display
        const displayName = originalFileName.length > 50 ? originalFileName.substring(0, 47) + '...' : originalFileName;
        
        modal.innerHTML = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow-y: auto;
            padding: 1rem;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 10px;
              max-width: 500px;
              width: 100%;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
              max-height: 90vh;
              overflow-y: auto;
              position: relative;
            ">
              <h3 style="margin-bottom: 1rem; color: var(--concrete-gray);">📤 Upload Updated File</h3>
              <p style="margin-bottom: 1rem; color: #666; word-break: break-word;">
                Select the edited version of <strong title="${originalFileName}">${displayName}</strong> to replace the existing file.
              </p>
              
              <div style="
                border: 2px dashed var(--blueprint-blue);
                border-radius: 8px;
                padding: 2rem;
                text-align: center;
                background: #f8f9fa;
                margin-bottom: 1rem;
              ">
                <input type="file" id="editedFileInput" style="display: none;" accept=".pdf,.doc,.docx,.xlsx,.xls" />
                <div id="fileSelectionArea">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">📁</div>
                  <button onclick="document.getElementById('editedFileInput').click()" style="
                    padding: 0.75rem 1.5rem;
                    background: var(--blueprint-blue);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                  ">Choose File</button>
                  <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">or drag and drop here</p>
                </div>
                <div id="selectedFileInfo" style="display: none;">
                  <div style="font-size: 2rem; margin-bottom: 0.5rem;">✅</div>
                  <p style="color: var(--blueprint-blue); font-weight: 600; word-break: break-all; padding: 0 1rem;" id="selectedFileName"></p>
                  <p style="color: #666; font-size: 0.9rem;" id="selectedFileSize"></p>
                </div>
              </div>
              
              <div style="
                background: #fff3cd;
                border: 1px solid #ffc107;
                border-radius: 5px;
                padding: 0.75rem;
                margin-bottom: 1rem;
                display: flex;
                align-items: start;
                gap: 0.5rem;
              ">
                <span style="color: #f57f17;">⚠️</span>
                <div style="font-size: 0.9rem; color: #856404;">
                  <strong>Note:</strong> The original file will be replaced. The indexer will automatically update to reflect your changes.
                </div>
              </div>
              
              <div style="display: flex; gap: 1rem;">
                <button id="uploadEditedFileBtn" onclick="uploadEditedFile('${originalPath}')" disabled style="
                  flex: 1;
                  padding: 0.75rem 1.5rem;
                  background: var(--safety-yellow);
                  color: var(--dark-gray);
                  border: none;
                  border-radius: 5px;
                  cursor: not-allowed;
                  font-weight: 600;
                  opacity: 0.5;
                ">Upload & Replace</button>
                <button onclick="confirmCancelUpload()" style="
                  padding: 0.75rem 1.5rem;
                  background: #f0f0f0;
                  color: #666;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  cursor: pointer;
                ">Cancel</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Set up file input handler
        const fileInput = document.getElementById('editedFileInput');
        const uploadBtn = document.getElementById('uploadEditedFileBtn');
        const fileSelectionArea = document.getElementById('fileSelectionArea');
        const selectedFileInfo = document.getElementById('selectedFileInfo');
        
        fileInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            // Show selected file info
            fileSelectionArea.style.display = 'none';
            selectedFileInfo.style.display = 'block';
            
            // Truncate very long filenames for display but show full name on hover
            const fileName = file.name;
            const displayName = fileName.length > 60 ? fileName.substring(0, 30) + '...' + fileName.substring(fileName.length - 27) : fileName;
            const fileNameElement = document.getElementById('selectedFileName');
            fileNameElement.textContent = displayName;
            fileNameElement.title = fileName; // Show full name on hover
            
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
            
            // Enable upload button
            uploadBtn.disabled = false;
            uploadBtn.style.cursor = 'pointer';
            uploadBtn.style.opacity = '1';
            
            // Store the file for upload
            window.tempEditedFile = file;
          }
        });
        
        // Set up drag and drop
        const dropZone = fileInput.parentElement;
        
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.style.background = '#e8f4fd';
        });
        
        dropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          dropZone.style.background = '#f8f9fa';
        });
        
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.style.background = '#f8f9fa';
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            fileInput.files = files;
            const event = new Event('change', { bubbles: true });
            fileInput.dispatchEvent(event);
          }
        });
      }
      
      // Confirmation dialogs for dismissing edit notifications - make them global
      window.confirmDismissEdit = function() {
        if (confirm('Are you sure you want to dismiss? The AI model will not learn from any of your changes unless you upload the updated file.')) {
          const notification = document.getElementById('editNotification');
          if (notification) notification.remove();
          sessionStorage.removeItem('editingFile');
        }
      }
      
      window.confirmCancelUpload = function() {
        if (confirm('Are you sure you want to cancel? The AI model will not learn from any of your changes unless you upload the updated file.')) {
          const modal = document.getElementById('uploadEditModal');
          if (modal) modal.remove();
        }
      }
      
      // Upload the edited file to replace the original - make it global
      window.uploadEditedFile = async function(originalPath) {
        const file = window.tempEditedFile;
        if (!file) {
          // Show error in modal
          const modal = document.getElementById('uploadEditModal');
          if (modal) {
            showModalError(modal, 'No file selected. Please choose a file to upload.');
          }
          return;
        }
        
        const uploadBtn = document.getElementById('uploadEditedFileBtn');
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        
        try {
          // Parse the original path to properly handle encoding
          // The originalPath already contains the full path like "FCS-OriginalClients/clientname/category/filename"
          // We need to encode each segment properly while preserving the structure
          
          // First, normalize the path (remove any double slashes, trim)
          let normalizedPath = originalPath.replace(/\/+/g, '/').trim();
          
          // Encode each path segment separately
          const pathSegments = normalizedPath.split('/');
          const encodedSegments = pathSegments.map(segment => {
            // Skip empty segments
            if (!segment) return '';
            // Encode the segment, which will handle spaces and special characters
            return encodeURIComponent(segment);
          }).filter(s => s); // Remove empty segments
          
          const encodedPath = encodedSegments.join('/');
          
          // Construct the upload URL with the SAS token
          const uploadUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${encodedPath}${AZURE_STORAGE.sasToken}`;
          
          console.log('Original path:', originalPath);
          console.log('Encoded path:', encodedPath);
          console.log('Full upload URL:', uploadUrl); // Debug log
          
          const response = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
              'x-ms-blob-type': 'BlockBlob',
              'Content-Type': file.type || 'application/octet-stream',
              'x-ms-blob-content-disposition': `attachment; filename*=UTF-8''${encodeURIComponent(file.name)}`,
              'x-ms-blob-overwrite': 'true', // Explicitly overwrite the existing blob
              'x-ms-blob-cache-control': 'no-cache' // Prevent caching issues
            },
            body: file
          });
          
          if (response.ok || response.status === 201) {
            // Success! The file has been replaced in Azure Blob Storage
            const fileName = originalPath.split('/').pop();
            addSystemMessage(`✅ File "${fileName}" has been successfully replaced with your updated version!`);
            
            // Clear the edit session
            sessionStorage.removeItem('editingFile');
            window.tempEditedFile = null;
            
            // Close the modal
            const modal = document.getElementById('uploadEditModal');
            if (modal) modal.remove();
            
            // Remove the edit notification if it exists
            const notification = document.getElementById('editNotification');
            if (notification) notification.remove();
            
            // Reload the file list to show the updated file
            await loadClientFiles(selectedClient);
            
            // Optionally trigger reindexing
            setTimeout(() => {
              if (confirm('Would you like to reindex this file to update the search index with your changes?')) {
                reindexFile(originalPath);
              }
            }, 500);
            
          } else {
            throw new Error(`Upload failed with status ${response.status}`);
          }
          
        } catch (error) {
          console.error('Error uploading edited file:', error);
          
          // Show error in modal instead of global error
          const modal = document.getElementById('uploadEditModal');
          if (modal) {
            const errorMsg = error.message.includes('Failed to fetch') ? 
              'Network error: Unable to connect to storage. Please check your internet connection and try again.' : 
              `Failed to upload edited file: ${error.message}`;
            showModalError(modal, errorMsg);
          }
          
          // Re-enable button
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Upload & Replace';
        }
      }
      
      function openInBrowser(url) {
        // For PDFs and other files that can be displayed in browser
        const win = window.open(url, '_blank');
        win.focus();
      }
      
      // Edit file - download, edit in native app, and re-upload
      function editFile(fileName) {
        const currentFolder = getCurrentFolder();
        const file = currentFolder._files.find(f => f.name === fileName);
        
        if (!file) return;
        
        // Use the same download and track function
        downloadAndTrackForEdit(file.blobUrl, fileName, file.fullPath);
      }
      
      // Rename item (placeholder - would need backend support)
      function renameItem(itemName, isFolder) {
        const newName = prompt(`Enter new name for ${isFolder ? 'folder' : 'file'}:`, itemName);
        if (newName && newName !== itemName) {
          addSystemMessage(`📝 Rename feature coming soon. Azure Blob Storage rename operations require server-side implementation.`);
        }
      }
      
      // Delete file using n8n webhook for proper index cleanup
      async function deleteFile(filePath) {
        const fileName = filePath.split('/').pop();
        if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
          return;
        }
        
        try {
          // Extract file info from path for n8n webhook
          const pathParts = filePath.split('/');
          const clientName = pathParts[1];
          const category = pathParts[2] || 'documents';
          
          // Use n8n webhook for file deletion with proper index cleanup
          const webhookUrl = 'https://workflows.saxtechnology.com/webhook/ask-foreman/files/delete';
          
          const response = await fetch(webhookUrl, {
            method: 'POST',  // Use POST instead of DELETE for webhook
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              filePath: filePath,
              clientName: clientName,
              category: category,
              fileName: fileName,
              source: 'main-app',
              timestamp: new Date().toISOString()
            })
          });
          
          if (response.ok) {
            addSystemMessage(`✅ File "${fileName}" deleted successfully from storage and index!`);
            
            // Clear existing file structure to force a fresh reload
            fileStructure = {};
            currentPath = [];
            selectedFiles.clear();
            
            // Close any open context menus
            closeContextMenu();
            
            // Reload the file list with force refresh
            await loadClientFiles(selectedClient);
          } else {
            // Fallback to direct blob deletion if webhook fails
            console.warn('Webhook deletion failed, attempting direct blob deletion');
            const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
            
            const directResponse = await fetch(deleteUrl, {
              method: 'DELETE',
              headers: {
                'x-ms-delete-snapshots': 'include'
              }
            });
            
            if (directResponse.ok || directResponse.status === 202) {
              addSystemMessage(`⚠️ File "${fileName}" deleted from storage (index may not be updated)`);
              
              // Clear existing file structure to force a fresh reload
              fileStructure = {};
              currentPath = [];
              selectedFiles.clear();
              
              // Close any open context menus
              closeContextMenu();
              
              await loadClientFiles(selectedClient);
            } else {
              throw new Error(`Delete failed with status ${directResponse.status}`);
            }
          }
        } catch (error) {
          console.error('Error deleting file:', error);
          showError(`Failed to delete file: ${error.message}`);
        }
      }
      
      // Delete folder (would need to delete all contents)
      async function deleteFolder(folderName) {
        if (!confirm(`Are you sure you want to delete the folder "${folderName}" and all its contents?`)) {
          return;
        }
        addSystemMessage(`📁 Folder deletion requires deleting all files within it. This feature requires server-side implementation for batch operations.`);
      }
      
      // Reindex file
      async function reindexFile(filePath) {
        const fileName = filePath.split('/').pop();
        addSystemMessage(`🔄 Reindexing "${fileName}"... Processing document for search index update.`);
        
        // Parse the file path to get client and category info
        const pathParts = filePath.split('/');
        const clientName = pathParts[1]; // After FCS-OriginalClients/
        
        // Determine category from path or filename
        let category = 'documents';
        const lowerPath = filePath.toLowerCase();
        
        if (lowerPath.includes('/drawings/') || lowerPath.includes('drawing') || lowerPath.includes('plan')) {
          category = 'drawings';
        } else if (lowerPath.includes('/estimates/') || lowerPath.includes('estimate')) {
          category = 'estimates';
        } else if (lowerPath.includes('/proposals/') || lowerPath.includes('proposal')) {
          category = 'proposals';
        } else if (lowerPath.includes('/specs/') || lowerPath.includes('spec')) {
          category = 'specs';
        } else if (lowerPath.includes('/contracts/') || lowerPath.includes('contract')) {
          category = 'signed-contracts';
        }
        
        try {
          // First, download the file content from Azure
          const blobUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
          
          const response = await fetch(blobUrl);
          if (!response.ok) {
            throw new Error(`Failed to fetch file: ${response.status}`);
          }
          
          const blob = await response.blob();
          const file = new File([blob], fileName, { type: blob.type });
          
          // Create form data for the processing webhook
          const formData = new FormData();
          formData.append('file', file);
          formData.append('category', category);
          formData.append('client', clientName);  // Keep original capitalization
          formData.append('action', 'reindex'); // Flag this as a reindex operation
          
          // Call the processing webhook
          const processResponse = await fetch(API_CONFIG.uploadWebhookUrl, {
            method: 'POST',
            body: formData
          });
          
          if (!processResponse.ok) {
            const errorText = await processResponse.text();
            throw new Error(`HTTP ${processResponse.status}: ${errorText}`);
          }
          
          const result = await processResponse.json();
          addSystemMessage(`✅ File "${fileName}" has been successfully reindexed!`);
          
        } catch (error) {
          console.error('Error reindexing file:', error);
          addSystemMessage(`⚠️ Failed to reindex "${fileName}": ${error.message}`);
        }
      }
      
      // Render the file browser view
      function renderFileBrowser() {
        const fileList = document.getElementById('fileList');
        if (!fileList) return;
        
        fileList.innerHTML = '';
        
        // Add navigation bar
        const navBar = document.createElement('div');
        navBar.className = 'file-browser-navigation';
        
        const backButton = document.createElement('button');
        backButton.className = 'nav-button';
        backButton.innerHTML = '⬅️';
        backButton.disabled = currentPath.length === 0;
        backButton.onclick = navigateBack;
        
        const upButton = document.createElement('button');
        upButton.className = 'nav-button';
        upButton.innerHTML = '⬆️';
        upButton.disabled = currentPath.length === 0;
        upButton.onclick = navigateBack;
        
        const breadcrumb = document.createElement('div');
        breadcrumb.className = 'breadcrumb';
        
        // Root
        const rootItem = document.createElement('span');
        rootItem.className = 'breadcrumb-item';
        rootItem.textContent = '📁 ' + (clientSelect.options[clientSelect.selectedIndex]?.text || 'Root');
        rootItem.onclick = () => navigateToPath(0);
        breadcrumb.appendChild(rootItem);
        
        // Path items
        currentPath.forEach((folder, index) => {
          const separator = document.createElement('span');
          separator.className = 'breadcrumb-separator';
          separator.textContent = '>';
          breadcrumb.appendChild(separator);
          
          const pathItem = document.createElement('span');
          pathItem.className = 'breadcrumb-item';
          pathItem.textContent = folder;
          pathItem.onclick = () => navigateToPath(index + 1);
          breadcrumb.appendChild(pathItem);
        });
        
        navBar.appendChild(backButton);
        navBar.appendChild(upButton);
        navBar.appendChild(breadcrumb);
        fileList.appendChild(navBar);
        
        // Get current folder content
        const currentFolder = getCurrentFolder();
        
        // Create items container
        const itemsContainer = document.createElement('div');
        itemsContainer.style.padding = '0.5rem';
        
        // Display folders first
        const folders = Object.keys(currentFolder).filter(key => key !== '_files').sort();
        
        folders.forEach(folderName => {
          const folderItem = document.createElement('div');
          folderItem.className = 'folder-item';
          if (selectedFiles.has(folderName)) {
            folderItem.classList.add('selected');
          }
          
          folderItem.onclick = (e) => handleItemClick(e, folderName, true);
          folderItem.oncontextmenu = (e) => showContextMenu(e, folderName, true);
          
          // Count items in folder
          const folderContent = currentFolder[folderName];
          let itemCount = 0;
          if (folderContent._files) itemCount += folderContent._files.length;
          itemCount += Object.keys(folderContent).filter(k => k !== '_files').length;
          
          folderItem.innerHTML = `
            <div class="existing-file-info">
              <div class="file-icon">📁</div>
              <div class="existing-file-name">${folderName}</div>
              <div class="existing-file-meta">
                <span class="file-meta-item">${itemCount} items</span>
              </div>
            </div>
          `;
          
          itemsContainer.appendChild(folderItem);
        });
        
        // Display files
        const files = currentFolder._files || [];
        files.sort((a, b) => a.name.localeCompare(b.name));
        
        files.forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.className = 'existing-file-item';
          if (selectedFiles.has(file.name)) {
            fileItem.classList.add('selected');
          }
          
          fileItem.onclick = (e) => handleItemClick(e, file.name, false);
          fileItem.oncontextmenu = (e) => showContextMenu(e, file.name, false);
          
          // Get file icon based on extension - using actual logos
          const ext = file.name.split('.').pop().toLowerCase();
          let icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path fill="#BDBDBD" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
          </svg>`; // Default generic document
          
          // PDF files - Adobe PDF logo (classic style)
          if (ext === 'pdf') {
            icon = `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect width="32" height="32" rx="2" fill="#DC372C"/>
              <path fill="white" d="M8.5 10.5h2.8c1.7 0 2.7 1 2.7 2.5s-1 2.5-2.7 2.5h-1.6v2.5H8.5v-7.5zm1.2 1v3h1.6c1 0 1.5-.6 1.5-1.5s-.5-1.5-1.5-1.5H9.7z"/>
              <path fill="white" d="M14.5 10.5h2.3c2.2 0 3.5 1.3 3.5 3.7s-1.3 3.8-3.5 3.8h-2.3v-7.5zm1.2 1v5.5h1.1c1.5 0 2.3-.9 2.3-2.8 0-1.8-.8-2.7-2.3-2.7h-1.1z"/>
              <path fill="white" d="M21 10.5h4.5v1H22.2v2.5h2.8v1h-2.8v3H21v-7.5z"/>
            </svg>`;
          }
          // Word documents - Microsoft Word logo
          else if (ext === 'docx' || ext === 'doc' || ext === 'docm' || ext === 'dotx' || ext === 'dot') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#2B579A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M9.5 11.5h1l.9 4.2h.05l1.05-4.2h1.5l1.05 4.2h.05l.9-4.2h1l-1.45 6h-1.55l-1-3.85h-.05l-1 3.85H10.95z"/>
            </svg>`;
          }
          // Excel spreadsheets - Microsoft Excel logo
          else if (ext === 'xlsx' || ext === 'xls' || ext === 'xlsm' || ext === 'xlsb' || ext === 'xltx' || ext === 'xlt' || ext === 'csv') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#107C41" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M8.5 11.5h1.5l1.5 3 1.5-3h1.5l-2.25 4.5 2.25 4.5h-1.5L12 17.5l-1.5 3H9l2.25-4.5z"/>
            </svg>`;
          }
          // PowerPoint presentations - Microsoft PowerPoint logo
          else if (ext === 'pptx' || ext === 'ppt' || ext === 'pptm' || ext === 'potx' || ext === 'pot' || ext === 'ppsx' || ext === 'pps') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#B7472A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M9 11.5h3.5c1.93 0 3 1.07 3 2.75s-1.07 2.75-3 2.75H10.5v3.5H9v-9zm1.5 1.25v3h2c.83 0 1.5-.42 1.5-1.5s-.67-1.5-1.5-1.5h-2z"/>
            </svg>`;
          }
          // Image files
          else if (ext === 'png' || ext === 'jpg' || ext === 'jpeg' || ext === 'gif' || ext === 'bmp' || ext === 'svg' || ext === 'webp' || ext === 'ico' || ext === 'tiff' || ext === 'tif') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#4285F4" width="24" height="24" rx="2"/>
              <circle cx="8" cy="8" r="2" fill="#FFF"/>
              <path fill="#FFF" d="M4 18h16l-5-6-4 4.5-2.5-3z"/>
            </svg>`;
          }
          // CAD/Drawing files - AutoCAD style
          else if (ext === 'dwg' || ext === 'dxf' || ext === 'dwf' || ext === 'dgn' || ext === 'rvt' || ext === 'ifc' || ext === 'skp') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#E51937" width="24" height="24" rx="2"/>
              <text x="12" y="15" font-family="Arial, sans-serif" font-size="8" font-weight="bold" fill="white" text-anchor="middle">DWG</text>
            </svg>`;
          }
          // Archive files
          else if (ext === 'zip' || ext === 'rar' || ext === '7z' || ext === 'tar' || ext === 'gz' || ext === 'bz2') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#F4B400" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <rect x="10" y="4" width="2" height="2" fill="#FFF" opacity=".7"/>
              <rect x="10" y="6" width="2" height="2" fill="#FFF" opacity=".6"/>
              <rect x="10" y="8" width="2" height="2" fill="#FFF" opacity=".5"/>
              <rect x="10" y="10" width="2" height="2" fill="#FFF" opacity=".4"/>
              <path fill="#FFF" d="M9 13h6v5H9z"/>
            </svg>`;
          }
          // Text files
          else if (ext === 'txt' || ext === 'log' || ext === 'md' || ext === 'rtf') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#757575" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M7 11h10v1H7zm0 2h10v1H7zm0 2h7v1H7z"/>
            </svg>`;
          }
          // Email files - Outlook style
          else if (ext === 'msg' || ext === 'eml' || ext === 'oft') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#0078D4" d="M21 4H3a2 2 0 00-2 2v12a2 2 0 002 2h18a2 2 0 002-2V6a2 2 0 00-2-2z"/>
              <path fill="#FFF" d="M21 7l-9 6-9-6V6l9 6 9-6z"/>
            </svg>`;
          }
          // Video files
          else if (ext === 'mp4' || ext === 'avi' || ext === 'mov' || ext === 'wmv' || ext === 'flv' || ext === 'mkv' || ext === 'webm') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#FF5722" width="24" height="24" rx="2"/>
              <path fill="#FFF" d="M8 6h8a1 1 0 011 1v10a1 1 0 01-1 1H8a1 1 0 01-1-1V7a1 1 0 011-1zm9 5.5L19 10v4l-2-1.5z"/>
            </svg>`;
          }
          // Audio files
          else if (ext === 'mp3' || ext === 'wav' || ext === 'flac' || ext === 'aac' || ext === 'ogg' || ext === 'wma' || ext === 'm4a') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#673AB7" width="24" height="24" rx="2"/>
              <path fill="#FFF" d="M12 3v10.55A4 4 0 1014 17V7h4V3h-6z"/>
            </svg>`;
          }
          // Code/Script files
          else if (ext === 'js' || ext === 'ts' || ext === 'py' || ext === 'java' || ext === 'c' || ext === 'cpp' || ext === 'cs' || ext === 'php' || ext === 'rb' || ext === 'go' || ext === 'swift' || ext === 'kt' || ext === 'rs' || ext === 'html' || ext === 'css' || ext === 'scss' || ext === 'sass' || ext === 'json' || ext === 'xml' || ext === 'yaml' || ext === 'yml' || ext === 'sql') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <rect fill="#1F1F1F" width="24" height="24" rx="2"/>
              <path fill="#4EC9B0" d="M8 16l-4-4 4-4 1.5 1.5L7 12l2.5 2.5z"/>
              <path fill="#CE9178" d="M16 16l4-4-4-4-1.5 1.5L17 12l-2.5 2.5z"/>
            </svg>`;
          }
          // OneNote files - Microsoft OneNote logo
          else if (ext === 'one' || ext === 'onetoc2' || ext === 'onepkg') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#7719AA" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M8 11h1.5l2.5 5.5V11h1.5v8H12l-2.5-5.5V19H8z"/>
            </svg>`;
          }
          // Visio files - Microsoft Visio logo
          else if (ext === 'vsdx' || ext === 'vsd' || ext === 'vss' || ext === 'vst' || ext === 'vssx' || ext === 'vstx') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#3955A3" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <text x="12" y="16" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="white" text-anchor="middle">V</text>
            </svg>`;
          }
          // Project files - Microsoft Project logo
          else if (ext === 'mpp' || ext === 'mpt') {
            icon = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
              <path fill="#31752F" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
              <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
              <path fill="#FFF" d="M8 11h3.5c1.93 0 3 1.07 3 2.75s-1.07 2.75-3 2.75H9.5V19H8v-8zm1.5 1.25v3h2c.83 0 1.5-.42 1.5-1.5s-.67-1.5-1.5-1.5h-2z"/>
            </svg>`;
          }
          
          const formattedDate = file.lastModified ? new Date(file.lastModified).toLocaleDateString() : '';
          
          fileItem.innerHTML = `
            <div class="existing-file-info">
              <div class="file-icon">${icon}</div>
              <div class="existing-file-name" title="${file.name}">${file.name}</div>
            </div>
            <div class="file-details-row">
              <div class="existing-file-meta">
                <span class="file-meta-item">${formatFileSize(file.size)}</span>
                <span class="file-meta-item file-meta-date">${formattedDate}</span>
              </div>
              <div class="existing-file-actions">
                <button class="file-action-btn" onclick="downloadAndTrackForEdit('${file.blobUrl}', '${file.name.replace(/'/g, "\\'").replace(/"/g, "&quot;")}', '${file.fullPath.replace(/'/g, "\\'").replace(/"/g, "&quot;")}'); event.stopPropagation();"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"><path d="M12 15l-5-5h3V4h4v6h3l-5 5z"/><path d="M19 18H5v2h14v-2z"/></svg></button>
                <button class="file-action-btn" onclick="deleteFile('${file.fullPath}'); event.stopPropagation();">🗑️</button>
              </div>
            </div>
          `;
          
          itemsContainer.appendChild(fileItem);
        });
        
        // Show empty message if no items
        if (folders.length === 0 && files.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'no-files-message';
          emptyMsg.innerHTML = '📂 This folder is empty';
          itemsContainer.appendChild(emptyMsg);
        }
        
        fileList.appendChild(itemsContainer);
      }
      
      // Load existing files for a specific client from Azure Blob Storage
      async function loadClientFiles(clientName) {
        const fileList = document.getElementById("fileList");
        if (!fileList) return;
        
        // Reset navigation
        currentPath = [];
        selectedFiles.clear();
        
        // Show loading indicator
        fileList.innerHTML = '';
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-indicator active';
        loadingDiv.textContent = 'Loading files...';
        fileList.appendChild(loadingDiv);
        
        try {
          // Use the actual client ID (which preserves original case) instead of display text
          const actualClientName = clientName; // Use the passed clientName which is the ID
          const prefix = `FCS-OriginalClients/${actualClientName}/`;
          const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}`;
          
          const response = await fetch(listUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/xml'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const xmlText = await response.text();
          console.log(`Files for client ${actualClientName}:`, xmlText);
          
          // Parse the XML response
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          
          // Get all blobs (files)
          const blobs = xmlDoc.getElementsByTagName("Blob");
          const files = [];
          
          for (let i = 0; i < blobs.length; i++) {
            const nameElement = blobs[i].getElementsByTagName("Name")[0];
            const propertiesElement = blobs[i].getElementsByTagName("Properties")[0];
            
            if (nameElement) {
              const fullPath = nameElement.textContent;
              const pathParts = fullPath.split('/');
              const fileName = pathParts[pathParts.length - 1];
              
              // Skip if it's not a real file (empty name)
              if (fileName && fileName.length > 0) {
                let fileSize = 0;
                let lastModified = '';
                let contentType = '';
                
                // Extract file properties if available
                if (propertiesElement) {
                  const sizeElement = propertiesElement.getElementsByTagName("Content-Length")[0];
                  const modifiedElement = propertiesElement.getElementsByTagName("Last-Modified")[0];
                  const typeElement = propertiesElement.getElementsByTagName("Content-Type")[0];
                  
                  if (sizeElement) fileSize = parseInt(sizeElement.textContent) || 0;
                  if (modifiedElement) lastModified = modifiedElement.textContent;
                  if (typeElement) contentType = typeElement.textContent;
                }
                
                files.push({
                  name: fileName,
                  fullPath: fullPath,
                  size: fileSize,
                  lastModified: lastModified,
                  contentType: contentType,
                  blobUrl: `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${fullPath}${AZURE_STORAGE.sasToken}`
                });
              }
            }
          }
          
          // Build hierarchical structure
          fileStructure = buildFileStructure(files);
          
          // Render the file browser
          renderFileBrowser();
          
          console.log(`Loaded ${files.length} files for client ${actualClientName}`);
          
        } catch (error) {
          console.error('Error loading client files:', error);
          fileList.innerHTML = '';
          const errorDiv = document.createElement('div');
          errorDiv.className = 'no-files-message';
          errorDiv.innerHTML = `⚠️ Error loading files: ${error.message}`;
          fileList.appendChild(errorDiv);
        }
      }
      
      // Delete a file using n8n webhook for proper cleanup
      async function deleteClientFile(filePath, clientName) {
        const fileName = filePath.split('/').pop();
        if (!confirm(`Are you sure you want to delete ${fileName}?`)) {
          return;
        }
        
        try {
          // Extract category from path
          const pathParts = filePath.split('/');
          const category = pathParts[2] || 'documents';
          
          // Use n8n webhook for file deletion with proper index cleanup
          const webhookUrl = 'https://workflows.saxtechnology.com/webhook/ask-foreman/files/delete';
          
          const response = await fetch(webhookUrl, {
            method: 'POST',  // Use POST instead of DELETE for webhook
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              filePath: filePath,
              clientName: clientName,
              category: category,
              fileName: fileName,
              source: 'main-app-file-browser',
              timestamp: new Date().toISOString()
            })
          });
          
          if (response.ok) {
            addSystemMessage(`✅ File deleted successfully from storage and index!`);
            
            // Clear existing file structure to force a fresh reload
            fileStructure = {};
            currentPath = [];
            selectedFiles.clear();
            
            // Reload the file list with fresh data
            await loadClientFiles(clientName);
          } else {
            // Fallback to direct blob deletion if webhook fails
            console.warn('Webhook deletion failed, attempting direct blob deletion');
            const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
            
            const directResponse = await fetch(deleteUrl, {
              method: 'DELETE',
              headers: {
                'x-ms-delete-snapshots': 'include'
              }
            });
            
            if (directResponse.ok || directResponse.status === 202) {
              addSystemMessage(`⚠️ File deleted from storage (index may not be updated)`);
              
              // Clear existing file structure to force a fresh reload
              fileStructure = {};
              currentPath = [];
              selectedFiles.clear();
              
              await loadClientFiles(clientName);
            } else {
              throw new Error(`Delete failed with status ${directResponse.status}`);
            }
          }
        } catch (error) {
          console.error('Error deleting file:', error);
          showError(`Failed to delete file: ${error.message}`);
        }
      }
      
      // Make loadClientFiles available globally for the refresh button
      window.loadClientFiles = loadClientFiles;
      window.deleteClientFile = deleteClientFile;
      
      // Professional Estimator Form
      function openEstimatorForm() {
        // Create the estimator form modal
        const modal = document.createElement('div');
        modal.id = 'estimatorFormModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          overflow: auto;
          padding: 1rem;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          border-radius: 12px;
          width: 95%;
          max-width: 1400px;
          height: 95vh;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          display: flex;
          flex-direction: column;
          position: relative;
        `;
        
        modalContent.innerHTML = `
          <!-- Header -->
          <div style="
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #FFB300 0%, #FF6F00 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.5rem;">📊</span>
              Professional Construction Estimator
              <span style="
                background: rgba(255,255,255,0.2);
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: normal;
              ">Excel Compatible</span>
            </h2>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <button onclick="downloadEstimateXLSX()" style="
                background: rgba(255,255,255,0.9);
                color: #FF6F00;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                transition: all 0.3s;
              " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <span>📥</span> Download XLSX
              </button>
              <button onclick="closeEstimatorForm()" style="
                background: transparent;
                border: none;
                color: white;
                font-size: 2rem;
                cursor: pointer;
                padding: 0;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: all 0.3s;
              " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">×</button>
            </div>
          </div>
          
          <!-- Project Info Bar -->
          <div style="
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #f8f9fa, #e8f4fd);
            border-bottom: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
          ">
            <div>
              <label style="display: block; font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Project Name</label>
              <input type="text" id="projectName" placeholder="Enter project name" style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-weight: 600;
              " />
            </div>
            <div>
              <label style="display: block; font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Client</label>
              <input type="text" id="clientName" placeholder="Client name" style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 5px;
              " />
            </div>
            <div>
              <label style="display: block; font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Estimate Date</label>
              <input type="date" id="estimateDate" style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 5px;
              " value="${new Date().toISOString().split('T')[0]}" />
            </div>
            <div>
              <label style="display: block; font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Estimator</label>
              <input type="text" id="estimatorName" placeholder="Your name" style="
                width: 100%;
                padding: 0.5rem;
                border: 1px solid #ddd;
                border-radius: 5px;
              " />
            </div>
          </div>
          
          <!-- Main Content Area -->
          <div style="
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: #fafafa;
          ">
            <!-- Line Items Table -->
            <div style="
              background: white;
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 1.5rem;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            ">
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
              ">
                <h3 style="margin: 0; color: var(--concrete-gray);">Line Items</h3>
                <button onclick="addLineItem()" style="
                  background: var(--blueprint-blue);
                  color: white;
                  border: none;
                  padding: 0.5rem 1rem;
                  border-radius: 5px;
                  cursor: pointer;
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                ">
                  <span>➕</span> Add Item
                </button>
              </div>
              
              <div style="overflow-x: auto;">
                <table id="lineItemsTable" style="
                  width: 100%;
                  border-collapse: collapse;
                  font-size: 0.9rem;
                ">
                  <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                      <th style="padding: 0.75rem; text-align: left; width: 5%;">Item</th>
                      <th style="padding: 0.75rem; text-align: left; width: 25%;">Description</th>
                      <th style="padding: 0.75rem; text-align: left; width: 15%;">Category</th>
                      <th style="padding: 0.75rem; text-align: right; width: 10%;">Quantity</th>
                      <th style="padding: 0.75rem; text-align: left; width: 8%;">Unit</th>
                      <th style="padding: 0.75rem; text-align: right; width: 10%;">Material Cost</th>
                      <th style="padding: 0.75rem; text-align: right; width: 10%;">Labor Cost</th>
                      <th style="padding: 0.75rem; text-align: right; width: 12%;">Total</th>
                      <th style="padding: 0.75rem; text-align: center; width: 5%;">Action</th>
                    </tr>
                  </thead>
                  <tbody id="lineItemsBody">
                    <!-- Line items will be added here -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Summary Section -->
            <div style="
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 1.5rem;
            ">
              <!-- Cost Breakdown -->
              <div style="
                background: white;
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              ">
                <h3 style="margin: 0 0 1rem 0; color: var(--concrete-gray);">Cost Breakdown</h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                    <span>Material Subtotal:</span>
                    <strong id="materialSubtotal">$0.00</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                    <span>Labor Subtotal:</span>
                    <strong id="laborSubtotal">$0.00</strong>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                    <span>Equipment/Other:</span>
                    <input type="number" id="equipmentCost" value="0" onchange="updateTotals()" style="
                      width: 120px;
                      text-align: right;
                      padding: 0.25rem;
                      border: 1px solid #ddd;
                      border-radius: 3px;
                    " />
                  </div>
                  <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: 600; font-size: 1.1rem; border-top: 2px solid #333;">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                  </div>
                </div>
              </div>
              
              <!-- Markups & Final Total -->
              <div style="
                background: linear-gradient(135deg, #fff3cd, #ffeaa7);
                border: 2px solid #ffc107;
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              ">
                <h3 style="margin: 0 0 1rem 0; color: #856404;">Markups & Total</h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Overhead (%):</span>
                    <input type="number" id="overheadPercent" value="10" min="0" max="100" onchange="updateTotals()" style="
                      width: 80px;
                      text-align: right;
                      padding: 0.25rem;
                      border: 1px solid #ffc107;
                      border-radius: 3px;
                    " />
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Profit Margin (%):</span>
                    <input type="number" id="profitPercent" value="15" min="0" max="100" onchange="updateTotals()" style="
                      width: 80px;
                      text-align: right;
                      padding: 0.25rem;
                      border: 1px solid #ffc107;
                      border-radius: 3px;
                    " />
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Contingency (%):</span>
                    <input type="number" id="contingencyPercent" value="5" min="0" max="100" onchange="updateTotals()" style="
                      width: 80px;
                      text-align: right;
                      padding: 0.25rem;
                      border: 1px solid #ffc107;
                      border-radius: 3px;
                    " />
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>Tax Rate (%):</span>
                    <input type="number" id="taxPercent" value="8.25" min="0" max="100" step="0.25" onchange="updateTotals()" style="
                      width: 80px;
                      text-align: right;
                      padding: 0.25rem;
                      border: 1px solid #ffc107;
                      border-radius: 3px;
                    " />
                  </div>
                  <div style="
                    display: flex;
                    justify-content: space-between;
                    padding: 0.75rem;
                    margin-top: 0.5rem;
                    background: var(--safety-yellow);
                    border-radius: 5px;
                    font-weight: bold;
                    font-size: 1.3rem;
                    color: var(--dark-gray);
                  ">
                    <span>TOTAL:</span>
                    <span id="grandTotal">$0.00</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Notes Section -->
            <div style="
              background: white;
              border-radius: 8px;
              padding: 1.5rem;
              margin-top: 1.5rem;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            ">
              <h3 style="margin: 0 0 1rem 0; color: var(--concrete-gray);">Notes & Exclusions</h3>
              <textarea id="estimateNotes" style="
                width: 100%;
                min-height: 100px;
                padding: 0.75rem;
                border: 1px solid #ddd;
                border-radius: 5px;
                font-family: inherit;
                resize: vertical;
              " placeholder="Add any notes, assumptions, or exclusions for this estimate..."></textarea>
            </div>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Initialize with sample data if takeoff results exist
        if (window.currentTakeoffResults) {
          populateFromTakeoff();
        } else {
          // Add sample line items
          addSampleLineItems();
        }
        
        updateTotals();
      }
      
      // Close estimator form
      window.closeEstimatorForm = function() {
        const modal = document.getElementById('estimatorFormModal');
        if (modal) modal.remove();
      }
      
      // Add line item to table
      window.addLineItem = function(data = {}) {
        const tbody = document.getElementById('lineItemsBody');
        if (!tbody) return;
        
        const rowCount = tbody.rows.length + 1;
        const row = tbody.insertRow();
        
        row.innerHTML = `
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <input type="text" value="${data.item || rowCount}" style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px;" />
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <input type="text" value="${data.description || ''}" placeholder="Enter description" style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px;" />
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <select style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px;">
              <option value="materials" ${data.category === 'materials' ? 'selected' : ''}>Materials</option>
              <option value="labor" ${data.category === 'labor' ? 'selected' : ''}>Labor</option>
              <option value="equipment" ${data.category === 'equipment' ? 'selected' : ''}>Equipment</option>
              <option value="subcontractor" ${data.category === 'subcontractor' ? 'selected' : ''}>Subcontractor</option>
              <option value="other" ${data.category === 'other' ? 'selected' : ''}>Other</option>
            </select>
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <input type="number" value="${data.quantity || 0}" min="0" step="0.01" onchange="updateLineTotal(this)" style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px; text-align: right;" />
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <input type="text" value="${data.unit || 'EA'}" placeholder="EA" style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px;" />
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <input type="number" value="${data.materialCost || 0}" min="0" step="0.01" onchange="updateLineTotal(this)" style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px; text-align: right;" />
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0;">
            <input type="number" value="${data.laborCost || 0}" min="0" step="0.01" onchange="updateLineTotal(this)" style="width: 100%; border: 1px solid #ddd; padding: 0.25rem; border-radius: 3px; text-align: right;" />
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0; text-align: right; font-weight: 600;">
            <span class="line-total">$0.00</span>
          </td>
          <td style="padding: 0.5rem; border-bottom: 1px solid #f0f0f0; text-align: center;">
            <button onclick="removeLineItem(this)" style="
              background: #dc3545;
              color: white;
              border: none;
              padding: 0.25rem 0.5rem;
              border-radius: 3px;
              cursor: pointer;
              font-size: 0.8rem;
            ">✕</button>
          </td>
        `;
        
        updateLineTotal(row.querySelector('input[type="number"]'));
      }
      
      // Update line item total
      window.updateLineTotal = function(input) {
        const row = input.closest('tr');
        const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
        const materialCost = parseFloat(row.cells[5].querySelector('input').value) || 0;
        const laborCost = parseFloat(row.cells[6].querySelector('input').value) || 0;
        
        const total = quantity * (materialCost + laborCost);
        row.cells[7].querySelector('.line-total').textContent = '$' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        
        updateTotals();
      }
      
      // Remove line item
      window.removeLineItem = function(button) {
        const row = button.closest('tr');
        row.remove();
        updateTotals();
      }
      
      // Update all totals
      window.updateTotals = function() {
        const tbody = document.getElementById('lineItemsBody');
        if (!tbody) return;
        
        let materialTotal = 0;
        let laborTotal = 0;
        
        for (let row of tbody.rows) {
          const quantity = parseFloat(row.cells[3].querySelector('input').value) || 0;
          const materialCost = parseFloat(row.cells[5].querySelector('input').value) || 0;
          const laborCost = parseFloat(row.cells[6].querySelector('input').value) || 0;
          
          materialTotal += quantity * materialCost;
          laborTotal += quantity * laborCost;
        }
        
        const equipmentCost = parseFloat(document.getElementById('equipmentCost').value) || 0;
        const subtotal = materialTotal + laborTotal + equipmentCost;
        
        const overheadPercent = parseFloat(document.getElementById('overheadPercent').value) || 0;
        const profitPercent = parseFloat(document.getElementById('profitPercent').value) || 0;
        const contingencyPercent = parseFloat(document.getElementById('contingencyPercent').value) || 0;
        const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
        
        const overhead = subtotal * (overheadPercent / 100);
        const profit = subtotal * (profitPercent / 100);
        const contingency = subtotal * (contingencyPercent / 100);
        const beforeTax = subtotal + overhead + profit + contingency;
        const tax = beforeTax * (taxPercent / 100);
        const grandTotal = beforeTax + tax;
        
        // Update display
        document.getElementById('materialSubtotal').textContent = '$' + materialTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('laborSubtotal').textContent = '$' + laborTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        document.getElementById('grandTotal').textContent = '$' + grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      }
      
      // Populate from takeoff results
      function populateFromTakeoff() {
        const results = window.currentTakeoffResults;
        if (!results) return;
        
        // Set project info
        const projectName = results.summary?.building || results.summary?.parameters?.building || 'Project';
        const floor = results.summary?.floor || results.summary?.parameters?.floor || '';
        document.getElementById('projectName').value = projectName + (floor ? ' - ' + floor : '');
        
        // If AI analysis is available, use calculated values
        if (results.rawAnalysis?.results?.calculations) {
          const calc = results.rawAnalysis.results.calculations;
          
          // Add wall painting if paintable area calculated
          if (calc.paintableArea > 0) {
            addLineItem({
              description: 'Wall Painting - ' + (calc.paintableArea.toFixed(0) + ' SF'),
              category: 'materials',
              quantity: calc.paintableArea,
              unit: 'SF',
              materialCost: 0.35, // Per SF for material
              laborCost: 0.65 // Per SF for labor
            });
          }
          
          // Add floor finishing if area calculated
          if (calc.totalFloorArea > 0) {
            addLineItem({
              description: 'Floor Finishing - ' + (results.summary?.parameters?.floorFinish || 'Standard'),
              category: 'materials',
              quantity: calc.totalFloorArea,
              unit: 'SF',
              materialCost: 2.50,
              laborCost: 1.50
            });
          }
          
          // Add doors if counted
          if (calc.doors?.count > 0) {
            addLineItem({
              description: 'Door Hardware & Installation',
              category: 'labor',
              quantity: calc.doors.count,
              unit: 'EA',
              materialCost: 85,
              laborCost: 125
            });
          }
          
          // Add windows if counted
          if (calc.windows?.count > 0) {
            addLineItem({
              description: 'Window Treatment/Finishing',
              category: 'materials',
              quantity: calc.windows.count,
              unit: 'EA',
              materialCost: 45,
              laborCost: 35
            });
          }
          
          // Add materials from calculations
          if (calc.materials && calc.materials.length > 0) {
            calc.materials.forEach(material => {
              addLineItem({
                description: material.type,
                category: 'materials',
                quantity: material.quantity,
                unit: material.unit,
                materialCost: material.estimatedCost / material.quantity, // Unit cost
                laborCost: 0
              });
            });
          }
          
        } else {
          // Fallback to simple measurements if no AI analysis
          if (results.measurements?.walls) {
            addLineItem({
              description: 'Wall Painting - ' + (results.paintRequirements?.wallFinish || 'Standard'),
              category: 'materials',
              quantity: results.measurements.walls.total || 0,
              unit: 'LF',
              materialCost: 2.50,
              laborCost: 3.75
            });
          }
          
          if (results.measurements?.floors) {
            addLineItem({
              description: 'Floor Coating/Finishing',
              category: 'materials',
              quantity: results.measurements.floors.total || 0,
              unit: 'SF',
              materialCost: 1.25,
              laborCost: 1.50
            });
          }
          
          if (results.paintRequirements) {
            addLineItem({
              description: 'Paint Materials - ' + results.paintRequirements.gallonsRequired + ' gallons',
              category: 'materials',
              quantity: results.paintRequirements.gallonsRequired,
              unit: 'GAL',
              materialCost: 35,
              laborCost: 0
            });
          }
        }
        
        // Add notes from recommendations if available
        if (results.recommendations && results.recommendations.length > 0) {
          const notes = results.recommendations.map(rec => 
            `${rec.type.toUpperCase()}: ${rec.message}`
          ).join('\n\n');
          
          const notesField = document.getElementById('estimateNotes');
          if (notesField) {
            notesField.value = 'AI Analysis Notes:\n' + notes;
          }
        }
      }
      
      // Add sample line items
      function addSampleLineItems() {
        addLineItem({
          description: 'Drywall Installation',
          category: 'materials',
          quantity: 1000,
          unit: 'SF',
          materialCost: 0.65,
          laborCost: 0.85
        });
        
        addLineItem({
          description: 'Interior Painting',
          category: 'materials',
          quantity: 2500,
          unit: 'SF',
          materialCost: 0.35,
          laborCost: 0.75
        });
        
        addLineItem({
          description: 'Flooring - Vinyl Plank',
          category: 'materials',
          quantity: 800,
          unit: 'SF',
          materialCost: 2.50,
          laborCost: 1.50
        });
      }
      
      // Download estimate as XLSX
      window.downloadEstimateXLSX = function() {
        // Gather all data
        const projectData = {
          projectName: document.getElementById('projectName').value || 'Untitled Project',
          clientName: document.getElementById('clientName').value || '',
          estimateDate: document.getElementById('estimateDate').value || new Date().toISOString().split('T')[0],
          estimatorName: document.getElementById('estimatorName').value || '',
          notes: document.getElementById('estimateNotes').value || ''
        };
        
        // Collect line items
        const lineItems = [];
        const tbody = document.getElementById('lineItemsBody');
        if (tbody) {
          for (let row of tbody.rows) {
            lineItems.push({
              item: row.cells[0].querySelector('input').value,
              description: row.cells[1].querySelector('input').value,
              category: row.cells[2].querySelector('select').value,
              quantity: parseFloat(row.cells[3].querySelector('input').value) || 0,
              unit: row.cells[4].querySelector('input').value,
              materialCost: parseFloat(row.cells[5].querySelector('input').value) || 0,
              laborCost: parseFloat(row.cells[6].querySelector('input').value) || 0
            });
          }
        }
        
        // Get totals
        const totals = {
          materialSubtotal: document.getElementById('materialSubtotal').textContent,
          laborSubtotal: document.getElementById('laborSubtotal').textContent,
          equipmentCost: parseFloat(document.getElementById('equipmentCost').value) || 0,
          overheadPercent: parseFloat(document.getElementById('overheadPercent').value) || 0,
          profitPercent: parseFloat(document.getElementById('profitPercent').value) || 0,
          contingencyPercent: parseFloat(document.getElementById('contingencyPercent').value) || 0,
          taxPercent: parseFloat(document.getElementById('taxPercent').value) || 0,
          grandTotal: document.getElementById('grandTotal').textContent
        };
        
        // Create workbook using SheetJS (we'll use CSV for now as a fallback)
        let csv = '';
        
        // Header section
        csv += 'CONSTRUCTION ESTIMATE\n';
        csv += '\n';
        csv += 'Project Information\n';
        csv += 'Project Name,' + projectData.projectName + '\n';
        csv += 'Client,' + projectData.clientName + '\n';
        csv += 'Estimate Date,' + projectData.estimateDate + '\n';
        csv += 'Estimator,' + projectData.estimatorName + '\n';
        csv += '\n';
        
        // Line items
        csv += 'Line Items\n';
        csv += 'Item,Description,Category,Quantity,Unit,Material Cost,Labor Cost,Line Total\n';
        
        lineItems.forEach(item => {
          const lineTotal = item.quantity * (item.materialCost + item.laborCost);
          csv += `${item.item},"${item.description}",${item.category},${item.quantity},${item.unit},${item.materialCost},${item.laborCost},${lineTotal.toFixed(2)}\n`;
        });
        
        csv += '\n';
        csv += 'Cost Summary\n';
        csv += 'Material Subtotal,' + totals.materialSubtotal + '\n';
        csv += 'Labor Subtotal,' + totals.laborSubtotal + '\n';
        csv += 'Equipment/Other,$' + totals.equipmentCost.toFixed(2) + '\n';
        csv += 'Overhead (' + totals.overheadPercent + '%)\n';
        csv += 'Profit Margin (' + totals.profitPercent + '%)\n';
        csv += 'Contingency (' + totals.contingencyPercent + '%)\n';
        csv += 'Tax Rate (' + totals.taxPercent + '%)\n';
        csv += 'GRAND TOTAL,' + totals.grandTotal + '\n';
        
        if (projectData.notes) {
          csv += '\n';
          csv += 'Notes & Exclusions\n';
          csv += '"' + projectData.notes.replace(/"/g, '""') + '"\n';
        }
        
        // Create and download file
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Estimate_${projectData.projectName.replace(/[^a-z0-9]/gi, '_')}_${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        addSystemMessage('✅ Estimate exported successfully! Open in Excel to continue editing.');
      }
      
      // Digital Takeoff Assistant
      function openDigitalTakeoffAssistant() {
        // Use the new complete implementation
        if (window.initializeDigitalTakeoff) {
          window.initializeDigitalTakeoff();
        } else {
          // Fallback to old implementation
          const modal = document.createElement('div');
          modal.id = 'takeoffModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          overflow: auto;
          padding: 2rem;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          border-radius: 12px;
          width: 95%;
          max-width: 1600px;
          height: 90vh;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          display: flex;
          flex-direction: column;
          position: relative;
        `;
        
        modalContent.innerHTML = `
          <!-- Header -->
          <div style="
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, var(--spreadsheet-green) 0%, #0E5C2F 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.5rem;">📐</span>
              Digital Takeoff Assistant
              <span style="
                background: rgba(255,255,255,0.2);
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: normal;
              ">AI-Powered Drawing Analysis</span>
            </h2>
            <button onclick="closeTakeoffModal()" style="
              background: transparent;
              border: none;
              color: white;
              font-size: 2rem;
              cursor: pointer;
              padding: 0;
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-radius: 50%;
              transition: all 0.3s;
            " onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">×</button>
          </div>
          
          <!-- Main Content Area -->
          <div style="
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 0;
            overflow: hidden;
          ">
            <!-- Left Panel - Drawing Area -->
            <div style="
              display: flex;
              flex-direction: column;
              border-right: 1px solid #e0e0e0;
              overflow: hidden;
            ">
              <!-- Toolbar -->
              <div style="
                padding: 1rem;
                background: #f8f9fa;
                border-bottom: 1px solid #e0e0e0;
                display: flex;
                gap: 1rem;
                align-items: center;
                flex-wrap: wrap;
              ">
                <!-- File Selection -->
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                  <input type="file" id="takeoffFileInput" accept=".pdf,.tiff,.tif,.png,.jpg,.jpeg" style="display: none;" multiple />
                  <button onclick="document.getElementById('takeoffFileInput').click()" style="
                    padding: 0.5rem 1rem;
                    background: var(--blueprint-blue);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    font-weight: 600;
                  ">
                    <span>📄</span> Upload Drawing
                  </button>
                  <select id="existingDrawingSelect" style="
                    padding: 0.5rem;
                    border: 1px solid #ccc;
                    border-radius: 5px;
                    cursor: pointer;
                  ">
                    <option value="">Or select existing...</option>
                  </select>
                </div>
                
                <!-- Drawing Type -->
                <select id="drawingTypeSelect" style="
                  padding: 0.5rem;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                ">
                  <option value="floor-plan">Floor Plan</option>
                  <option value="elevation">Elevation</option>
                  <option value="section">Section</option>
                  <option value="detail">Detail</option>
                  <option value="site-plan">Site Plan</option>
                  <option value="reflected-ceiling">Reflected Ceiling</option>
                  <option value="electrical">Electrical</option>
                  <option value="plumbing">Plumbing</option>
                  <option value="hvac">HVAC</option>
                  <option value="structural">Structural</option>
                </select>
                
                <!-- Scale -->
                <input type="text" id="drawingScale" placeholder="Scale (e.g., 1/4\" = 1')" style="
                  padding: 0.5rem;
                  border: 1px solid #ccc;
                  border-radius: 5px;
                  width: 150px;
                " />
                
                <!-- AI Analysis Button -->
                <button id="analyzeDrawingBtn" disabled style="
                  padding: 0.5rem 1rem;
                  background: linear-gradient(135deg, var(--hi-vis-green), #64dd17);
                  color: var(--dark-gray);
                  border: none;
                  border-radius: 5px;
                  cursor: not-allowed;
                  opacity: 0.5;
                  display: flex;
                  align-items: center;
                  gap: 0.5rem;
                  font-weight: 600;
                  margin-left: auto;
                ">
                  <span>🤖</span> Analyze with AI
                </button>
              </div>
              
              <!-- Drawing Preview Area -->
              <div id="drawingPreview" style="
                flex: 1;
                background: #f5f5f5;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: auto;
                position: relative;
              ">
                <div style="
                  text-align: center;
                  color: #999;
                  padding: 2rem;
                ">
                  <div style="font-size: 4rem; margin-bottom: 1rem;">📐</div>
                  <h3 style="margin: 0 0 0.5rem 0;">No Drawing Loaded</h3>
                  <p style="margin: 0;">Upload a PDF, TIFF, or CAD export to begin</p>
                </div>
              </div>
              
              <!-- Analysis Progress -->
              <div id="analysisProgress" style="
                display: none;
                padding: 1rem;
                background: linear-gradient(135deg, #e3f2fd, #bbdefb);
                border-top: 2px solid var(--blueprint-blue);
              ">
                <div style="display: flex; align-items: center; gap: 1rem;">
                  <div class="spinner" style="
                    width: 24px;
                    height: 24px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid var(--blueprint-blue);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                  "></div>
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--blueprint-blue); margin-bottom: 0.25rem;">Analyzing Drawing...</div>
                    <div id="analysisStatus" style="font-size: 0.9rem; color: #666;">Extracting text and layout...</div>
                  </div>
                </div>
                <div style="
                  margin-top: 0.75rem;
                  height: 6px;
                  background: #e0e0e0;
                  border-radius: 3px;
                  overflow: hidden;
                ">
                  <div id="analysisProgressBar" style="
                    height: 100%;
                    width: 0%;
                    background: var(--blueprint-blue);
                    transition: width 0.3s;
                  "></div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel - Takeoff Parameters & Results -->
            <div style="
              display: flex;
              flex-direction: column;
              background: #fafafa;
              overflow: hidden;
            ">
              <!-- Tabs -->
              <div style="
                display: flex;
                background: white;
                border-bottom: 2px solid #e0e0e0;
              ">
                <button class="takeoff-tab active" onclick="switchTakeoffTab('parameters')" style="
                  flex: 1;
                  padding: 0.75rem;
                  background: transparent;
                  border: none;
                  cursor: pointer;
                  font-weight: 600;
                  color: var(--blueprint-blue);
                  border-bottom: 3px solid var(--blueprint-blue);
                ">Parameters</button>
                <button class="takeoff-tab" onclick="switchTakeoffTab('results')" style="
                  flex: 1;
                  padding: 0.75rem;
                  background: transparent;
                  border: none;
                  cursor: pointer;
                  font-weight: 600;
                  color: #666;
                  border-bottom: 3px solid transparent;
                ">Results</button>
              </div>
              
              <!-- Parameters Tab -->
              <div id="parametersTab" style="
                flex: 1;
                overflow-y: auto;
                padding: 1.5rem;
                display: block;
              ">
                <h3 style="margin: 0 0 1rem 0; color: var(--concrete-gray);">Takeoff Parameters</h3>
                
                <!-- Building/Location Info -->
                <div style="margin-bottom: 1.5rem;">
                  <h4 style="margin: 0 0 0.75rem 0; color: #666; font-size: 0.95rem;">Building & Location</h4>
                  <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <input type="text" id="buildingName" placeholder="Building Name" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    " />
                    <input type="text" id="floorLevel" placeholder="Floor/Level" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    " />
                    <input type="text" id="roomNumbers" placeholder="Room Numbers (comma separated)" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    " />
                  </div>
                </div>
                
                <!-- Measurement Focus -->
                <div style="margin-bottom: 1.5rem;">
                  <h4 style="margin: 0 0 0.75rem 0; color: #666; font-size: 0.95rem;">Measurement Focus</h4>
                  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="measureWalls" checked />
                      <span>Walls (Linear Feet)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="measureFloors" checked />
                      <span>Floor Area (Square Feet)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="measureCeilings" checked />
                      <span>Ceiling Area (Square Feet)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="measureDoors" checked />
                      <span>Doors (Count & Sizes)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="measureWindows" checked />
                      <span>Windows (Count & Sizes)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                      <input type="checkbox" id="measureFixtures" />
                      <span>Fixtures (HVAC, Electrical)</span>
                    </label>
                  </div>
                </div>
                
                <!-- Paint/Coating Specs -->
                <div style="margin-bottom: 1.5rem;">
                  <h4 style="margin: 0 0 0.75rem 0; color: #666; font-size: 0.95rem;">Paint & Coating Specifications</h4>
                  <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <select id="wallFinish" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    ">
                      <option value="">Wall Finish Type</option>
                      <option value="flat-paint">Flat Paint</option>
                      <option value="eggshell">Eggshell</option>
                      <option value="satin">Satin</option>
                      <option value="semi-gloss">Semi-Gloss</option>
                      <option value="gloss">Gloss</option>
                      <option value="primer-only">Primer Only</option>
                      <option value="texture-coating">Texture Coating</option>
                      <option value="wallpaper">Wallpaper</option>
                    </select>
                    <select id="ceilingFinish" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    ">
                      <option value="">Ceiling Finish Type</option>
                      <option value="flat-white">Flat White</option>
                      <option value="acoustic-tile">Acoustic Tile</option>
                      <option value="exposed-structure">Exposed Structure</option>
                      <option value="textured">Textured</option>
                    </select>
                    <select id="floorFinish" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    ">
                      <option value="">Floor Finish Type</option>
                      <option value="epoxy">Epoxy Coating</option>
                      <option value="polished-concrete">Polished Concrete</option>
                      <option value="vinyl">Vinyl/LVT</option>
                      <option value="carpet">Carpet</option>
                      <option value="hardwood">Hardwood</option>
                      <option value="tile">Tile</option>
                      <option value="sealed-concrete">Sealed Concrete</option>
                    </select>
                    <input type="number" id="coatsRequired" placeholder="Number of Coats" min="1" max="5" style="
                      padding: 0.5rem;
                      border: 1px solid #ddd;
                      border-radius: 5px;
                    " />
                  </div>
                </div>
              </div>
              
              <!-- Results Tab -->
              <div id="resultsTab" style="
                flex: 1;
                overflow-y: auto;
                padding: 1.5rem;
                display: none;
              ">
                <div style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 1rem;
                ">
                  <h3 style="margin: 0; color: var(--concrete-gray);">Analysis Results</h3>
                  <button onclick="exportToExcel()" style="
                    padding: 0.5rem 1rem;
                    background: var(--spreadsheet-green);
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    font-weight: 600;
                  ">
                    <span>📊</span> Export to Excel
                  </button>
                </div>
                
                <div id="takeoffResults" style="
                  background: white;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  padding: 1rem;
                  min-height: 300px;
                ">
                  <div style="
                    text-align: center;
                    color: #999;
                    padding: 2rem;
                  ">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                    <p>Analysis results will appear here</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          .takeoff-tab:hover {
            background: #f5f5f5 !important;
          }
          
          .takeoff-tab.active {
            color: var(--blueprint-blue) !important;
            border-bottom-color: var(--blueprint-blue) !important;
          }
        `;
        document.head.appendChild(style);
        
        // Initialize drawing selector and load existing drawings
        initializeDrawingSelector();
        loadExistingDrawings();
        
        // Reload drawings when client changes
        clientSelect.addEventListener('change', () => {
          if (document.getElementById('takeoffModal')) {
            loadExistingDrawings();
          }
        });
        
        // Set up file input handler
        document.getElementById('takeoffFileInput').addEventListener('change', handleTakeoffFileSelect);
        
        // Set up analyze button
        document.getElementById('analyzeDrawingBtn').addEventListener('click', analyzeDrawing);
      }
      
      // Close takeoff modal
      window.closeTakeoffModal = function() {
        const modal = document.getElementById('takeoffModal');
        if (modal) modal.remove();
      }
      
      // Switch tabs
      window.switchTakeoffTab = function(tab) {
        const tabs = document.querySelectorAll('.takeoff-tab');
        tabs.forEach(t => {
          t.classList.remove('active');
          t.style.color = '#666';
          t.style.borderBottomColor = 'transparent';
        });
        
        if (tab === 'parameters') {
          document.getElementById('parametersTab').style.display = 'block';
          document.getElementById('resultsTab').style.display = 'none';
          tabs[0].classList.add('active');
          tabs[0].style.color = 'var(--blueprint-blue)';
          tabs[0].style.borderBottomColor = 'var(--blueprint-blue)';
        } else {
          document.getElementById('parametersTab').style.display = 'none';
          document.getElementById('resultsTab').style.display = 'block';
          tabs[1].classList.add('active');
          tabs[1].style.color = 'var(--blueprint-blue)';
          tabs[1].style.borderBottomColor = 'var(--blueprint-blue)';
        }
      }
      
      // Load existing drawings from current client
      async function loadExistingDrawings() {
        const select = document.getElementById('existingDrawingSelect');
        if (!select) return;
        
        select.innerHTML = '<option value="">Or select existing...</option>';
        
        if (!selectedClient) {
          // Add option to prompt client selection
          select.innerHTML = '<option value="">Select a client first</option>';
          select.disabled = true;
          return;
        }
        
        select.disabled = false;
        
        try {
          // Add loading indicator
          select.innerHTML = '<option value="">Loading drawings...</option>';
          
          // List drawings from Azure Blob Storage
          const prefix = `FCS-OriginalClients/${selectedClient}/drawings/`;
          const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}`;
          
          const response = await fetch(listUrl);
          if (!response.ok) {
            select.innerHTML = '<option value="">No drawings found</option>';
            return;
          }
          
          const xmlText = await response.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          const blobs = xmlDoc.getElementsByTagName("Blob");
          
          select.innerHTML = '<option value="">Or select existing...</option>';
          
          // Group drawings by type
          const drawingsByType = {
            pdf: [],
            tiff: [],
            cad: [],
            images: []
          };
          
          for (let i = 0; i < blobs.length; i++) {
            const nameElement = blobs[i].getElementsByTagName("Name")[0];
            if (nameElement) {
              const fullPath = nameElement.textContent;
              const fileName = fullPath.split('/').pop();
              
              // Skip placeholder files
              if (fileName && !fileName.startsWith('.')) {
                const ext = fileName.split('.').pop().toLowerCase();
                const drawingInfo = {
                  path: fullPath,
                  name: fileName,
                  ext: ext
                };
                
                if (ext === 'pdf') {
                  drawingsByType.pdf.push(drawingInfo);
                } else if (ext === 'tiff' || ext === 'tif') {
                  drawingsByType.tiff.push(drawingInfo);
                } else if (ext === 'dwg' || ext === 'dxf' || ext === 'dgn') {
                  drawingsByType.cad.push(drawingInfo);
                } else if (['png', 'jpg', 'jpeg', 'gif', 'bmp'].includes(ext)) {
                  drawingsByType.images.push(drawingInfo);
                }
              }
            }
          }
          
          // Add grouped options
          if (drawingsByType.pdf.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = '📄 PDF Drawings';
            drawingsByType.pdf.forEach(drawing => {
              const option = document.createElement('option');
              option.value = drawing.path;
              option.textContent = drawing.name;
              optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
          }
          
          if (drawingsByType.tiff.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = '🖼️ TIFF Drawings';
            drawingsByType.tiff.forEach(drawing => {
              const option = document.createElement('option');
              option.value = drawing.path;
              option.textContent = drawing.name;
              optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
          }
          
          if (drawingsByType.cad.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = '📐 CAD Files';
            drawingsByType.cad.forEach(drawing => {
              const option = document.createElement('option');
              option.value = drawing.path;
              option.textContent = drawing.name;
              option.setAttribute('data-cad', 'true');
              optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
          }
          
          if (drawingsByType.images.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = '🎨 Image Files';
            drawingsByType.images.forEach(drawing => {
              const option = document.createElement('option');
              option.value = drawing.path;
              option.textContent = drawing.name;
              optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
          }
          
          // If no drawings found
          const totalDrawings = drawingsByType.pdf.length + drawingsByType.tiff.length + 
                              drawingsByType.cad.length + drawingsByType.images.length;
          if (totalDrawings === 0) {
            select.innerHTML = '<option value="">No drawings found for this client</option>';
          }
          
        } catch (error) {
          console.error('Error loading existing drawings:', error);
          select.innerHTML = '<option value="">Error loading drawings</option>';
        }
      }
      
      // Initialize drawing selector
      function initializeDrawingSelector() {
        const select = document.getElementById('existingDrawingSelect');
        if (!select) return;
        
        // Handle selection change only once
        select.addEventListener('change', async (e) => {
          if (e.target.value) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const isCadFile = selectedOption.getAttribute('data-cad') === 'true';
            
            if (isCadFile) {
              alert('CAD files require conversion to PDF or image format for analysis. Please export from your CAD software first.');
              e.target.value = '';
              return;
            }
            
            const blobUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${e.target.value}${AZURE_STORAGE.sasToken}`;
            await loadDrawingFromUrl(blobUrl, e.target.value.split('/').pop());
          }
        });
      }
      
      // Handle file selection
      async function handleTakeoffFileSelect(event) {
        const files = event.target.files;
        if (files.length === 0) return;
        
        const file = files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
          const arrayBuffer = e.target.result;
          await displayDrawing(arrayBuffer, file.name, file.type);
          
          // Enable analyze button
          const analyzeBtn = document.getElementById('analyzeDrawingBtn');
          analyzeBtn.disabled = false;
          analyzeBtn.style.cursor = 'pointer';
          analyzeBtn.style.opacity = '1';
        };
        
        reader.readAsArrayBuffer(file);
      }
      
      // Load drawing from URL
      async function loadDrawingFromUrl(url, fileName) {
        try {
          const response = await fetch(url);
          const arrayBuffer = await response.arrayBuffer();
          const type = fileName.endsWith('.pdf') ? 'application/pdf' : 'image/tiff';
          await displayDrawing(arrayBuffer, fileName, type);
          
          // Enable analyze button
          const analyzeBtn = document.getElementById('analyzeDrawingBtn');
          analyzeBtn.disabled = false;
          analyzeBtn.style.cursor = 'pointer';
          analyzeBtn.style.opacity = '1';
        } catch (error) {
          console.error('Error loading drawing:', error);
          alert('Failed to load drawing from storage');
        }
      }
      
      // Display drawing in preview area
      async function displayDrawing(arrayBuffer, fileName, fileType) {
        const preview = document.getElementById('drawingPreview');
        if (!preview) return;
        
        window.currentDrawing = {
          data: arrayBuffer,
          name: fileName,
          type: fileType
        };
        
        if (fileType === 'application/pdf') {
          // For PDF, create an object element to display it
          const blob = new Blob([arrayBuffer], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          
          preview.innerHTML = `
            <object data="${url}" type="application/pdf" style="width: 100%; height: 100%;">
              <p>PDF preview not available. The file has been loaded for analysis.</p>
            </object>
          `;
        } else {
          // For images
          const blob = new Blob([arrayBuffer], { type: fileType });
          const url = URL.createObjectURL(blob);
          
          preview.innerHTML = `
            <img src="${url}" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
          `;
        }
      }
      
      // Analyze drawing with AI
      async function analyzeDrawing() {
        if (!window.currentDrawing) {
          alert('Please upload a drawing first');
          return;
        }
        
        // Show progress
        const progressDiv = document.getElementById('analysisProgress');
        const progressBar = document.getElementById('analysisProgressBar');
        const statusText = document.getElementById('analysisStatus');
        
        progressDiv.style.display = 'block';
        progressBar.style.width = '0%';
        
        // Get parameters
        const params = {
          drawingType: document.getElementById('drawingTypeSelect').value,
          scale: document.getElementById('drawingScale').value,
          building: document.getElementById('buildingName').value,
          floor: document.getElementById('floorLevel').value,
          rooms: document.getElementById('roomNumbers').value,
          measureWalls: document.getElementById('measureWalls').checked,
          measureFloors: document.getElementById('measureFloors').checked,
          measureCeilings: document.getElementById('measureCeilings').checked,
          measureDoors: document.getElementById('measureDoors').checked,
          measureWindows: document.getElementById('measureWindows').checked,
          measureFixtures: document.getElementById('measureFixtures').checked,
          wallFinish: document.getElementById('wallFinish').value,
          ceilingFinish: document.getElementById('ceilingFinish').value,
          floorFinish: document.getElementById('floorFinish').value,
          coatsRequired: document.getElementById('coatsRequired').value,
          ceilingHeight: 10, // Default ceiling height
          doorCount: 0,
          windowCount: 0
        };
        
        try {
          // Check if DrawingAnalyzerAI is available
          if (window.DrawingAnalyzerAI) {
            console.log('Using Azure AI for drawing analysis...');
            
            // Initialize the AI analyzer with Azure config
            const analyzer = new window.DrawingAnalyzerAI(AZURE_AI_CONFIG);
            
            // Update progress indicators
            statusText.textContent = 'Connecting to Azure AI services...';
            progressBar.style.width = '10%';
            
            // Perform actual AI analysis
            const aiAnalysis = await analyzer.analyzeDrawing(
              window.currentDrawing.data,
              window.currentDrawing.name,
              params
            );
            
            // Convert AI results to display format
            const results = {
              summary: aiAnalysis.summary,
              measurements: aiAnalysis.results.calculations || {},
              rooms: aiAnalysis.results.rooms || [],
              confidence: aiAnalysis.summary.confidence || 0,
              recommendations: aiAnalysis.summary.recommendations || [],
              rawAnalysis: aiAnalysis // Store full analysis for reference
            };
            
            // Update with paint requirements if calculated
            if (aiAnalysis.results.calculations?.materials) {
              const paintMaterial = aiAnalysis.results.calculations.materials.find(m => m.type.includes('Paint'));
              if (paintMaterial) {
                results.paintRequirements = {
                  wallFinish: params.wallFinish,
                  wallArea: paintMaterial.coverage,
                  coats: params.coatsRequired || 2,
                  gallonsRequired: paintMaterial.quantity,
                  estimatedCost: paintMaterial.estimatedCost
                };
              }
            }
            
            // Display AI-powered results
            displayTakeoffResults(results);
            
            // Store for estimate integration
            window.currentTakeoffResults = results;
            
            // Show confidence indicator
            if (results.confidence < 50) {
              addSystemMessage(`⚠️ Analysis confidence: ${results.confidence}%. Please verify measurements manually.`);
            } else {
              addSystemMessage(`✅ AI analysis complete with ${results.confidence}% confidence.`);
            }
            
          } else {
            console.log('AI analyzer not available, using simulation...');
            
            // Fallback to simulation if AI not available
            const steps = [
              { text: 'Simulating text extraction...', progress: 20 },
              { text: 'Simulating layout detection...', progress: 40 },
              { text: 'Simulating door/window identification...', progress: 60 },
              { text: 'Calculating simulated measurements...', progress: 80 },
              { text: 'Generating simulated report...', progress: 100 }
            ];
            
            for (const step of steps) {
              statusText.textContent = step.text;
              progressBar.style.width = step.progress + '%';
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Generate mock results as fallback
            const results = generateMockTakeoffResults(params);
            displayTakeoffResults(results);
            
            addSystemMessage('ℹ️ Using simulated analysis. For actual AI-powered analysis, ensure Azure services are configured.');
          }
          
          // Switch to results tab
          switchTakeoffTab('results');
          
          // Hide progress
          setTimeout(() => {
            progressDiv.style.display = 'none';
          }, 500);
          
        } catch (error) {
          console.error('Error analyzing drawing:', error);
          
          // Provide helpful error message based on error type
          let errorMessage = 'Failed to analyze drawing: ';
          if (error.message.includes('401') || error.message.includes('403')) {
            errorMessage += 'Azure API authentication failed. Please check API keys.';
          } else if (error.message.includes('network')) {
            errorMessage += 'Network error. Please check your connection.';
          } else {
            errorMessage += error.message;
          }
          
          alert(errorMessage);
          progressDiv.style.display = 'none';
        }
      }
      
      // Generate mock takeoff results (replace with actual AI analysis)
      function generateMockTakeoffResults(params) {
        const results = {
          summary: {
            building: params.building || 'Building A',
            floor: params.floor || 'Level 1',
            drawingType: params.drawingType,
            scale: params.scale || '1/4" = 1\'',
            analyzedAt: new Date().toISOString()
          },
          measurements: {},
          details: []
        };
        
        if (params.measureWalls) {
          results.measurements.walls = {
            total: Math.floor(Math.random() * 500 + 200),
            unit: 'linear feet',
            breakdown: [
              { room: 'Room 101', value: 85 },
              { room: 'Room 102', value: 92 },
              { room: 'Corridor', value: 145 },
              { room: 'Room 103', value: 78 }
            ]
          };
        }
        
        if (params.measureFloors) {
          results.measurements.floors = {
            total: Math.floor(Math.random() * 3000 + 1500),
            unit: 'square feet',
            breakdown: [
              { room: 'Room 101', value: 450 },
              { room: 'Room 102', value: 520 },
              { room: 'Corridor', value: 380 },
              { room: 'Room 103', value: 410 }
            ]
          };
        }
        
        if (params.measureCeilings) {
          results.measurements.ceilings = results.measurements.floors; // Same as floor area
        }
        
        if (params.measureDoors) {
          results.measurements.doors = {
            total: Math.floor(Math.random() * 15 + 8),
            unit: 'count',
            types: [
              { type: 'Single 3\'-0" x 7\'-0"', count: 8 },
              { type: 'Double 6\'-0" x 7\'-0"', count: 2 },
              { type: 'Single 2\'-8" x 6\'-8"', count: 4 }
            ]
          };
        }
        
        if (params.measureWindows) {
          results.measurements.windows = {
            total: Math.floor(Math.random() * 20 + 10),
            unit: 'count',
            types: [
              { type: '4\'-0" x 5\'-0"', count: 12 },
              { type: '3\'-0" x 4\'-0"', count: 6 },
              { type: '6\'-0" x 4\'-0"', count: 4 }
            ]
          };
        }
        
        // Calculate paint requirements
        if (params.wallFinish && results.measurements.walls) {
          const wallArea = results.measurements.walls.total * 10; // Assume 10' height
          const coats = parseInt(params.coatsRequired) || 2;
          const coverage = 350; // sq ft per gallon
          const gallons = Math.ceil((wallArea * coats) / coverage);
          
          results.paintRequirements = {
            wallFinish: params.wallFinish,
            wallArea: wallArea,
            coats: coats,
            gallonsRequired: gallons,
            estimatedCost: gallons * 35 // $35 per gallon average
          };
        }
        
        return results;
      }
      
      // Display takeoff results
      function displayTakeoffResults(results) {
        const resultsDiv = document.getElementById('takeoffResults');
        if (!resultsDiv) return;
        
        let html = `
          <div style="padding: 1rem;">
            <!-- Summary -->
            <div style="
              background: linear-gradient(135deg, #e8f4fd, #bbdefb);
              padding: 1rem;
              border-radius: 8px;
              margin-bottom: 1.5rem;
            ">
              <h4 style="margin: 0 0 0.75rem 0; color: var(--blueprint-blue);">Summary</h4>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.9rem;">
                <div><strong>Building:</strong> ${results.summary.building}</div>
                <div><strong>Floor:</strong> ${results.summary.floor}</div>
                <div><strong>Drawing Type:</strong> ${results.summary.drawingType}</div>
                <div><strong>Scale:</strong> ${results.summary.scale}</div>
              </div>
            </div>
            
            <!-- Measurements -->
            <h4 style="margin: 0 0 1rem 0; color: var(--concrete-gray);">Measurements</h4>
        `;
        
        // Add each measurement category
        for (const [key, data] of Object.entries(results.measurements)) {
          html += `
            <div style="
              background: white;
              border: 1px solid #e0e0e0;
              border-radius: 6px;
              padding: 1rem;
              margin-bottom: 1rem;
            ">
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
              ">
                <h5 style="margin: 0; text-transform: capitalize; color: #666;">${key}</h5>
                <span style="
                  font-size: 1.2rem;
                  font-weight: bold;
                  color: var(--spreadsheet-green);
                ">${data.total} ${data.unit}</span>
              </div>
          `;
          
          if (data.breakdown) {
            html += '<div style="font-size: 0.85rem; color: #666;">';
            data.breakdown.forEach(item => {
              html += `
                <div style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.25rem 0;
                  border-bottom: 1px solid #f0f0f0;
                ">
                  <span>${item.room}</span>
                  <span>${item.value} ${data.unit.includes('feet') ? 'ft' : data.unit}</span>
                </div>
              `;
            });
            html += '</div>';
          }
          
          if (data.types) {
            html += '<div style="font-size: 0.85rem; color: #666;">';
            data.types.forEach(type => {
              html += `
                <div style="
                  display: flex;
                  justify-content: space-between;
                  padding: 0.25rem 0;
                  border-bottom: 1px solid #f0f0f0;
                ">
                  <span>${type.type}</span>
                  <span>${type.count}</span>
                </div>
              `;
            });
            html += '</div>';
          }
          
          html += '</div>';
        }
        
        // Add paint requirements if calculated
        if (results.paintRequirements) {
          html += `
            <div style="
              background: linear-gradient(135deg, #fff3cd, #ffeaa7);
              border: 1px solid #ffc107;
              border-radius: 6px;
              padding: 1rem;
              margin-top: 1.5rem;
            ">
              <h5 style="margin: 0 0 0.75rem 0; color: #856404;">Paint Requirements</h5>
              <div style="font-size: 0.9rem; color: #856404;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Wall Finish:</span>
                  <strong>${results.paintRequirements.wallFinish}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Wall Area:</span>
                  <strong>${results.paintRequirements.wallArea} sq ft</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Coats Required:</span>
                  <strong>${results.paintRequirements.coats}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                  <span>Gallons Required:</span>
                  <strong>${results.paintRequirements.gallonsRequired}</strong>
                </div>
                <div style="
                  display: flex;
                  justify-content: space-between;
                  margin-top: 0.5rem;
                  padding-top: 0.5rem;
                  border-top: 1px solid #ffc107;
                  font-weight: bold;
                ">
                  <span>Estimated Cost:</span>
                  <span>$${results.paintRequirements.estimatedCost.toLocaleString()}</span>
                </div>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        resultsDiv.innerHTML = html;
        
        // Store results for export
        window.currentTakeoffResults = results;
      }
      
      // Open Cost Calculator
      window.openCostCalculator = function() {
        // Send a message to the chat to invoke the cost calculator
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        
        if (chatInput && sendButton) {
          // Set the message to trigger the calculator
          chatInput.value = "Open the construction cost calculator";
          
          // Send the message
          sendMessage();
          
          // Clear the input after a short delay
          setTimeout(() => {
            chatInput.value = '';
          }, 100);
          
          // Provide feedback
          addSystemMessage('🧮 Requesting Construction Cost Calculator from the AI assistant...');
        } else {
          alert('Chat system is not available. Please refresh the page.');
        }
      }
      
      // Export results to Excel
      window.exportToExcel = function() {
        if (!window.currentTakeoffResults) {
          alert('No results to export');
          return;
        }
        
        const results = window.currentTakeoffResults;
        
        // Create CSV content
        let csv = 'Digital Takeoff Report\n';
        csv += `Building,${results.summary.building}\n`;
        csv += `Floor,${results.summary.floor}\n`;
        csv += `Drawing Type,${results.summary.drawingType}\n`;
        csv += `Scale,${results.summary.scale}\n`;
        csv += `Analyzed At,${new Date(results.summary.analyzedAt).toLocaleString()}\n`;
        csv += '\n';
        
        // Add measurements
        csv += 'Measurement Type,Total,Unit\n';
        for (const [key, data] of Object.entries(results.measurements)) {
          csv += `${key},${data.total},${data.unit}\n`;
        }
        csv += '\n';
        
        // Add detailed breakdowns
        for (const [key, data] of Object.entries(results.measurements)) {
          if (data.breakdown) {
            csv += `\n${key} Breakdown\n`;
            csv += 'Location,Value\n';
            data.breakdown.forEach(item => {
              csv += `${item.room},${item.value}\n`;
            });
          }
          if (data.types) {
            csv += `\n${key} Types\n`;
            csv += 'Type,Count\n';
            data.types.forEach(type => {
              csv += `${type.type},${type.count}\n`;
            });
          }
        }
        
        // Add paint requirements
        if (results.paintRequirements) {
          csv += '\nPaint Requirements\n';
          csv += `Wall Finish,${results.paintRequirements.wallFinish}\n`;
          csv += `Wall Area,${results.paintRequirements.wallArea} sq ft\n`;
          csv += `Coats Required,${results.paintRequirements.coats}\n`;
          csv += `Gallons Required,${results.paintRequirements.gallonsRequired}\n`;
          csv += `Estimated Cost,$${results.paintRequirements.estimatedCost}\n`;
        }
        
        // Create and download file
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `takeoff_${results.summary.building}_${results.summary.floor}_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        addSystemMessage('✅ Takeoff results exported to Excel successfully!');
      }
    }  // This was missing
    </script>
    
    <!-- Digital Takeoff Complete Implementation -->
    <script src="js/digital-takeoff-complete.js"></script>
    
    <!-- Enhanced Digital Takeoff with Annotation Capabilities -->
    <script src="js/digital-takeoff-enhanced.js"></script>
    
    <!-- Professional Digital Takeoff Assistant -->
    <script src="js/digital-takeoff-professional.js"></script>
    
    <!-- Fix for missing button functions -->
    <script src="js/estimator-functions-fix.js"></script>
    
    <!-- Comprehensive final fixes -->
    <script src="js/comprehensive-final-fix.js"></script>
    
    <!-- Emergency Fix Script -->
    <script src="js/emergency-fix.js"></script>
    
<!-- Module Integration -->
<script type="module">
import ForemanAI from './js/modules/app-integrator.js';

// Initialize ForemanAI for estimator page
document.addEventListener('DOMContentLoaded', async () => {
    await ForemanAI.initialize('estimator');
    
    // Make ForemanAI available globally for legacy code
    window.app = ForemanAI;
    
    console.log('✅ ForemanAI Estimator Module Loaded');
});
</script>

</body>
</html>

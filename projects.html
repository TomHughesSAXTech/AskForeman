<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ForemanAI - Project Management</title>
    
    <!-- Mobile Detection and Redirection -->
    <script>
      (function() {
        // Function to detect mobile devices
        function isMobileDevice() {
          const userAgent = navigator.userAgent || navigator.vendor || window.opera;
          const mobileRegex = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i;
          const screenWidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
          const isMobileScreen = screenWidth <= 768;
          const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
          return mobileRegex.test(userAgent.toLowerCase()) && (isMobileScreen || isTouchDevice);
        }
        
        function getUrlParameter(name) {
          name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
          const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
          const results = regex.exec(location.search);
          return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        const forceDesktop = getUrlParameter('desktop') === 'true';
        const forceMobile = getUrlParameter('mobile') === 'true';
        
        if (forceDesktop) {
          localStorage.setItem('viewPreference', 'desktop');
        } else if (forceMobile) {
          localStorage.setItem('viewPreference', 'mobile');
        }
        
        const viewPreference = localStorage.getItem('viewPreference');
        
        if (!forceDesktop && (forceMobile || (isMobileDevice() && viewPreference !== 'desktop'))) {
          window.location.replace('https://gentle-pond-0c4e3b90f.2.azurestaticapps.net/m.html');
        }
      })();
    </script>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        /* Project Management Theme Colors */
        --pm-primary: #2E86AB;
        --pm-secondary: #26C485;
        --pm-accent: #F6AE2D;
        --milestone-purple: #7B68EE;
        --schedule-orange: #FF8C42;
        --resource-teal: #20B2AA;
        --risk-red: #DC3545;
        --budget-green: #28A745;
        --gantt-blue: #1565C0;
        --progress-yellow: #FFC107;
        
        /* Standard Colors */
        --construction-orange: #ff6b35;
        --safety-yellow: #ffc107;
        --concrete-gray: #424242;
        --steel-gray: #616161;
        --blueprint-blue: #1565c0;
        --hi-vis-green: #76ff03;
        --warning-red: #d32f2f;
        --white: #ffffff;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --dark-gray: #212121;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0f3443 0%, #34e89e 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 35px,
            rgba(38, 196, 133, 0.03) 35px,
            rgba(38, 196, 133, 0.03) 70px
          ),
          repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 35px,
            rgba(46, 134, 171, 0.03) 35px,
            rgba(46, 134, 171, 0.03) 70px
          );
        pointer-events: none;
      }

      .header {
        background: linear-gradient(135deg, var(--dark-gray) 0%, #0f3443 100%);
        color: white;
        padding: 1rem 2rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--pm-secondary);
        position: relative;
        z-index: 10;
      }

      .header::before {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 4px;
        background: repeating-linear-gradient(
          90deg,
          var(--pm-accent) 0px,
          var(--pm-accent) 20px,
          var(--dark-gray) 20px,
          var(--dark-gray) 40px
        );
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .logo-icon {
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        overflow: hidden;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      
      .page-logo {
        width: 60px;
        height: 60px;
        object-fit: contain;
        margin-right: 1rem;
      }

      .logo h1 {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--pm-secondary);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
      }

      .logo .tagline {
        font-size: 1rem;
        color: var(--medium-gray);
        font-weight: 500;
        margin-top: -0.25rem;
      }

      .nav-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--pm-accent), #f57f17);
        color: var(--dark-gray);
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(38, 196, 133, 0.1);
        border: 2px solid var(--pm-secondary);
        border-radius: 20px;
        position: relative;
        cursor: help;
        transition: all 0.3s ease;
      }
      
      .status-indicator:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(38, 196, 133, 0.3);
      }

      .status-dot {
        width: 10px;
        height: 10px;
        background: var(--pm-secondary);
        border-radius: 50%;
        animation: pulse 2s infinite;
        box-shadow: 0 0 10px var(--pm-secondary);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.2);
        }
      }

      .container {
        flex: 1;
        display: grid;
        grid-template-columns: 400px 1fr 400px;
        gap: 2rem;
        padding: 2rem;
        max-width: 1800px;
        margin: 0 auto;
        width: 100%;
        position: relative;
        z-index: 1;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      
      .rightbar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--medium-gray);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--pm-primary);
      }

      .project-selector {
        margin-bottom: 1rem;
        padding: 1rem;
        background: linear-gradient(135deg, var(--light-gray) 0%, var(--white) 100%);
        border-radius: 8px;
        border: 2px solid var(--pm-primary);
      }

      .project-selector label {
        display: block;
        font-weight: 600;
        color: var(--concrete-gray);
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .project-selector select {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 1rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .project-selector select:hover {
        border-color: var(--pm-primary);
      }

      .project-selector select:focus {
        outline: none;
        border-color: var(--pm-primary);
        box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
      }

      /* Project Status Dashboard */
      .project-status-dashboard {
        margin-top: 1.5rem;
      }

      .project-status-dashboard h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .project-status-dashboard h3::before {
        content: "📊";
        font-size: 1.5rem;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .status-card {
        padding: 1rem;
        background: linear-gradient(135deg, var(--light-gray) 0%, var(--white) 100%);
        border-radius: 8px;
        border-left: 4px solid var(--pm-primary);
        transition: all 0.3s ease;
      }

      .status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .status-card.on-track {
        border-left-color: var(--budget-green);
      }

      .status-card.at-risk {
        border-left-color: var(--schedule-orange);
      }

      .status-card.delayed {
        border-left-color: var(--risk-red);
      }

      .status-label {
        font-size: 0.85rem;
        color: var(--steel-gray);
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--dark-gray);
      }

      .status-trend {
        font-size: 0.8rem;
        color: var(--concrete-gray);
        margin-top: 0.25rem;
      }

      .status-trend.positive {
        color: var(--budget-green);
      }

      .status-trend.negative {
        color: var(--risk-red);
      }

      /* Milestone Tracker */
      .milestone-tracker {
        margin-top: 1.5rem;
      }

      .milestone-tracker h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .milestone-tracker h3::before {
        content: "🎯";
        font-size: 1.5rem;
      }

      .milestone-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .milestone-item {
        padding: 0.75rem;
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
      }

      .milestone-item:hover {
        border-color: var(--milestone-purple);
        box-shadow: 0 2px 8px rgba(123, 104, 238, 0.2);
      }

      .milestone-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .milestone-icon.completed {
        background: var(--budget-green);
        color: white;
      }

      .milestone-icon.in-progress {
        background: var(--progress-yellow);
        color: var(--dark-gray);
      }

      .milestone-icon.upcoming {
        background: var(--medium-gray);
        color: var(--steel-gray);
      }

      .milestone-details {
        flex: 1;
      }

      .milestone-name {
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 0.25rem;
      }

      .milestone-date {
        font-size: 0.85rem;
        color: var(--steel-gray);
      }

      .milestone-progress {
        width: 60px;
        height: 60px;
        position: relative;
      }

      .progress-ring {
        transform: rotate(-90deg);
      }

      .progress-ring-circle {
        stroke-dasharray: 157;
        stroke-dashoffset: 157;
        transition: stroke-dashoffset 0.5s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--dark-gray);
      }

      /* Chat Container */
      .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
        position: relative;
      }

      .chat-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--pm-primary);
      }

      .chat-header {
        background: linear-gradient(135deg, var(--pm-primary) 0%, var(--pm-secondary) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--pm-accent);
      }

      .chat-header h2 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .chat-header h2::before {
        content: "👔";
        font-size: 1.8rem;
      }

      .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        display: flex;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.assistant .message-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--pm-primary) 0%, var(--pm-secondary) 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        font-size: 20px;
        color: white;
      }

      .message-content {
        max-width: 70%;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, var(--pm-primary) 0%, var(--pm-secondary) 100%);
        color: white;
        border-bottom-right-radius: 3px;
      }

      .message.user .message-time {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
      }

      .message.assistant .message-content {
        background: white;
        color: var(--concrete-gray);
        border-bottom-left-radius: 3px;
        border: 1px solid var(--medium-gray);
      }

      .formatted-content {
        line-height: 1.6;
        word-wrap: break-word;
      }

      .formatted-content a {
        color: var(--blueprint-blue);
        text-decoration: underline;
        word-break: break-all;
        transition: color 0.2s ease;
      }

      .formatted-content a:hover {
        color: var(--pm-primary);
      }

      .message-time {
        font-size: 0.75rem;
        color: #95a5a6;
        margin-top: 0.5rem;
      }

      .chat-input-container {
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 10px 10px;
        border-top: 2px solid var(--medium-gray);
      }

      .ai-disclaimer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--dark-gray);
      }

      .disclaimer-icon {
        font-size: 1rem;
        flex-shrink: 0;
      }

      .disclaimer-text {
        line-height: 1.4;
      }

      .disclaimer-text strong {
        color: #d68910;
        font-weight: 600;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .chat-context-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: var(--light-gray);
        border-radius: 8px;
        border: 1px solid var(--medium-gray);
      }

      .chat-context-selector label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--concrete-gray);
        white-space: nowrap;
      }

      .chat-context-selector select {
        padding: 0.5rem;
        border: 1px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
      }

      .chat-context-selector select:hover {
        border-color: var(--pm-primary);
      }

      .chat-context-selector select:focus {
        outline: none;
        border-color: var(--pm-primary);
        box-shadow: 0 0 0 2px rgba(46, 134, 171, 0.1);
      }

      .chat-input-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        width: 100%;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--medium-gray);
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--pm-primary);
        box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
      }

      .send-button {
        background: linear-gradient(135deg, var(--pm-primary) 0%, var(--pm-secondary) 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(46, 134, 171, 0.3);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        width: fit-content;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-left: 3.5rem;
      }

      .typing-indicator.active {
        display: flex;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--pm-primary);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      /* Team Members Panel */
      .team-panel {
        margin-top: 1.5rem;
      }

      .team-panel h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .team-panel h3::before {
        content: "👥";
        font-size: 1.5rem;
      }

      .team-member-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .team-member {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border: 1px solid var(--medium-gray);
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .team-member:hover {
        border-color: var(--resource-teal);
        box-shadow: 0 2px 8px rgba(32, 178, 170, 0.2);
      }

      .member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--resource-teal), var(--pm-secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .member-info {
        flex: 1;
      }

      .member-name {
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 0.15rem;
      }

      .member-role {
        font-size: 0.85rem;
        color: var(--steel-gray);
      }

      .member-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--budget-green);
        box-shadow: 0 0 4px var(--budget-green);
      }

      .member-status.busy {
        background: var(--schedule-orange);
        box-shadow: 0 0 4px var(--schedule-orange);
      }

      .member-status.offline {
        background: var(--medium-gray);
        box-shadow: none;
      }

      /* Gantt Chart Preview */
      .gantt-preview {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background: white;
        border-radius: 10px;
        border: 2px solid var(--gantt-blue);
        box-shadow: var(--shadow-lg);
      }

      .gantt-preview h3 {
        margin-bottom: 1rem;
        color: var(--concrete-gray);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .gantt-preview h3::before {
        content: "📅";
        font-size: 1.5rem;
      }

      .gantt-chart {
        position: relative;
        height: 200px;
        background: linear-gradient(to right, 
          var(--light-gray) 0%, 
          var(--light-gray) 50%, 
          white 50%, 
          white 100%);
        background-size: 40px 100%;
        border: 1px solid var(--medium-gray);
        border-radius: 4px;
        overflow: hidden;
      }

      .gantt-task {
        position: absolute;
        height: 30px;
        background: linear-gradient(135deg, var(--gantt-blue), var(--pm-primary));
        border-radius: 4px;
        display: flex;
        align-items: center;
        padding: 0 0.5rem;
        color: white;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .gantt-task:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 10;
      }

      .gantt-task.critical {
        background: linear-gradient(135deg, var(--risk-red), #c62828);
      }

      .gantt-task.completed {
        background: linear-gradient(135deg, var(--budget-green), #2e7d32);
      }

      /* Resource Allocation */
      .resource-allocation {
        margin-top: 1rem;
      }

      .resource-allocation h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .resource-allocation h3::before {
        content: "⚙️";
        font-size: 1.5rem;
      }

      .resource-chart {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .resource-bar {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .resource-label {
        width: 100px;
        font-size: 0.9rem;
        color: var(--steel-gray);
        font-weight: 500;
      }

      .resource-progress {
        flex: 1;
        height: 24px;
        background: var(--light-gray);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
      }

      .resource-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--resource-teal), var(--pm-secondary));
        border-radius: 12px;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 0.5rem;
      }

      .resource-fill.high {
        background: linear-gradient(90deg, var(--schedule-orange), var(--risk-red));
      }

      .resource-fill.optimal {
        background: linear-gradient(90deg, var(--budget-green), var(--pm-secondary));
      }

      .resource-percentage {
        color: white;
        font-size: 0.75rem;
        font-weight: bold;
      }

      /* Process Button */
      .process-button {
        width: 100%;
        background: linear-gradient(135deg, var(--pm-secondary) 0%, var(--resource-teal) 100%);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 4px 8px rgba(38, 196, 133, 0.3);
      }

      .process-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(38, 196, 133, 0.4);
      }

      .process-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .error-message {
        background: linear-gradient(135deg, var(--risk-red), #b71c1c);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
      }

      .error-message.show {
        display: block;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }

        .sidebar {
          order: 2;
        }

        .chat-container {
          height: 500px;
          order: 1;
        }

        .message-content {
          max-width: 85%;
        }

        .logo-icon {
          width: 80px;
          height: 80px;
        }

        .logo h1 {
          font-size: 1.8rem;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <img src="pm.png" alt="Project Management" />
        </div>
        <div>
          <h1>ASK FOREMAN AI</h1>
          <p class="tagline">Project Management Assistant</p>
        </div>
      </div>
      <div class="nav-buttons">
        <a href="index.html" class="nav-btn">🏠 Home</a>
        <a href="general-chat.html" class="nav-btn">💬 General</a>
        <a href="estimator.html" class="nav-btn">📊 Estimating</a>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <div class="card">
          <div class="project-selector">
            <label for="projectSelect">🏢 Select Project:</label>
            <select id="projectSelect">
              <option value="">-- Choose a Project --</option>
            </select>
          </div>

          <!-- Project Status Dashboard -->
          <div class="project-status-dashboard">
            <h3>Project Status</h3>
            <div class="status-grid">
              <div class="status-card on-track">
                <div class="status-label">Schedule</div>
                <div class="status-value">On Track</div>
                <div class="status-trend positive">↑ 2 days ahead</div>
              </div>
              <div class="status-card on-track">
                <div class="status-label">Budget</div>
                <div class="status-value">$2.4M</div>
                <div class="status-trend positive">85% utilized</div>
              </div>
              <div class="status-card at-risk">
                <div class="status-label">Resources</div>
                <div class="status-value">92%</div>
                <div class="status-trend negative">Near capacity</div>
              </div>
              <div class="status-card on-track">
                <div class="status-label">Quality</div>
                <div class="status-value">98%</div>
                <div class="status-trend positive">Exceeding target</div>
              </div>
            </div>
          </div>

          <!-- Milestone Tracker -->
          <div class="milestone-tracker">
            <h3>Key Milestones</h3>
            <div class="milestone-list">
              <div class="milestone-item">
                <div class="milestone-icon completed">✓</div>
                <div class="milestone-details">
                  <div class="milestone-name">Foundation Complete</div>
                  <div class="milestone-date">Completed: Jan 15, 2025</div>
                </div>
                <div class="milestone-progress">
                  <svg width="60" height="60">
                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e0e0e0" stroke-width="5"/>
                    <circle class="progress-ring-circle" cx="30" cy="30" r="25" fill="none" 
                            stroke="#28A745" stroke-width="5" 
                            style="stroke-dashoffset: 0;"/>
                  </svg>
                  <div class="progress-text">100%</div>
                </div>
              </div>
              
              <div class="milestone-item">
                <div class="milestone-icon in-progress">⚡</div>
                <div class="milestone-details">
                  <div class="milestone-name">Structural Steel</div>
                  <div class="milestone-date">Due: Feb 28, 2025</div>
                </div>
                <div class="milestone-progress">
                  <svg width="60" height="60">
                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e0e0e0" stroke-width="5"/>
                    <circle class="progress-ring-circle" cx="30" cy="30" r="25" fill="none" 
                            stroke="#FFC107" stroke-width="5" 
                            style="stroke-dashoffset: 47;"/>
                  </svg>
                  <div class="progress-text">70%</div>
                </div>
              </div>
              
              <div class="milestone-item">
                <div class="milestone-icon upcoming">🎯</div>
                <div class="milestone-details">
                  <div class="milestone-name">MEP Installation</div>
                  <div class="milestone-date">Due: Apr 15, 2025</div>
                </div>
                <div class="milestone-progress">
                  <svg width="60" height="60">
                    <circle cx="30" cy="30" r="25" fill="none" stroke="#e0e0e0" stroke-width="5"/>
                    <circle class="progress-ring-circle" cx="30" cy="30" r="25" fill="none" 
                            stroke="#e0e0e0" stroke-width="5" 
                            style="stroke-dashoffset: 157;"/>
                  </svg>
                  <div class="progress-text">0%</div>
                </div>
              </div>
            </div>
          </div>

          <button class="process-button" id="createProjectButton">
            ➕ Create New Project
          </button>
        </div>

        <!-- Team Members Panel -->
        <div class="card team-panel">
          <h3>Project Team</h3>
          <div class="team-member-list">
            <div class="team-member">
              <div class="member-avatar">JD</div>
              <div class="member-info">
                <div class="member-name">John Doe</div>
                <div class="member-role">Project Manager</div>
              </div>
              <div class="member-status"></div>
            </div>
            
            <div class="team-member">
              <div class="member-avatar">SM</div>
              <div class="member-info">
                <div class="member-name">Sarah Miller</div>
                <div class="member-role">Site Supervisor</div>
              </div>
              <div class="member-status"></div>
            </div>
            
            <div class="team-member">
              <div class="member-avatar">BC</div>
              <div class="member-info">
                <div class="member-name">Bob Chen</div>
                <div class="member-role">Lead Engineer</div>
              </div>
              <div class="member-status busy"></div>
            </div>
            
            <div class="team-member">
              <div class="member-avatar">AJ</div>
              <div class="member-info">
                <div class="member-name">Amy Johnson</div>
                <div class="member-role">Safety Coordinator</div>
              </div>
              <div class="member-status offline"></div>
            </div>
          </div>
        </div>
      </aside>

      <main class="card chat-container">
        <div class="chat-header">
          <h2>Project Management Assistant</h2>
          <span style="font-size: 0.9rem; opacity: 0.8">Powered by SAX Technology Advisors</span>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-avatar">📊</div>
            <div class="message-content">
              <div class="formatted-content">
                <p><strong>Welcome to your Project Management Command Center!</strong></p>
                <p>
                  I'm your AI Project Manager, here to help with:
                  <span class="capabilities-btn" style="
                    display: inline-block;
                    margin-left: 0.5rem;
                    padding: 0.2rem 0.6rem;
                    background: linear-gradient(135deg, var(--pm-primary), var(--pm-secondary));
                    color: white;
                    border-radius: 12px;
                    font-size: 0.85rem;
                    cursor: help;
                    position: relative;
                    font-weight: 500;
                    transition: all 0.2s ease;
                  ">
                    View Capabilities
                    <div class="capabilities-dropdown" style="
                      position: absolute;
                      bottom: 100%;
                      left: 50%;
                      transform: translateX(-50%) translateY(-10px);
                      background: white;
                      border: 2px solid var(--pm-primary);
                      border-radius: 8px;
                      padding: 1rem;
                      min-width: 320px;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                      display: none;
                      z-index: 1000;
                      color: var(--concrete-gray);
                      font-weight: normal;
                      font-size: 0.9rem;
                      line-height: 1.5;
                    ">
                      <div style="
                        position: absolute;
                        bottom: -6px;
                        left: 50%;
                        transform: translateX(-50%);
                        width: 12px;
                        height: 12px;
                        background: white;
                        border-right: 2px solid var(--pm-primary);
                        border-bottom: 2px solid var(--pm-primary);
                        transform: translateX(-50%) rotate(45deg);
                      "></div>
                      <h4 style="margin: 0 0 0.75rem 0; color: var(--pm-primary); font-size: 1rem;">🛠️ I can help with:</h4>
                      <ul style="margin: 0; padding-left: 1.2rem; list-style: none;">
                        <li style="margin: 0.4rem 0;">📅 Schedule management and critical path analysis</li>
                        <li style="margin: 0.4rem 0;">💰 Budget tracking and cost control</li>
                        <li style="margin: 0.4rem 0;">👥 Resource allocation and team management</li>
                        <li style="margin: 0.4rem 0;">📊 Progress reporting and KPI monitoring</li>
                        <li style="margin: 0.4rem 0;">⚠️ Risk assessment and mitigation planning</li>
                        <li style="margin: 0.4rem 0;">📋 Change order management</li>
                        <li style="margin: 0.4rem 0;">🔄 Stakeholder communication and updates</li>
                      </ul>
                    </div>
                  </span>
                </p>
                <p>
                  <strong>💡 Pro tip:</strong> Use the "Focus on" dropdown below to target specific aspects of your project like schedule, budget, or resources.
                </p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <div class="chat-context-selector">
              <label for="chatProjectSelect">🎯 Focus on:</label>
              <select id="chatProjectSelect">
                <option value="general">General Project Management</option>
                <option value="schedule">Schedule & Timeline</option>
                <option value="budget">Budget & Cost Control</option>
                <option value="resources">Resource Management</option>
                <option value="risks">Risk Analysis</option>
                <option value="quality">Quality Control</option>
                <option value="stakeholder">Stakeholder Communication</option>
              </select>
            </div>
            <div class="chat-input-row">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Ask about project schedules, budgets, resources, risks, or any management questions..."
              />
              <button class="send-button" id="sendButton">
                <span>Send</span>
                <span>→</span>
              </button>
            </div>
          </div>

          <!-- AI Disclaimer -->
          <div class="ai-disclaimer">
            <span class="disclaimer-icon">⚠️</span>
            <span class="disclaimer-text">
              Ask Foreman AI <strong>can make mistakes</strong> and you should verify important information.
            </span>
          </div>
        </div>
      </main>

      <!-- Right Sidebar -->
      <aside class="rightbar">
        <!-- Gantt Chart Preview -->
        <div class="card gantt-preview">
          <h3>Project Timeline</h3>
          <div class="gantt-chart">
            <div class="gantt-task completed" style="top: 20px; left: 10px; width: 120px;">Foundation</div>
            <div class="gantt-task" style="top: 60px; left: 100px; width: 150px;">Structural</div>
            <div class="gantt-task" style="top: 100px; left: 200px; width: 100px;">MEP</div>
            <div class="gantt-task critical" style="top: 140px; left: 250px; width: 80px;">Critical Path</div>
          </div>
          <a href="https://workflows.saxtechnology.com/webhook/ask-foreman/tools/gantt-chart" 
             target="_blank" 
             style="
               display: inline-block;
               margin-top: 1rem;
               padding: 0.75rem 1.5rem;
               background: linear-gradient(135deg, var(--gantt-blue), var(--pm-primary));
               color: white;
               text-decoration: none;
               border-radius: 8px;
               font-weight: 600;
               transition: all 0.3s ease;
             "
             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(21, 101, 192, 0.3)';"
             onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            📊 Open Full Gantt Chart
          </a>
        </div>

        <!-- Resource Allocation -->
        <div class="card resource-allocation">
          <h3>Resource Utilization</h3>
          <div class="resource-chart">
            <div class="resource-bar">
              <div class="resource-label">Labor</div>
              <div class="resource-progress">
                <div class="resource-fill high" style="width: 92%;">
                  <span class="resource-percentage">92%</span>
                </div>
              </div>
            </div>
            
            <div class="resource-bar">
              <div class="resource-label">Equipment</div>
              <div class="resource-progress">
                <div class="resource-fill optimal" style="width: 75%;">
                  <span class="resource-percentage">75%</span>
                </div>
              </div>
            </div>
            
            <div class="resource-bar">
              <div class="resource-label">Materials</div>
              <div class="resource-progress">
                <div class="resource-fill optimal" style="width: 68%;">
                  <span class="resource-percentage">68%</span>
                </div>
              </div>
            </div>
            
            <div class="resource-bar">
              <div class="resource-label">Budget</div>
              <div class="resource-progress">
                <div class="resource-fill optimal" style="width: 85%;">
                  <span class="resource-percentage">85%</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick PM Tools -->
        <div class="card">
          <h3 style="color: var(--concrete-gray); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">🛠️</span> Quick PM Tools
          </h3>
          <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            <a href="https://workflows.saxtechnology.com/webhook/ask-foreman/tools/schedule-optimizer" 
               target="_blank" 
               class="quick-tool-btn" 
               style="
                 display: flex;
                 align-items: center;
                 gap: 0.75rem;
                 padding: 1rem;
                 background: linear-gradient(135deg, var(--milestone-purple) 0%, #6B46C1 100%);
                 color: white;
                 text-decoration: none;
                 border-radius: 8px;
                 transition: all 0.3s ease;
                 border: 2px solid transparent;
               " 
               onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(123, 104, 238, 0.3)';"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
              <span style="font-size: 1.5rem;">⚡</span>
              <div>
                <div style="font-weight: 600; font-size: 1rem;">Schedule Optimizer</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Critical path & timeline analysis</div>
              </div>
            </a>
            
            <a href="https://workflows.saxtechnology.com/webhook/ask-foreman/tools/risk-matrix" 
               target="_blank" 
               class="quick-tool-btn" 
               style="
                 display: flex;
                 align-items: center;
                 gap: 0.75rem;
                 padding: 1rem;
                 background: linear-gradient(135deg, var(--schedule-orange) 0%, #FF6B35 100%);
                 color: white;
                 text-decoration: none;
                 border-radius: 8px;
                 transition: all 0.3s ease;
                 border: 2px solid transparent;
               "
               onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(255, 140, 66, 0.3)';"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
              <span style="font-size: 1.5rem;">⚠️</span>
              <div>
                <div style="font-weight: 600; font-size: 1rem;">Risk Assessment Matrix</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Identify & mitigate project risks</div>
              </div>
            </a>
            
            <a href="https://workflows.saxtechnology.com/webhook/ask-foreman/tools/resource-planner" 
               target="_blank" 
               class="quick-tool-btn" 
               style="
                 display: flex;
                 align-items: center;
                 gap: 0.75rem;
                 padding: 1rem;
                 background: linear-gradient(135deg, var(--resource-teal) 0%, #17A2B8 100%);
                 color: white;
                 text-decoration: none;
                 border-radius: 8px;
                 transition: all 0.3s ease;
                 border: 2px solid transparent;
               "
               onmouseover="this.style.transform='translateX(5px)'; this.style.boxShadow='0 4px 12px rgba(32, 178, 170, 0.3)';"
               onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='none';">
              <span style="font-size: 1.5rem;">👥</span>
              <div>
                <div style="font-weight: 600; font-size: 1rem;">Resource Planner</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">Optimize team & equipment allocation</div>
              </div>
            </a>
          </div>
        </div>

        <!-- PM Knowledge Graph Tips -->
        <div class="card" style="margin-top: 1rem; background: linear-gradient(135deg, #f0f8ff, #e8f4fd); border: 2px solid var(--pm-primary);">
          <h3 style="color: var(--pm-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">💡</span> PM Knowledge Graph
          </h3>
          <div style="font-size: 0.9rem; color: var(--concrete-gray); line-height: 1.6;">
            <p style="margin-bottom: 0.75rem;">
              <strong>Smart Project Insights:</strong> The Knowledge Graph helps you manage projects by:
            </p>
            <ul style="margin-left: 1.5rem; margin-bottom: 0.75rem;">
              <li style="margin-bottom: 0.5rem;">📈 Tracking performance across similar projects</li>
              <li style="margin-bottom: 0.5rem;">⏰ Identifying schedule optimization opportunities</li>
              <li style="margin-bottom: 0.5rem;">💡 Learning from past project successes and challenges</li>
              <li style="margin-bottom: 0.5rem;">🔄 Finding resource allocation patterns</li>
            </ul>
            <p style="margin-bottom: 0.5rem;">
              <strong>Try asking:</strong> <em>"What caused delays in similar projects?"</em> or 
              <em>"Compare resource utilization across our last three projects"</em>
            </p>
          </div>
        </div>
      </aside>
    </div>

    <!-- Project Management Scripts -->
    <script>
      // Configuration - Production webhook URLs
      const API_CONFIG = {
        chatWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/PMchat",
        projectsWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/projects/list",
        createProjectWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/projects/create",
        updateProjectWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/projects/update",
        indexName: "project-management-index",
      };

      // Azure Storage Configuration (for project documents)
      const AZURE_STORAGE = {
        account: "saxtechfcs",
        container: "fcs-clients",  // Using same container as estimator
        sasToken: "?sp=racwdl&st=2025-08-08T05:00:57Z&se=2030-08-08T13:15:57Z&spr=https&sv=2024-11-04&sr=c&sig=lJKK9jDZ59pJSNkKSgwaQIrCdBaJzx4XPzgEB2%2FrnIg%3D"
      };

      // Project Management State
      let selectedProject = "";
      let projectContext = "general";
      let projectTeam = [];
      let milestones = [];
      let resourceUtilization = {};

      // DOM Elements
      const projectSelect = document.getElementById("projectSelect");
      const chatProjectSelect = document.getElementById("chatProjectSelect");
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      const chatMessages = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      const createProjectButton = document.getElementById("createProjectButton");

      // Load projects from Azure Blob Storage
      async function loadProjects() {
        try {
          projectSelect.innerHTML = '<option value="">Loading projects...</option>';
          
          const projects = [];
          
          // Check FCS-OriginalClients folder structure
          const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
          
          const response = await fetch(listUrl, {
            method: 'GET',
            headers: {
              'Accept': 'application/xml'
            }
          });
          
          if (response.ok) {
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const prefixes = xmlDoc.getElementsByTagName("BlobPrefix");
            
            for (let i = 0; i < prefixes.length; i++) {
              const nameElement = prefixes[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const fullPath = nameElement.textContent.replace(/\/$/, '');
                const pathParts = fullPath.split('/');
                
                if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                  const projectName = pathParts[1];
                  if (projectName && !projectName.startsWith('.') && projectName.length > 0) {
                    projects.push({
                      id: projectName,
                      name: formatProjectName(projectName)
                    });
                  }
                }
              }
            }
          }
          
          // Sort projects alphabetically
          projects.sort((a, b) => a.name.localeCompare(b.name));
          
          // Update dropdown
          projectSelect.innerHTML = '<option value="">-- Choose a Project --</option>';
          projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
          });
          
          console.log(`Loaded ${projects.length} projects from Azure Blob Storage`);
          
        } catch (error) {
          console.error('Error loading projects:', error);
          projectSelect.innerHTML = '<option value="">-- Error loading projects --</option>';
          addSystemMessage('Failed to load projects. Please refresh the page.');
        }
      }
      
      // Format project name for display
      function formatProjectName(name) {
        return name
          .split(/[-_]/)
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
      }
      
      // Handle project selection
      projectSelect.addEventListener('change', (e) => {
        selectedProject = e.target.value;
        if (selectedProject) {
          addSystemMessage(`Project "${projectSelect.options[projectSelect.selectedIndex].text}" selected.`);
          // Update project context for chat
          projectContext = selectedProject;
        }
      });
      
      // Initialize capabilities dropdown
      document.addEventListener('DOMContentLoaded', function() {
        // Load projects when page loads
        loadProjects();
        
        const capabilitiesBtn = document.querySelector('.capabilities-btn');
        const capabilitiesDropdown = document.querySelector('.capabilities-dropdown');
        
        if (capabilitiesBtn && capabilitiesDropdown) {
          capabilitiesBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = capabilitiesDropdown.style.display === 'block';
            capabilitiesDropdown.style.display = isVisible ? 'none' : 'block';
          });
          
          capabilitiesBtn.style.cursor = 'pointer';
          
          document.addEventListener('click', () => {
            if (capabilitiesDropdown) {
              capabilitiesDropdown.style.display = 'none';
            }
          });
          
          capabilitiesDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
      });

      // Enhanced message formatting function
      function formatMessageContent(content) {
        if (!content) return '';
        content = String(content);
        
        // Handle code blocks
        content = content.replace(/```([\s\S]*?)```/g, '<pre style="background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow-x: auto; margin: 1rem 0;"><code>$1</code></pre>');
        content = content.replace(/`([^`]+)`/g, '<code style="background: #f6f8fa; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace;">$1</code>');
        
        // Handle lists
        content = content.replace(/^\d+\.\s+(.*)$/gm, '<li style="margin-left: 1.5rem; list-style: decimal;">$1</li>');
        content = content.replace(/(<li style="margin-left: 1\.5rem; list-style: decimal;">.*<\/li>\s*)+/g, (match) => {
          return `<ol style="margin: 0.5rem 0; padding-left: 1rem;">${match}</ol>`;
        });
        
        content = content.replace(/^[•\-\*]\s+(.*)$/gm, '<li style="margin-left: 1.5rem; list-style: disc;">$1</li>');
        content = content.replace(/(<li style="margin-left: 1\.5rem; list-style: disc;">.*<\/li>\s*)+/g, (match) => {
          return `<ul style="margin: 0.5rem 0; padding-left: 1rem;">${match}</ul>`;
        });
        
        // Handle headers
        content = content.replace(/^### (.*)$/gm, '<h3 style="margin: 1rem 0 0.5rem 0; font-size: 1.1rem; font-weight: 600; color: var(--concrete-gray);">$1</h3>');
        content = content.replace(/^## (.*)$/gm, '<h2 style="margin: 1rem 0 0.5rem 0; font-size: 1.3rem; font-weight: 600; color: var(--concrete-gray);">$1</h2>');
        content = content.replace(/^# (.*)$/gm, '<h1 style="margin: 1rem 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--concrete-gray);">$1</h1>');
        
        // Format paragraphs
        const lines = content.split(/\n\n+/);
        content = lines.map(line => {
          if (line.trim().startsWith('<') || line.trim() === '') {
            return line;
          }
          if (line.includes('<li') || line.includes('<h1') || line.includes('<h2') || line.includes('<h3') || line.includes('<ul') || line.includes('<ol') || line.includes('<pre')) {
            return line;
          }
          return `<p style="margin: 0.75rem 0; line-height: 1.6;">${line}</p>`;
        }).join('\n');
        
        // Convert line breaks to <br> within paragraphs
        content = content.replace(/([^>])\n([^<])/g, '$1<br>$2');
        
        // Convert markdown formatting
        content = content.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
        content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\*(.+?)\*/g, '<em>$1</em>');
        content = content.replace(/__(.+?)__/g, '<strong>$1</strong>');
        content = content.replace(/_(.+?)_/g, '<em>$1</em>');
        
        // Convert URLs to links
        const urlRegex = /(?<!href=")(?<!src=")(https?:\/\/[^\s<>"]+)(?![^<]*<\/a>)/g;
        content = content.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: var(--blueprint-blue); text-decoration: underline;">$1</a>');
        
        // Handle horizontal rules
        content = content.replace(/^---+$/gm, '<hr style="border: none; border-top: 1px solid var(--medium-gray); margin: 1rem 0;">');
        
        // Clean up empty paragraphs
        content = content.replace(/<p[^>]*>\s*<\/p>/g, '');
        content = content.replace(/<p[^>]*>\s*<br>\s*<\/p>/g, '');
        
        return `<div style="font-size: 0.95rem; color: var(--concrete-gray);">${content}</div>`;
      }

      // Add message to chat
      function addMessage(content, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        const formattedContent = sender === "assistant" ? formatMessageContent(content) : escapeHtml(content);

        if (sender === "assistant") {
          messageDiv.innerHTML = `
            <div class="message-avatar">📊</div>
            <div class="message-content">
              <div class="formatted-content">${formattedContent}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="formatted-content">${formattedContent}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        }

        if (typingIndicator && typingIndicator.parentNode === chatMessages) {
          chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
          chatMessages.appendChild(messageDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Helper function to escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Add system message
      function addSystemMessage(content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant";

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
          <div class="message-avatar">⚠️</div>
          <div class="message-content" style="background: linear-gradient(135deg, var(--pm-accent), #f57f17); color: var(--dark-gray);">
            <div class="formatted-content"><strong>${content}</strong></div>
            <div class="message-time">${time}</div>
          </div>
        `;

        if (typingIndicator && typingIndicator.parentNode === chatMessages) {
          chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
          chatMessages.appendChild(messageDiv);
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Send message function
      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, "user");

        // Clear input
        chatInput.value = "";

        // Show typing indicator
        typingIndicator.classList.add("active");
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await fetch(API_CONFIG.chatWebhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              context: projectContext,
              project: selectedProject,
              conversationId: `pm_${selectedProject}_${Date.now()}`,
              sessionId: selectedProject || 'general',
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();

          // Hide typing indicator
          typingIndicator.classList.remove("active");

          // Add assistant response
          addMessage(
            data.response || "I received your message but couldn't generate a response. Please try again.",
            "assistant"
          );
        } catch (error) {
          typingIndicator.classList.remove("active");
          addMessage(
            "Sorry, I encountered an error processing your request. Please try again or contact support.",
            "assistant"
          );
          console.error("Chat error:", error);
        }
      }

      // Chat input handlers
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener("click", sendMessage);

      // Project context selection
      chatProjectSelect.addEventListener("change", (e) => {
        projectContext = e.target.value;
        const contextName = chatProjectSelect.options[chatProjectSelect.selectedIndex].text;
        
        addSystemMessage(`🎯 Focus changed to: ${contextName}. I'll provide targeted insights for this project aspect.`);
        
        // Update placeholder based on context
        switch(projectContext) {
          case 'schedule':
            chatInput.placeholder = "Ask about timelines, milestones, critical path, or schedule optimization...";
            break;
          case 'budget':
            chatInput.placeholder = "Ask about costs, budget tracking, forecasts, or financial analysis...";
            break;
          case 'resources':
            chatInput.placeholder = "Ask about team allocation, equipment, materials, or resource optimization...";
            break;
          case 'risks':
            chatInput.placeholder = "Ask about risk identification, mitigation strategies, or contingency planning...";
            break;
          case 'quality':
            chatInput.placeholder = "Ask about quality standards, inspections, compliance, or defect tracking...";
            break;
          case 'stakeholder':
            chatInput.placeholder = "Ask about communication plans, stakeholder updates, or reporting...";
            break;
          default:
            chatInput.placeholder = "Ask about project schedules, budgets, resources, risks, or any management questions...";
        }
      });

      // Create Project button handler
      createProjectButton.addEventListener("click", () => {
        openCreateProjectModal();
      });

      // Create Project Modal
      function openCreateProjectModal() {
        const modalHTML = `
          <div id="projectModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 10px;
              width: 90%;
              max-width: 600px;
              max-height: 90vh;
              overflow-y: auto;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
              <h2 style="margin-bottom: 1.5rem; color: var(--concrete-gray);">🏗️ Create New Project</h2>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Name *</label>
                  <input type="text" id="projectNameInput" placeholder="e.g. Downtown Office Complex" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  " />
                </div>
                
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Type</label>
                  <select id="projectTypeSelect" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  ">
                    <option value="Commercial">Commercial</option>
                    <option value="Residential">Residential</option>
                    <option value="Industrial">Industrial</option>
                    <option value="Infrastructure">Infrastructure</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Educational">Educational</option>
                    <option value="Government">Government</option>
                    <option value="Mixed-Use">Mixed-Use</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Status</label>
                  <select id="projectStatusSelect" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  ">
                    <option value="Planning">Planning</option>
                    <option value="In Progress">In Progress</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Completed">Completed</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Start Date</label>
                  <input type="date" id="startDateInput" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  " />
                </div>
                
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">End Date</label>
                  <input type="date" id="endDateInput" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  " />
                </div>
                
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Budget ($)</label>
                  <input type="number" id="budgetInput" placeholder="e.g. 5000000" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  " />
                </div>
                
                <div>
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Manager</label>
                  <input type="text" id="managerInput" placeholder="e.g. John Smith" style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                  " />
                </div>
                
                <div style="grid-column: 1 / -1;">
                  <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--concrete-gray);">Project Description</label>
                  <textarea id="projectDescInput" placeholder="Brief description of the project scope and objectives..." style="
                    width: 100%;
                    padding: 0.75rem;
                    border: 2px solid var(--medium-gray);
                    border-radius: 5px;
                    font-size: 1rem;
                    min-height: 100px;
                    resize: vertical;
                  "></textarea>
                </div>
              </div>
              
              <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="closeProjectModal()" style="
                  padding: 0.75rem 1.5rem;
                  border: 2px solid var(--medium-gray);
                  background: white;
                  color: var(--concrete-gray);
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Cancel</button>
                <button onclick="createProject()" style="
                  padding: 0.75rem 1.5rem;
                  border: none;
                  background: linear-gradient(135deg, var(--pm-secondary), var(--resource-teal));
                  color: white;
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Create Project</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.getElementById('projectNameInput').focus();
      }
      
      window.closeProjectModal = function() {
        const modal = document.getElementById('projectModal');
        if (modal) {
          modal.remove();
        }
      }
      
      window.createProject = async function() {
        const projectName = document.getElementById('projectNameInput').value.trim();
        const projectType = document.getElementById('projectTypeSelect').value;
        const projectStatus = document.getElementById('projectStatusSelect').value;
        const startDate = document.getElementById('startDateInput').value;
        const endDate = document.getElementById('endDateInput').value;
        const budget = document.getElementById('budgetInput').value;
        const manager = document.getElementById('managerInput').value.trim();
        const description = document.getElementById('projectDescInput').value.trim();
        
        if (!projectName) {
          alert('Project name is required');
          return;
        }
        
        try {
          // Create project via webhook
          const response = await fetch(API_CONFIG.createProjectWebhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              projectName,
              projectType,
              projectStatus,
              startDate,
              endDate,
              budget,
              manager,
              description,
              createdAt: new Date().toISOString()
            }),
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          closeProjectModal();
          addSystemMessage(`✅ Project "${projectName}" created successfully!`);
          
          // Reload projects list
          await loadProjects();
          
        } catch (error) {
          console.error('Create project error:', error);
          alert(`Error creating project: ${error.message}`);
        }
      }

      // Load projects from Azure Blob Storage
      async function loadProjects() {
        try {
          // Load from Azure Blob Storage - matching general-chat.html implementation
          const listUrl = `https://saxtechfcs.blob.core.windows.net/fcs-clients?sp=racwdl&st=2025-08-08T05:00:57Z&se=2030-08-08T13:15:57Z&spr=https&sv=2024-11-04&sr=c&sig=lJKK9jDZ59pJSNkKSgwaQIrCdBaJzx4XPzgEB2%2FrnIg%3D&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
          
          const response = await fetch(listUrl);
          if (response.ok) {
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const prefixes = xmlDoc.getElementsByTagName("BlobPrefix");
            
            projectSelect.innerHTML = '<option value="">-- Choose a Project --</option>';
            
            for (let i = 0; i < prefixes.length; i++) {
              const nameElement = prefixes[i].getElementsByTagName("Name")[0];
              if (nameElement) {
                const fullPath = nameElement.textContent;
                const pathParts = fullPath.split('/');
                
                // Extract client name from path
                if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                  const clientName = pathParts[1];
                  
                  // Filter out system folders and temp files
                  if (clientName && !clientName.startsWith('.') && !clientName.includes('$') && clientName.length > 0) {
                    const option = document.createElement('option');
                    option.value = clientName;
                    option.textContent = clientName;
                    projectSelect.appendChild(option);
                  }
                }
              }
            }
            
            // Update project count in status
            const projectCount = projectSelect.options.length - 1; // Excluding the default option
            console.log(`Loaded ${projectCount} projects from Azure`);
            
          } else {
            console.error('Failed to fetch project list:', response.status);
            // Fallback to some default projects if needed
            const fallbackProjects = [
              'Construction Project 1',
              'Construction Project 2'
            ];
            
            projectSelect.innerHTML = '<option value="">-- Choose a Project --</option>';
            fallbackProjects.forEach(project => {
              const option = document.createElement('option');
              option.value = project;
              option.textContent = project;
              projectSelect.appendChild(option);
            });
          }
          
        } catch (error) {
          console.error('Error loading projects:', error);
        }
      }

      // Project selection handler
      projectSelect.addEventListener("change", async (e) => {
        selectedProject = e.target.value;
        if (selectedProject) {
          addSystemMessage(`📁 Project "${projectSelect.options[projectSelect.selectedIndex].text}" selected. Loading project data...`);
          
          // Update status cards, milestones, team members, etc.
          updateProjectDashboard();
        }
      });

      // Update project dashboard
      function updateProjectDashboard() {
        // This would be connected to real project data
        // For now, we're using the static HTML content
        console.log('Updating dashboard for project:', selectedProject);
      }

      // Initialize on load
      window.addEventListener("load", async () => {
        await loadProjects();
        
        // Update resource bars animation
        document.querySelectorAll('.resource-fill').forEach(bar => {
          const width = bar.style.width;
          bar.style.width = '0%';
          setTimeout(() => {
            bar.style.width = width;
          }, 100);
        });
        
        // Update milestone progress rings
        document.querySelectorAll('.progress-ring-circle').forEach(circle => {
          const offset = circle.style.strokeDashoffset;
          circle.style.strokeDashoffset = '157';
          setTimeout(() => {
            circle.style.strokeDashoffset = offset;
          }, 500);
        });
      });
    </script>
    
<!-- Enhanced Project Management Professional - DISABLED -->
<!-- <script src="js/project-management-pro.js"></script> -->

<!-- Emergency Fix Script -->
    <script src="js/nuclear-fix.js"></script>

<!-- Module Integration -->
<script type="module">
import ForemanAI from './js/modules/app-integrator.js';

// Initialize ForemanAI for projects page
document.addEventListener('DOMContentLoaded', async () => {
    await ForemanAI.initialize('projects');
    
    // Make ForemanAI available globally for legacy code
    window.app = ForemanAI;
    
    console.log('✅ ForemanAI Projects Module Loaded');
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ask Foreman - Project Management</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --construction-orange: #ff6b35;
        --safety-yellow: #ffc107;
        --concrete-gray: #424242;
        --steel-gray: #616161;
        --blueprint-blue: #1565c0;
        --hi-vis-green: #76ff03;
        --warning-red: #d32f2f;
        --white: #ffffff;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --dark-gray: #212121;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
        
        /* Blue theme for projects */
        --primary-blue: #1976d2;
        --dark-blue: #0d47a1;
        --light-blue: #42a5f5;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #0d47a1 0%, #002171 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 35px,
            rgba(33, 150, 243, 0.05) 35px,
            rgba(33, 150, 243, 0.05) 70px
          ),
          repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 35px,
            rgba(66, 165, 245, 0.03) 35px,
            rgba(66, 165, 245, 0.03) 70px
          );
        pointer-events: none;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--dark-gray) 0%,
          var(--dark-blue) 100%
        );
        color: white;
        padding: 1rem 2rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--light-blue);
        position: relative;
        z-index: 10;
      }

      .header::before {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 4px;
        background: repeating-linear-gradient(
          90deg,
          var(--light-blue) 0px,
          var(--light-blue) 20px,
          var(--dark-blue) 20px,
          var(--dark-blue) 40px
        );
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .logo-icon {
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        overflow: hidden;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .logo h1 {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--light-blue);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
      }

      .logo .tagline {
        font-size: 1rem;
        color: #90caf9;
        font-weight: 500;
        margin-top: -0.25rem;
      }

      /* Navigation styles */
      .nav-buttons {
        display: flex;
        gap: 1rem;
      }

      .nav-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--light-blue), var(--primary-blue));
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-btn:hover {
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.4);
      }

      .nav-btn.admin {
        background: linear-gradient(135deg, var(--warning-red), #b71c1c);
      }

      .nav-btn.admin:hover {
        background: linear-gradient(135deg, #b71c1c, var(--warning-red));
      }

      .container {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 2rem;
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        position: relative;
        z-index: 1;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--medium-gray);
        position: relative;
      }

      /* Project List Styles */
      .project-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .project-list h2 {
        color: var(--primary-blue);
        font-size: 1.4rem;
      }

      .create-project-btn {
        background: linear-gradient(135deg, var(--hi-vis-green), #64dd17);
        color: var(--dark-gray);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .create-project-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(118, 255, 3, 0.3);
      }

      .project-search {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--medium-gray);
        border-radius: 5px;
        margin-bottom: 1rem;
        font-size: 1rem;
      }

      .project-items {
        max-height: 500px;
        overflow-y: auto;
      }

      .project-item {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: var(--light-gray);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .project-item:hover {
        background: #e3f2fd;
        border-color: var(--primary-blue);
        transform: translateX(5px);
      }

      .project-item.active {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-color: var(--primary-blue);
        box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
      }

      .project-name {
        font-weight: bold;
        color: var(--dark-gray);
        margin-bottom: 0.25rem;
      }

      .project-stats {
        font-size: 0.85rem;
        color: var(--steel-gray);
      }

      /* Main Content Area */
      .main-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .project-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
        padding: 1.5rem;
        border-radius: 10px;
        color: white;
      }

      .project-title {
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .project-info {
        display: flex;
        gap: 2rem;
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* File Browser */
      .file-browser {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        min-height: 400px;
      }

      .file-browser-navigation {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        background: #f8f8f8;
        border-radius: 5px;
        margin-bottom: 1rem;
        gap: 0.75rem;
      }

      .nav-button {
        width: 36px;
        height: 36px;
        padding: 0;
        border: 1px solid #ccc;
        background: white;
        cursor: pointer;
        border-radius: 3px;
        transition: all 0.1s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .nav-button svg {
        width: 20px;
        height: 20px;
        color: #666;
      }

      .nav-button:hover:not(:disabled) {
        background: #e3f2fd;
        border-color: var(--primary-blue);
      }

      .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .breadcrumb {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #ccc;
        border-radius: 3px;
        overflow-x: auto;
        min-height: 36px;
        white-space: nowrap;
      }

      .breadcrumb-item {
        color: var(--primary-blue);
        cursor: pointer;
        white-space: nowrap;
      }

      .breadcrumb-item:hover {
        text-decoration: underline;
      }

      .breadcrumb-separator {
        color: #666;
        margin: 0 0.25rem;
      }

      .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: linear-gradient(135deg, var(--light-blue), var(--primary-blue));
        color: white;
        border-radius: 8px;
      }

      .file-list-header h4 {
        margin: 0;
        font-size: 1rem;
      }

      /* File Items */
      .folder-item,
      .file-item {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #e0e0e0;
        margin: 0 0.5rem 2px 0.5rem;
        cursor: pointer;
        user-select: none;
        transition: all 0.1s ease;
        border-radius: 3px;
      }

      .folder-item:hover,
      .file-item:hover {
        background: #e3f2fd;
        border-color: var(--primary-blue);
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
      }

      .file-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
      }

      .file-icon svg {
        width: 20px;
        height: 20px;
      }

      .file-name {
        flex: 1;
        color: var(--concrete-gray);
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
      }

      .file-meta {
        display: flex;
        gap: 0.75rem;
        font-size: 0.75rem;
        color: var(--steel-gray);
        align-items: center;
      }

      .file-actions {
        display: flex;
        gap: 0.4rem;
        margin-left: auto;
      }

      .file-action-btn {
        padding: 0.2rem 0.4rem;
        border: 1px solid #d0d0d0;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.1s ease;
      }

      .file-action-btn:hover {
        background: #f0f0f0;
        border-color: #999;
      }

      .file-action-btn.delete {
        background: var(--warning-red);
        color: white;
        border-color: var(--warning-red);
      }

      .file-action-btn.delete:hover {
        background: #b71c1c;
        transform: scale(1.05);
      }

      .folder-file-count {
        font-size: 0.75rem;
        color: var(--steel-gray);
        margin-left: auto;
        padding: 0.15rem 0.5rem;
        background: #e3f2fd;
        border-radius: 10px;
      }

      .no-files-message {
        text-align: center;
        padding: 2rem;
        color: var(--steel-gray);
        font-style: italic;
        background: var(--light-gray);
        border-radius: 8px;
        border: 2px dashed var(--medium-gray);
        margin: 1rem;
      }

      /* Chat Section */
      .chat-container {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        flex-direction: column;
        height: 600px;
      }

      .chat-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
        color: white;
        padding: 1rem;
        border-radius: 8px 8px 0 0;
        margin: -1.5rem -1.5rem 1rem -1.5rem;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: var(--light-gray);
        border-radius: 5px;
        margin-bottom: 1rem;
      }

      .message {
        margin-bottom: 1rem;
        display: flex;
        gap: 0.5rem;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 70%;
        padding: 0.75rem;
        border-radius: 8px;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      }

      .message.system .message-content {
        background: #fff3cd;
        border-left: 4px solid var(--safety-yellow);
      }

      .chat-input-container {
        display: flex;
        gap: 0.5rem;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem;
        border: 2px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 1rem;
        resize: none;
      }

      .send-button {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, var(--light-blue), var(--primary-blue));
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .send-button:hover {
        background: linear-gradient(135deg, var(--primary-blue), var(--light-blue));
        transform: scale(1.05);
      }

      /* Context Menu */
      .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        display: none;
      }

      .context-menu.show {
        display: block;
      }

      .context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .context-menu-item:hover {
        background: #f0f0f0;
      }

      .context-menu-separator {
        border-bottom: 2px solid #ddd;
        margin: 0.25rem 0;
      }

      /* Loading indicator */
      .loading-indicator {
        display: none;
        text-align: center;
        padding: 1.5rem;
        color: var(--steel-gray);
      }

      .loading-indicator.active {
        display: block;
      }

      @media (max-width: 1200px) {
        .container {
          grid-template-columns: 1fr;
        }

        .sidebar {
          display: none;
        }
      }
    </style>
  </head>
  
  <body>
    <div class="header">
      <div class="logo">
        <div class="logo-icon">
          <img src="images/logo3.png" alt="Foreman" />
        </div>
        <div>
          <h1>ASK FOREMAN</h1>
          <div class="tagline">Project Management Portal</div>
        </div>
      </div>
      <div class="nav-buttons">
        <a href="estimator.html" class="nav-btn">üèóÔ∏è Estimator</a>
        <a href="general-chat.html" class="nav-btn">üí¨ General Chat</a>
        <a href="admin.html" class="nav-btn admin">üîß Admin</a>
      </div>
    </div>

    <div class="container">
      <!-- Left Sidebar - Project List -->
      <div class="sidebar">
        <div class="card project-list">
          <div class="project-list-header">
            <h2>üìÅ Projects</h2>
            <button class="create-project-btn" id="createProjectBtn">+ New</button>
          </div>
          <input type="text" class="project-search" id="projectSearch" placeholder="üîç Search projects..." />
          <div class="project-items" id="projectItems">
            <!-- Projects will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content">
        <div class="project-header" id="projectHeader">
          <div class="project-title">Select a Project</div>
          <div class="project-info">
            <span>Choose a project from the list to view details</span>
          </div>
        </div>

        <div class="file-browser" id="fileBrowser">
          <div id="fileList">
            <!-- File browser will be loaded here -->
          </div>
          <div class="loading-indicator" id="filesLoadingIndicator">
            Loading files...
          </div>
        </div>
      </div>

      <!-- Right Sidebar - Chat -->
      <div class="sidebar">
        <div class="chat-container">
          <div class="chat-header">
            <h3>üí¨ Project Assistant</h3>
            <select id="chatContext" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.25rem; border-radius: 3px; margin-top: 0.5rem;">
              <option value="general">General Knowledge</option>
              <option value="current">Current Project</option>
              <option value="all">All Projects</option>
            </select>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-container">
            <textarea class="chat-input" id="chatInput" placeholder="Ask about this project..." rows="2"></textarea>
            <button class="send-button" id="sendButton">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Azure Blob Storage Configuration
      const AZURE_STORAGE = {
        account: "saxtechfcs",
        container: "fcs-clients",
        sasToken: "?sp=racwdl&st=2025-08-08T05:00:57Z&se=2030-08-08T13:15:57Z&spr=https&sv=2024-11-04&sr=c&sig=lJKK9jDZ59pJSNkKSgwaQIrCdBaJzx4XPzgEB2%2FrnIg%3D"
      };

      // API Configuration
      const API_CONFIG = {
        chatWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/EstimatorChat",
        deleteWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/delete"
      };

      // State Management
      let selectedProject = null;
      let projectFiles = [];
      let fileStructure = {};
      let currentPath = [];
      let chatContext = 'general';

      // DOM Elements
      const projectItems = document.getElementById('projectItems');
      const projectSearch = document.getElementById('projectSearch');
      const createProjectBtn = document.getElementById('createProjectBtn');
      const projectHeader = document.getElementById('projectHeader');
      const fileList = document.getElementById('fileList');
      const filesLoadingIndicator = document.getElementById('filesLoadingIndicator');
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendButton = document.getElementById('sendButton');
      const chatContextSelect = document.getElementById('chatContext');

      // Load projects on page load
      async function loadProjects() {
        try {
          const projects = [];
          const projectSet = new Set();
          
          // Get list from Azure Blob Storage
          const fcsUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
          
          const response = await fetch(fcsUrl);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const xmlText = await response.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          const prefixes = xmlDoc.getElementsByTagName("BlobPrefix");
          
          for (let i = 0; i < prefixes.length; i++) {
            const nameElement = prefixes[i].getElementsByTagName("Name")[0];
            if (nameElement) {
              const fullPath = nameElement.textContent.replace(/\/$/, '');
              const pathParts = fullPath.split('/');
              
              if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                const projectId = pathParts[1];
                
                if (!projectSet.has(projectId) && !projectId.startsWith('.') && projectId.length > 0) {
                  projectSet.add(projectId);
                  projects.push({
                    id: projectId,
                    name: formatProjectName(projectId)
                  });
                }
              }
            }
          }
          
          renderProjects(projects);
          
        } catch (error) {
          console.error('Error loading projects:', error);
          addSystemMessage("‚ö†Ô∏è Could not load project list. Please check connection.");
        }
      }

      function formatProjectName(name) {
        return name
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }

      function renderProjects(projects) {
        projectItems.innerHTML = '';
        
        projects.forEach(project => {
          const projectItem = document.createElement('div');
          projectItem.className = 'project-item';
          projectItem.onclick = () => selectProject(project);
          
          projectItem.innerHTML = `
            <div class="project-name">${project.name}</div>
            <div class="project-stats">Loading...</div>
          `;
          
          projectItems.appendChild(projectItem);
        });
      }

      async function selectProject(project) {
        // Update UI
        document.querySelectorAll('.project-item').forEach(item => {
          item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        selectedProject = project;
        
        // Update header
        projectHeader.innerHTML = `
          <div class="project-title">üìÇ ${project.name}</div>
          <div class="project-info">
            <span>Project ID: ${project.id}</span>
            <span>Loading file details...</span>
          </div>
        `;
        
        // Load project files
        await loadProjectFiles(project.id);
        
        // Update chat context
        if (chatContextSelect.value === 'current') {
          addSystemMessage(`üéØ Chat focused on ${project.name} project.`);
        }
      }

      async function loadProjectFiles(projectId) {
        try {
          filesLoadingIndicator.classList.add('active');
          
          const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/${projectId}/`;
          
          const response = await fetch(listUrl);
          const xmlText = await response.text();
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, "text/xml");
          const blobs = xmlDoc.getElementsByTagName("Blob");
          
          projectFiles = [];
          
          for (let i = 0; i < blobs.length; i++) {
            const nameElement = blobs[i].getElementsByTagName("Name")[0];
            const sizeElement = blobs[i].getElementsByTagName("Properties")[0]?.getElementsByTagName("Content-Length")[0];
            const lastModifiedElement = blobs[i].getElementsByTagName("Properties")[0]?.getElementsByTagName("Last-Modified")[0];
            
            if (nameElement) {
              const fullPath = nameElement.textContent;
              const fileName = fullPath.split('/').pop();
              
              if (fileName && !fileName.startsWith('.') && fileName !== 'placeholder.json') {
                const encodedPath = fullPath.split('/').map(p => encodeURIComponent(p)).join('/');
                const blobUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${encodedPath}${AZURE_STORAGE.sasToken}`;
                
                projectFiles.push({
                  name: fileName,
                  fullPath: fullPath,
                  blobUrl: blobUrl,
                  size: parseInt(sizeElement?.textContent || '0'),
                  lastModified: lastModifiedElement?.textContent || new Date().toISOString(),
                  category: fullPath.split('/')[2] || 'General'
                });
              }
            }
          }
          
          // Build file structure
          fileStructure = buildFileStructure(projectFiles);
          currentPath = [];
          
          filesLoadingIndicator.classList.remove('active');
          renderFileBrowser();
          
          // Update project stats
          const fileCount = projectFiles.length;
          const totalSize = projectFiles.reduce((sum, f) => sum + f.size, 0);
          
          projectHeader.innerHTML = `
            <div class="project-title">üìÇ ${selectedProject.name}</div>
            <div class="project-info">
              <span>Files: ${fileCount}</span>
              <span>Size: ${formatFileSize(totalSize)}</span>
              <span>Last Updated: ${new Date(Math.max(...projectFiles.map(f => new Date(f.lastModified)))).toLocaleDateString()}</span>
            </div>
          `;
          
          addSystemMessage(`üìÅ Loaded ${fileCount} file${fileCount !== 1 ? 's' : ''} for ${selectedProject.name}`);
          
        } catch (error) {
          console.error('Error loading project files:', error);
          fileList.innerHTML = '<div class="no-files-message">Could not load files. Please check your connection.</div>';
        }
      }

      function buildFileStructure(files) {
        const structure = {};
        
        files.forEach(file => {
          const pathParts = file.fullPath.split('/').slice(2); // Remove client prefix
          let current = structure;
          
          // Navigate/create folder structure
          for (let i = 0; i < pathParts.length - 1; i++) {
            const folder = pathParts[i];
            if (!current[folder]) {
              current[folder] = { _files: [] };
            }
            current = current[folder];
          }
          
          // Add file to current folder
          if (!current._files) {
            current._files = [];
          }
          current._files.push(file);
        });
        
        return structure;
      }

      function getCurrentFolder() {
        let current = fileStructure;
        for (const folder of currentPath) {
          current = current[folder];
        }
        return current;
      }

      function renderFileBrowser() {
        fileList.innerHTML = '';
        
        // Add navigation
        const navBar = document.createElement('div');
        navBar.className = 'file-browser-navigation';
        
        navBar.innerHTML = `
          <button class="nav-button" onclick="navigateBack()" title="Back" ${currentPath.length === 0 ? 'disabled' : ''}>
            <svg viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
          <button class="nav-button" onclick="navigateToPath(0)" title="Home">
            <svg viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
          </button>
          <div class="breadcrumb">
            <span class="breadcrumb-item" onclick="navigateToPath(0)">${selectedProject ? selectedProject.name : 'Root'}</span>
            ${currentPath.map((folder, index) => `
              <span class="breadcrumb-separator">/</span>
              <span class="breadcrumb-item" onclick="navigateToPath(${index + 1})">${folder}</span>
            `).join('')}
          </div>
          <button class="nav-button" onclick="refreshFiles()" title="Refresh">
            <svg viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
            </svg>
          </button>
        `;
        
        fileList.appendChild(navBar);
        
        // Add header
        const header = document.createElement('div');
        header.className = 'file-list-header';
        header.innerHTML = '<h4>Project Files</h4>';
        fileList.appendChild(header);
        
        // Get current folder content
        const currentFolder = getCurrentFolder();
        const folders = Object.keys(currentFolder).filter(key => key !== '_files');
        const files = currentFolder._files || [];
        
        const contentContainer = document.createElement('div');
        
        if (folders.length === 0 && files.length === 0) {
          contentContainer.innerHTML = '<div class="no-files-message">üìÅ This folder is empty</div>';
        } else {
          // Render folders
          folders.forEach(folderName => {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            folderItem.ondblclick = () => navigateToFolder(folderName);
            folderItem.oncontextmenu = (e) => showContextMenu(e, folderName, true);
            
            const folderObj = currentFolder[folderName];
            const fileCount = countFilesInFolder(folderObj);
            
            folderItem.innerHTML = `
              <div class="file-info">
                <div class="file-icon">
                  <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#FFA000" d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                  </svg>
                </div>
                <div class="file-name">${folderName}</div>
                <div class="folder-file-count">${fileCount} file${fileCount !== 1 ? 's' : ''}</div>
              </div>
            `;
            
            contentContainer.appendChild(folderItem);
          });
          
          // Render files
          files.forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.ondblclick = () => openFilePreview(file);
            fileItem.oncontextmenu = (e) => showContextMenu(e, file.name, false, file);
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            
            fileItem.innerHTML = `
              <div class="file-info">
                <div class="file-icon">${getFileIcon(fileExt)}</div>
                <div class="file-name">${file.name}</div>
                <div class="file-meta">
                  <span>${formatFileSize(file.size)}</span>
                  <span>${new Date(file.lastModified).toLocaleDateString()}</span>
                </div>
                <div class="file-actions">
                  <button class="file-action-btn delete" onclick="event.stopPropagation(); deleteFile('${file.fullPath}', '${file.name}')">üóëÔ∏è</button>
                </div>
              </div>
            `;
            
            contentContainer.appendChild(fileItem);
          });
        }
        
        fileList.appendChild(contentContainer);
      }

      function countFilesInFolder(folder) {
        let count = 0;
        if (folder._files) {
          count += folder._files.length;
        }
        Object.keys(folder).forEach(key => {
          if (key !== '_files' && typeof folder[key] === 'object') {
            count += countFilesInFolder(folder[key]);
          }
        });
        return count;
      }

      function navigateToFolder(folderName) {
        currentPath.push(folderName);
        renderFileBrowser();
      }

      function navigateBack() {
        if (currentPath.length > 0) {
          currentPath.pop();
          renderFileBrowser();
        }
      }

      function navigateToPath(index) {
        currentPath = currentPath.slice(0, index);
        renderFileBrowser();
      }

      function refreshFiles() {
        if (selectedProject) {
          addSystemMessage('üîÑ Refreshing file list...');
          loadProjectFiles(selectedProject.id);
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }

      function getFileIcon(ext) {
        // Returns SVG icon based on file extension
        if (ext === 'pdf') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect width="24" height="24" rx="2" fill="#DC372C"/>
            <text x="12" y="16" font-family="Arial" font-size="8" font-weight="bold" fill="white" text-anchor="middle">PDF</text>
          </svg>`;
        } else if (ext === 'docx' || ext === 'doc') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path fill="#2B579A" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
          </svg>`;
        } else if (ext === 'xlsx' || ext === 'xls') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path fill="#107C41" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
          </svg>`;
        } else if (ext === 'dwg' || ext === 'dxf') {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect fill="#E51937" width="24" height="24" rx="2"/>
            <text x="12" y="16" font-family="Arial" font-size="8" font-weight="bold" fill="white" text-anchor="middle">DWG</text>
          </svg>`;
        } else {
          return `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path fill="#757575" d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
            <path fill="#FFF" opacity=".5" d="M14 2v6h6"/>
          </svg>`;
        }
      }

      function openFilePreview(file) {
        const modal = document.createElement('div');
        modal.className = 'file-preview-modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: white;
          padding: 2rem;
          border-radius: 8px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        `;
        
        modalContent.innerHTML = `
          <h3 style="margin-top: 0; margin-bottom: 1rem; color: var(--primary-blue);">File Preview</h3>
          <div style="margin-bottom: 1rem;">
            <strong>File:</strong> ${file.name}<br>
            <strong>Size:</strong> ${formatFileSize(file.size)}<br>
            <strong>Category:</strong> ${file.category || 'General'}
          </div>
          <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
            <button onclick="window.open('${file.blobUrl}', '_blank'); this.closest('.file-preview-modal').remove();" 
              style="flex: 1; padding: 0.75rem; background: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
              üëÅÔ∏è Preview
            </button>
            <button onclick="downloadFileWithWarning('${file.blobUrl}', '${file.name}'); this.closest('.file-preview-modal').remove();" 
              style="flex: 1; padding: 0.75rem; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">
              üì• Download
            </button>
            <button onclick="this.closest('.file-preview-modal').remove();" 
              style="padding: 0.75rem 1.5rem; background: #f0f0f0; color: #333; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
              Cancel
            </button>
          </div>
        `;
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      }

      function downloadFileWithWarning(blobUrl, fileName) {
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = fileName;
        a.click();
        
        setTimeout(() => {
          const warningModal = document.createElement('div');
          warningModal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10001;
            max-width: 450px;
          `;
          
          warningModal.innerHTML = `
            <h3 style="margin-top: 0; color: #d93025;">‚ö†Ô∏è Important Notice</h3>
            <p style="margin: 1rem 0; color: #666;">
              If you make changes to this file, please remember to upload it back to the project 
              to ensure everyone has access to the latest version.
            </p>
            <button onclick="this.parentElement.remove();" 
              style="width: 100%; padding: 0.75rem; background: var(--primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">
              Got it!
            </button>
          `;
          
          document.body.appendChild(warningModal);
        }, 500);
      }

      function showContextMenu(event, itemName, isFolder, fileObj = null) {
        event.preventDefault();
        
        const existingMenu = document.querySelector('.context-menu');
        if (existingMenu) existingMenu.remove();
        
        const menu = document.createElement('div');
        menu.className = 'context-menu show';
        menu.style.left = event.pageX + 'px';
        menu.style.top = event.pageY + 'px';
        
        if (isFolder) {
          menu.innerHTML = `
            <div class="context-menu-item" onclick="navigateToFolder('${itemName}'); closeContextMenu();">üìÇ Open</div>
          `;
        } else {
          const file = fileObj || getCurrentFolder()._files.find(f => f.name === itemName);
          
          menu.innerHTML = `
            <div class="context-menu-item" onclick="openFilePreview(${JSON.stringify(file).replace(/"/g, '&quot;')}); closeContextMenu();">üëÅÔ∏è Preview</div>
            <div class="context-menu-item" onclick="downloadFileWithWarning('${file.blobUrl}', '${file.name}'); closeContextMenu();">üì• Download</div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item" onclick="deleteFile('${file.fullPath}', '${file.name}'); closeContextMenu();">üóëÔ∏è Delete</div>
          `;
        }
        
        document.body.appendChild(menu);
        
        setTimeout(() => {
          document.addEventListener('click', closeContextMenu);
        }, 100);
      }

      function closeContextMenu() {
        const menu = document.querySelector('.context-menu');
        if (menu) {
          menu.remove();
          document.removeEventListener('click', closeContextMenu);
        }
      }

      async function deleteFile(fullPath, fileName) {
        if (confirm(`Are you sure you want to delete ${fileName}?`)) {
          try {
            addSystemMessage(`üóëÔ∏è Deleting ${fileName}...`);
            
            const response = await fetch(API_CONFIG.deleteWebhookUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                filePath: fullPath,
                client: selectedProject ? selectedProject.id : null
              })
            });
            
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            addSystemMessage(`‚úÖ Successfully deleted: ${fileName}`);
            
            if (selectedProject) {
              setTimeout(() => {
                loadProjectFiles(selectedProject.id);
              }, 500);
            }
          } catch (error) {
            console.error('Error deleting file:', error);
            addSystemMessage(`‚ùå Failed to delete ${fileName}: ${error.message}`);
          }
        }
      }

      // Create project modal
      createProjectBtn.addEventListener('click', () => {
        const modalHTML = `
          <div id="projectModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
          ">
            <div style="
              background: white;
              padding: 2rem;
              border-radius: 10px;
              width: 90%;
              max-width: 500px;
              box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            ">
              <h2 style="margin-bottom: 1.5rem; color: var(--primary-blue);">üèóÔ∏è Create New Project</h2>
              
              <div style="margin-bottom: 1rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Project Name *</label>
                <input type="text" id="projectNameInput" placeholder="e.g. ABC Construction" style="
                  width: 100%;
                  padding: 0.75rem;
                  border: 2px solid var(--medium-gray);
                  border-radius: 5px;
                  font-size: 1rem;
                ">
              </div>
              
              <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="document.getElementById('projectModal').remove()" style="
                  padding: 0.75rem 1.5rem;
                  background: var(--medium-gray);
                  color: var(--dark-gray);
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Cancel</button>
                <button onclick="createProject()" style="
                  padding: 0.75rem 1.5rem;
                  background: linear-gradient(135deg, var(--light-blue), var(--primary-blue));
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: 600;
                ">Create Project</button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      });

      async function createProject() {
        const projectNameInput = document.getElementById('projectNameInput');
        const projectName = projectNameInput.value.trim();
        
        if (!projectName) {
          alert('Please enter a project name');
          return;
        }
        
        const folderId = projectName.toLowerCase().replace(/\s+/g, '-');
        const categories = ['drawings', 'estimates', 'proposals', 'specs', 'signed-contracts'];
        
        for (const category of categories) {
          const placeholderPath = `FCS-OriginalClients/${folderId}/${category}/placeholder.json`;
          await createPlaceholderFile(placeholderPath);
        }
        
        document.getElementById('projectModal').remove();
        addSystemMessage(`‚úÖ Created new project: ${projectName}`);
        
        await loadProjects();
      }

      async function createPlaceholderFile(path) {
        const url = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${path}${AZURE_STORAGE.sasToken}`;
        
        await fetch(url, {
          method: 'PUT',
          headers: {
            'x-ms-blob-type': 'BlockBlob',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ placeholder: true, created: new Date().toISOString() })
        });
      }

      // Chat functionality
      function addMessage(text, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = text;
        
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addSystemMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = text;
        
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        
        addMessage(message, 'user');
        chatInput.value = '';
        
        try {
          const contextValue = chatContextSelect.value;
          let context = 'general';
          
          if (contextValue === 'current' && selectedProject) {
            context = selectedProject.id;
          } else if (contextValue === 'all') {
            context = 'all-clients';
          }
          
          const response = await fetch(API_CONFIG.chatWebhookUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: message,
              context: context
            })
          });
          
          if (!response.ok) throw new Error('Chat request failed');
          
          const data = await response.json();
          addMessage(data.response || 'I apologize, but I couldn\'t process your request.', 'assistant');
          
        } catch (error) {
          console.error('Chat error:', error);
          addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
        }
      }

      sendButton.addEventListener('click', sendMessage);
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      chatContextSelect.addEventListener('change', (e) => {
        chatContext = e.target.value;
        if (chatContext === 'general') {
          addSystemMessage('üåê Chat context set to General Construction Knowledge.');
        } else if (chatContext === 'all') {
          addSystemMessage('üîç Knowledge Graph mode activated! Searching across ALL projects.');
        } else if (chatContext === 'current' && selectedProject) {
          addSystemMessage(`üéØ Chat focused on ${selectedProject.name} project.`);
        }
      });

      projectSearch.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.project-item');
        
        items.forEach(item => {
          const name = item.querySelector('.project-name').textContent.toLowerCase();
          item.style.display = name.includes(searchTerm) ? 'block' : 'none';
        });
      });

      // Initialize
      loadProjects();
      addSystemMessage('üëã Welcome to Project Management! Select a project to get started.');
    </script>
  </body>
</html>

{
  "name": "Index Document Service",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ask-foreman/index-document",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "index-webhook",
      "name": "Index Document Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "ask-foreman-index"
    },
    {
      "parameters": {
        "jsCode": "// Extract and validate indexing parameters\nconst input = $input.all()[0];\nconst body = input.json?.body || input.json || {};\n\n// Validate required fields\nif (!body.documentId) {\n    throw new Error('documentId is required for indexing');\n}\n\nif (!body.content && !body.text && !body.extractedText) {\n    throw new Error('content, text, or extractedText is required for indexing');\n}\n\n// Extract parameters\nconst documentId = body.documentId;\nconst content = body.content || body.text || body.extractedText || '';\nconst metadata = body.metadata || {};\n\n// Prepare document for vector indexing\nconst indexDocument = {\n    id: documentId,\n    content: content,\n    metadata: {\n        client: metadata.client || 'unknown',\n        category: metadata.category || 'documents',\n        fileName: metadata.fileName || 'unknown',\n        uploadDate: metadata.uploadDate || new Date().toISOString(),\n        blobUrl: metadata.blobUrl || '',\n        convertedUrl: metadata.convertedUrl || '',\n        contentLength: content.length,\n        indexed: true,\n        indexedAt: new Date().toISOString()\n    },\n    embedding: null // Will be generated by vector DB\n};\n\nreturn [{\n    json: indexDocument\n}];"
      },
      "id": "prepare-index",
      "name": "Prepare Document for Indexing",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "construction_documents",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldName": "id",
              "fieldValue": "={{ $json.id }}"
            },
            {
              "fieldName": "content",
              "fieldValue": "={{ $json.content }}"
            },
            {
              "fieldName": "client",
              "fieldValue": "={{ $json.metadata.client }}"
            },
            {
              "fieldName": "category",
              "fieldValue": "={{ $json.metadata.category }}"
            },
            {
              "fieldName": "fileName",
              "fieldValue": "={{ $json.metadata.fileName }}"
            },
            {
              "fieldName": "uploadDate",
              "fieldValue": "={{ $json.metadata.uploadDate }}"
            },
            {
              "fieldName": "blobUrl",
              "fieldValue": "={{ $json.metadata.blobUrl }}"
            },
            {
              "fieldName": "indexedAt",
              "fieldValue": "={{ $json.metadata.indexedAt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "vector-db",
      "name": "Insert into Vector Database",
      "type": "n8n-nodes-base.vectorStore",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"success\": true,\n  \"message\": \"Document indexed successfully\",\n  \"documentId\": \"={{ $('prepare-index').item.json.id }}\",\n  \"contentLength\": {{ $('prepare-index').item.json.metadata.contentLength }},\n  \"client\": \"={{ $('prepare-index').item.json.metadata.client }}\",\n  \"category\": \"={{ $('prepare-index').item.json.metadata.category }}\",\n  \"fileName\": \"={{ $('prepare-index').item.json.metadata.fileName }}\",\n  \"indexedAt\": \"={{ $('prepare-index').item.json.metadata.indexedAt }}\"\n}",
        "options": {}
      },
      "id": "index-response",
      "name": "Index Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 300]
    }
  ],
  "connections": {
    "Index Document Webhook": {
      "main": [
        [
          {
            "node": "Prepare Document for Indexing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Document for Indexing": {
      "main": [
        [
          {
            "node": "Insert into Vector Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert into Vector Database": {
      "main": [
        [
          {
            "node": "Index Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "index-document-service"
}

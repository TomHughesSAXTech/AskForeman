<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Foreman - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --construction-orange: #ff6b35;
            --safety-yellow: #ffc107;
            --concrete-gray: #424242;
            --steel-gray: #616161;
            --blueprint-blue: #1565c0;
            --hi-vis-green: #76ff03;
            --warning-red: #d32f2f;
            --white: #ffffff;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #212121;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #37474f 0%, #263238 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
        }

        .login-box h2 {
            color: var(--concrete-gray);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: 5px;
            font-size: 1rem;
        }

        .login-box button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
            color: var(--dark-gray);
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            color: var(--warning-red);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* Admin Panel */
        .admin-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--dark-gray) 0%, var(--concrete-gray) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--warning-red);
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--safety-yellow);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
            color: var(--dark-gray);
        }

        .btn-success {
            background: var(--hi-vis-green);
            color: var(--dark-gray);
        }

        .btn-danger {
            background: var(--warning-red);
            color: white;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }

        .content {
            flex: 1;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .panel h2 {
            color: var(--concrete-gray);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--safety-yellow);
        }

        .client-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .client-item {
            padding: 1rem;
            border: 1px solid var(--medium-gray);
            border-radius: 5px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .client-item:hover {
            background: var(--light-gray);
            border-color: var(--construction-orange);
        }

        .client-item.selected {
            background: #fff3cd;
            border-color: var(--safety-yellow);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: var(--light-gray);
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--steel-gray);
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background: white;
            color: var(--concrete-gray);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--concrete-gray);
            margin-bottom: 0.25rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--medium-gray);
            border-radius: 5px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--safety-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            display: none;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
        }

        .document-table th,
        .document-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        .document-table th {
            background: var(--light-gray);
            font-weight: 600;
        }

        .file-upload-area {
            border: 2px dashed var(--medium-gray);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            background: #e3f2fd;
            border-color: var(--blueprint-blue);
        }

        .operation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--steel-gray);
            margin-top: 0.25rem;
        }

        .file-limit-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            color: #856404;
        }

        .file-limit-warning strong {
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>üîí Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Login</button>
            <div id="loginError" class="error-message">Invalid password. Please try again.</div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminContainer" class="admin-container">
        <header class="header">
            <h1>üõ†Ô∏è Ask Foreman Admin Panel</h1>
            <div>
                <button class="btn btn-primary" onclick="window.location.href='index.html'">‚Üê Back to App</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="content">
            <!-- Client List Panel -->
            <div class="panel">
                <h2>üìÅ Client Projects</h2>
                <div id="clientList" class="client-list">
                    <!-- Client items will be loaded here -->
                </div>
            </div>

            <!-- Client Details Panel -->
            <div class="panel">
                <h2>üìã Client Management</h2>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('details')">Details</button>
                    <button class="tab" onclick="switchTab('documents')">Documents</button>
                    <button class="tab" onclick="switchTab('operations')">System Operations</button>
                </div>

                <!-- Details Tab -->
                <div id="detailsTab" class="tab-content active">
                    <div id="clientDetails">
                        <p style="color: var(--steel-gray); text-align: center; padding: 2rem;">
                            Select a client from the list to view details
                        </p>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content">
                    <div id="documentManagement">
                        <p style="color: var(--steel-gray); text-align: center; padding: 2rem;">
                            Select a client to manage documents
                        </p>
                    </div>
                </div>

                <!-- Operations Tab -->
                <div id="operationsTab" class="tab-content">
                    <div class="mass-operations">
                        <h3>üîß System Operations</h3>
                        <div class="operation-buttons">
                            <div>
                                <button class="btn btn-primary" onclick="syncAzureStorage()" style="width: 100%;">
                                    ‚òÅÔ∏è Sync Azure Storage
                                </button>
                                <p class="help-text">Scan Azure for new clients and update document counts</p>
                            </div>
                            <div>
                                <button class="btn" onclick="exportClientData()" style="width: 100%; background: #6c757d; color: white;">
                                    üì• Export Client Data
                                </button>
                                <p class="help-text">Download client list as JSON</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <h4>üì§ Bulk Upload Documents</h4>
                            
                            <!-- File Limit Warning -->
                            <div class="file-limit-warning">
                                ‚ö†Ô∏è <strong>File Limit:</strong> Maximum 15 files per upload to prevent system overload.
                            </div>
                            
                            <!-- Global Category Selection -->
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 5px;">
                                <p style="font-weight: 600; margin-bottom: 0.5rem;">Default Category for All Files:</p>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="uploadCategory" value="auto" checked>
                                        <span>ü§ñ Auto-detect</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="uploadCategory" value="drawings">
                                        <span>üìê Drawings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="uploadCategory" value="estimates">
                                        <span>üí∞ Estimates</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="uploadCategory" value="proposals">
                                        <span>üìä Proposals</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="uploadCategory" value="specs">
                                        <span>üìã Specs</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="uploadCategory" value="signed-contracts">
                                        <span>üìù Contracts</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="file-upload-area" id="bulkUploadArea" onclick="document.getElementById('bulkFileInput').click()">
                                <p>üìÅ Drop files here or click to browse</p>
                                <p style="font-size: 0.9rem; color: var(--steel-gray);">Maximum 15 files at once ‚Ä¢ You can customize category for each file after selection</p>
                            </div>
                            <input type="file" id="bulkFileInput" multiple style="display: none;" onchange="handleBulkFilesWithPreview(event)">
                            
                            <!-- File Preview Area -->
                            <div id="filePreviewArea" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 5px;">
                                <h5 style="margin-bottom: 1rem;">üìã Files to Upload:</h5>
                                <div id="fileList"></div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button class="btn btn-success" onclick="uploadFilesWithCategories()">üì§ Upload All Files</button>
                                    <button class="btn btn-danger" onclick="clearFileSelection()">‚ùå Clear Selection</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p id="loadingText" style="color: white; margin-top: 1rem;">Loading...</p>
        </div>
    </div>

    <script>
        // Configuration
        const ADMIN_PASSWORD = 'FCS2025!';
        const API_BASE = 'https://workflows.saxtechnology.com/webhook/ask-foreman';
        const AZURE_STORAGE = {
            account: 'saxtechfcs',
            container: 'fcs-clients',
            sasToken: '?sp=racwdl&st=2025-08-07T21:44:55Z&se=2030-08-08T05:59:55Z&spr=https&sv=2024-11-04&sr=c&sig=AeQA3cyePZQqGGmb6QPu5G4y1b0qB8Z5FIFZBdi6Cdo%3D'
        };
        const MAX_FILES_PER_UPLOAD = 15; // Maximum files allowed per bulk upload

        let selectedClient = null;
        let clients = [];
        let azureFunctionConfig = null; // Store configuration from API

        // Authentication
        async function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuth', 'true');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'flex';
                await loadConfiguration();
                loadClients();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function logout() {
            sessionStorage.removeItem('adminAuth');
            window.location.reload();
        }

        // Check auth on load
        window.onload = async function() {
            if (sessionStorage.getItem('adminAuth') === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'flex';
                await loadConfiguration();
                loadClients();
            }
        };

        // Load configuration from API
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        azureFunctionConfig = await response.json();
                        console.log('Configuration loaded successfully');
                    } else {
                        // API not available, use fallback
                        console.warn('API endpoint not available, using fallback configuration');
                        // Fallback: prompt for key if needed
                        azureFunctionConfig = {
                            functionAppUrl: 'https://saxtech-functionapps2.azurewebsites.net',
                            azureFunctionKey: '' // Will be set when needed
                        };
                    }
                } else {
                    console.error('Failed to load configuration');
                    // Use fallback configuration
                    azureFunctionConfig = {
                        functionAppUrl: 'https://saxtech-functionapps2.azurewebsites.net',
                        azureFunctionKey: ''
                    };
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
                // Use fallback configuration
                azureFunctionConfig = {
                    functionAppUrl: 'https://saxtech-functionapps2.azurewebsites.net',
                    azureFunctionKey: ''
                };
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load clients from Azure
        async function loadClients() {
            showLoading('Loading clients...');
            try {
                const url = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
                
                const response = await fetch(url);
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const prefixes = xmlDoc.getElementsByTagName("BlobPrefix");
                
                clients = [];
                for (let i = 0; i < prefixes.length; i++) {
                    const nameElement = prefixes[i].getElementsByTagName("Name")[0];
                    if (nameElement) {
                        const fullPath = nameElement.textContent.replace(/\/$/, '');
                        const pathParts = fullPath.split('/');
                        if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                            const clientName = pathParts[1];
                            clients.push({
                                id: clientName.toLowerCase(),
                                name: clientName,
                                folder: clientName,
                                projectType: 'Commercial',
                                description: ''
                            });
                        }
                    }
                }
                
                renderClients();
            } catch (error) {
                console.error('Error loading clients:', error);
                showStatus('error', 'Failed to load clients');
            } finally {
                hideLoading();
            }
        }

        function renderClients() {
            const listContainer = document.getElementById('clientList');
            listContainer.innerHTML = '';
            
            clients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'client-item';
                item.onclick = () => selectClient(client);
                
                item.innerHTML = `
                    <div style="font-weight: 600; color: var(--concrete-gray);">${client.name}</div>
                    <div style="font-size: 0.9rem; color: var(--steel-gray);">
                        Type: ${client.projectType}
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
        }

        function selectClient(client) {
            selectedClient = client;
            
            // Update UI selection
            document.querySelectorAll('.client-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.client-item').classList.add('selected');
            
            // Load client details
            loadClientDetails();
            loadClientDocuments();
        }

        async function loadClientDetails() {
            const detailsContainer = document.getElementById('clientDetails');
            
            // Load metadata from Azure Blob Storage (stored as JSON file)
            try {
                const metadataUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${selectedClient.folder}/.metadata.json${AZURE_STORAGE.sasToken}`;
                const response = await fetch(metadataUrl);
                
                if (response.ok) {
                    const metadata = await response.json();
                    selectedClient.description = metadata.description || '';
                    selectedClient.projectType = metadata.projectType || 'Commercial';
                }
            } catch (error) {
                console.log('No metadata found for client, using defaults');
            }
            
            detailsContainer.innerHTML = `
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="clientName" value="${selectedClient.name}">
                </div>
                <div class="form-group">
                    <label>Folder Name (in Azure)</label>
                    <input type="text" id="folderName" value="${selectedClient.folder}" readonly style="background: #f0f0f0;">
                    <p class="help-text">‚ö†Ô∏è Folder name cannot be changed after creation</p>
                </div>
                <div class="form-group">
                    <label>Project Type</label>
                    <select id="projectType">
                        <option value="Commercial" ${selectedClient.projectType === 'Commercial' ? 'selected' : ''}>Commercial</option>
                        <option value="Residential" ${selectedClient.projectType === 'Residential' ? 'selected' : ''}>Residential</option>
                        <option value="Industrial" ${selectedClient.projectType === 'Industrial' ? 'selected' : ''}>Industrial</option>
                        <option value="Healthcare" ${selectedClient.projectType === 'Healthcare' ? 'selected' : ''}>Healthcare</option>
                        <option value="Educational" ${selectedClient.projectType === 'Educational' ? 'selected' : ''}>Educational</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription">${selectedClient.description || ''}</textarea>
                    <p class="help-text">‚òÅÔ∏è Description is saved in Azure as metadata file</p>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="updateClient()">üíæ Save Changes</button>
                    <button class="btn btn-danger" onclick="deleteClient()">üóëÔ∏è Delete Client</button>
                </div>
            `;
        }

        async function loadClientDocuments() {
            const documentsContainer = document.getElementById('documentManagement');
            showLoading('Loading documents...');
            
            try {
                const prefix = `FCS-OriginalClients/${selectedClient.folder}/`;
                const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}`;
                
                const response = await fetch(listUrl);
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const blobs = xmlDoc.getElementsByTagName("Blob");
                
                // Organize documents by category/folder
                const documentsByCategory = {
                    'drawings': [],
                    'estimates': [],
                    'proposals': [],
                    'specs': [],
                    'signed-contracts': [],
                    'documents': [],
                    'other': []
                };
                
                // Parse and categorize documents
                for (let i = 0; i < blobs.length; i++) {
                    const nameEl = blobs[i].getElementsByTagName("Name")[0];
                    const propsEl = blobs[i].getElementsByTagName("Properties")[0];
                    
                    if (nameEl) {
                        const fullPath = nameEl.textContent;
                        const pathParts = fullPath.split('/');
                        
                        // Skip if it's just the folder itself or metadata
                        if (pathParts.length < 3 || fullPath.includes('.metadata')) continue;
                        
                        const category = pathParts[2]; // FCS-OriginalClients/ClientName/Category/file.pdf
                        const fileName = pathParts[pathParts.length - 1];
                        
                        if (fileName && fileName.length > 0 && !fileName.startsWith('.')) {
                            let size = '0 KB';
                            let modified = 'Unknown';
                            
                            if (propsEl) {
                                const sizeEl = propsEl.getElementsByTagName("Content-Length")[0];
                                const modEl = propsEl.getElementsByTagName("Last-Modified")[0];
                                
                                if (sizeEl) {
                                    const bytes = parseInt(sizeEl.textContent) || 0;
                                    size = formatFileSize(bytes);
                                }
                                if (modEl) {
                                    modified = new Date(modEl.textContent).toLocaleDateString();
                                }
                            }
                            
                            const doc = {
                                fullPath: fullPath,
                                fileName: fileName,
                                size: size,
                                modified: modified,
                                category: category
                            };
                            
                            // Add to appropriate category
                            if (documentsByCategory[category]) {
                                documentsByCategory[category].push(doc);
                            } else {
                                documentsByCategory['other'].push(doc);
                            }
                        }
                    }
                }
                
                // Build HTML with categorized documents
                let html = `<h3>üìÑ Documents for ${selectedClient.name}</h3>`;
                
                const totalDocs = Object.values(documentsByCategory).reduce((sum, docs) => sum + docs.length, 0);
                
                if (totalDocs === 0) {
                    html += '<p style="color: var(--steel-gray); text-align: center; padding: 2rem;">No documents found</p>';
                } else {
                    // Category display names and icons
                    const categoryInfo = {
                        'drawings': { name: 'Drawings', icon: 'üìê' },
                        'estimates': { name: 'Estimates', icon: 'üí∞' },
                        'proposals': { name: 'Proposals', icon: 'üìä' },
                        'specs': { name: 'Specifications', icon: 'üìã' },
                        'signed-contracts': { name: 'Signed Contracts', icon: 'üìù' },
                        'documents': { name: 'General Documents', icon: 'üìÅ' },
                        'other': { name: 'Other Files', icon: 'üìé' }
                    };
                    
                    // Display each category
                    for (const [category, docs] of Object.entries(documentsByCategory)) {
                        if (docs.length === 0) continue;
                        
                        const info = categoryInfo[category] || { name: category, icon: 'üìÑ' };
                        
                        html += `
                            <div style="margin-top: 2rem;">
                                <h4 style="color: var(--concrete-gray); border-bottom: 2px solid var(--safety-yellow); padding-bottom: 0.5rem; margin-bottom: 1rem;">
                                    ${info.icon} ${info.name} (${docs.length} files)
                                </h4>
                                <table class="document-table">
                                    <thead>
                                        <tr>
                                            <th>File Name</th>
                                            <th>Size</th>
                                            <th>Modified</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        for (const doc of docs) {
                            html += `
                                <tr>
                                    <td>${doc.fileName}</td>
                                    <td>${doc.size}</td>
                                    <td>${doc.modified}</td>
                                    <td>
                                        <button class="btn btn-small btn-danger" onclick="deleteDocument('${doc.fullPath}')">üóëÔ∏è Delete</button>
                                    </td>
                                </tr>
                            `;
                        }
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                }
                
                documentsContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading documents:', error);
                documentsContainer.innerHTML = `<p style="color: var(--warning-red);">Error loading documents: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // Client operations
        async function updateClient() {
            const clientData = {
                name: document.getElementById('clientName').value,
                projectType: document.getElementById('projectType').value,
                description: document.getElementById('projectDescription').value,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to Azure Blob Storage as JSON metadata file
            showLoading('Saving client details...');
            try {
                const metadataBlob = new Blob([JSON.stringify(clientData, null, 2)], { type: 'application/json' });
                const metadataUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${selectedClient.folder}/.metadata.json${AZURE_STORAGE.sasToken}`;
                
                const response = await fetch(metadataUrl, {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob',
                        'Content-Type': 'application/json'
                    },
                    body: metadataBlob
                });
                
                if (response.ok || response.status === 201) {
                    // Update in memory
                    selectedClient.name = clientData.name;
                    selectedClient.projectType = clientData.projectType;
                    selectedClient.description = clientData.description;
                    
                    showStatus('success', 'Client details saved to Azure successfully');
                    renderClients();
                } else {
                    throw new Error('Failed to save metadata');
                }
            } catch (error) {
                showStatus('error', `Failed to save: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function deleteClient() {
            if (!confirm(`Delete client "${selectedClient.name}"? This will delete all documents and cannot be undone.`)) {
                return;
            }
            
            // Check if we have the Azure Function key
            if (!azureFunctionConfig || !azureFunctionConfig.azureFunctionKey) {
                // Fallback configuration when API is not available
                azureFunctionConfig = azureFunctionConfig || {};
                azureFunctionConfig.azureFunctionKey = '8XXgu4-yK7kAdNVShD2f1a_lCYqqtU-iEcn7mRWUbnOnAzFuxl8RJA==';
                azureFunctionConfig.functionAppUrl = 'https://saxtech-functionapps2.azurewebsites.net';
            }
            
            showLoading('Deleting client and all associated files...');
            try {
                const functionUrl = azureFunctionConfig.functionAppUrl || 'https://saxtech-functionapps2.azurewebsites.net';
                const response = await fetch(`${functionUrl}/api/clients/${selectedClient.folder}?code=${azureFunctionConfig.azureFunctionKey}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.Success) {
                    showStatus('success', `Client deleted successfully. ${result.Summary.TotalDeleted} files removed.`);
                    selectedClient = null;
                    loadClients();
                    // Clear the details panel
                    document.getElementById('clientDetails').innerHTML = '<p style="color: var(--steel-gray); text-align: center; padding: 2rem;">Select a client from the list to view details</p>';
                    document.getElementById('documentManagement').innerHTML = '<p style="color: var(--steel-gray); text-align: center; padding: 2rem;">Select a client to manage documents</p>';
                } else {
                    showStatus('error', `Failed to delete client: ${result.Error}`);
                }
            } catch (error) {
                showStatus('error', `Failed to delete client: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Create new client functionality removed - use main app instead

        // Document operations
        async function deleteDocument(filePath) {
            if (!confirm(`Delete this document?\n\nFile: ${filePath.split('/').pop()}`)) {
                return;
            }
            
            showLoading('Deleting document...');
            try {
                const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
                
                const response = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'x-ms-delete-snapshots': 'include'
                    }
                });
                
                if (response.ok || response.status === 202) {
                    showStatus('success', 'Document deleted successfully');
                    loadClientDocuments();
                } else {
                    throw new Error(`Delete failed with status ${response.status}`);
                }
            } catch (error) {
                showStatus('error', `Failed to delete: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // System operations
        async function syncAzureStorage() {
            if (!confirm(`Sync with Azure Storage?\n\nWhat this does:\n- Scans all folders in Azure Blob Storage\n- Updates the client list\n- Identifies new or removed clients\n- Refreshes document counts\n\nUse this when files were added/removed outside the app.`)) {
                return;
            }
            
            await loadClients();
            showStatus('success', `Azure Storage synced. Found ${clients.length} clients.`);
        }

        function exportClientData() {
            const dataStr = JSON.stringify(clients, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clients_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showStatus('success', 'Client data exported');
        }

        // Store selected files for preview
        let selectedFiles = [];
        
        // Enhanced bulk upload with preview and 15-file limit
        function handleBulkFilesWithPreview(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            if (!selectedClient) {
                showStatus('error', 'Please select a client first');
                event.target.value = '';
                return;
            }
            
            // Check file limit
            if (files.length > MAX_FILES_PER_UPLOAD) {
                showStatus('warning', `You selected ${files.length} files. Maximum ${MAX_FILES_PER_UPLOAD} files allowed per upload. Please select fewer files.`);
                event.target.value = '';
                return;
            }
            
            // Store files for preview
            selectedFiles = Array.from(files);
            
            // Get default category
            const defaultCategory = document.querySelector('input[name="uploadCategory"]:checked')?.value || 'auto';
            
            // Build preview UI
            const fileListContainer = document.getElementById('fileList');
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr>';
            html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--medium-gray);">File Name</th>';
            html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--medium-gray);">Size</th>';
            html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--medium-gray);">Category</th>';
            html += '</tr></thead><tbody>';
            
            selectedFiles.forEach((file, index) => {
                const fileName = file.name;
                const fileSize = formatFileSize(file.size);
                
                // Auto-detect category if default is 'auto'
                let autoCategory = 'documents';
                if (defaultCategory === 'auto') {
                    const lowerName = fileName.toLowerCase();
                    if (lowerName.includes('drawing') || lowerName.includes('plan')) {
                        autoCategory = 'drawings';
                    } else if (lowerName.includes('estimate')) {
                        autoCategory = 'estimates';
                    } else if (lowerName.includes('proposal')) {
                        autoCategory = 'proposals';
                    } else if (lowerName.includes('spec')) {
                        autoCategory = 'specs';
                    } else if (lowerName.includes('contract')) {
                        autoCategory = 'signed-contracts';
                    }
                }
                
                const selectedCategory = defaultCategory === 'auto' ? autoCategory : defaultCategory;
                
                html += '<tr>';
                html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--light-gray);">${fileName}</td>`;
                html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--light-gray);">${fileSize}</td>`;
                html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--light-gray);">`;
                html += `<select id="fileCategory_${index}" style="padding: 0.25rem; border: 1px solid var(--medium-gray); border-radius: 3px;">`;
                html += `<option value="drawings" ${selectedCategory === 'drawings' ? 'selected' : ''}>üìê Drawings</option>`;
                html += `<option value="estimates" ${selectedCategory === 'estimates' ? 'selected' : ''}>üí∞ Estimates</option>`;
                html += `<option value="proposals" ${selectedCategory === 'proposals' ? 'selected' : ''}>üìä Proposals</option>`;
                html += `<option value="specs" ${selectedCategory === 'specs' ? 'selected' : ''}>üìã Specs</option>`;
                html += `<option value="signed-contracts" ${selectedCategory === 'signed-contracts' ? 'selected' : ''}>üìù Contracts</option>`;
                html += `<option value="documents" ${selectedCategory === 'documents' ? 'selected' : ''}>üìÅ Documents</option>`;
                html += `</select>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += `<p style="margin-top: 0.5rem; color: var(--steel-gray); font-size: 0.9rem;">Total files: ${selectedFiles.length} / ${MAX_FILES_PER_UPLOAD} max</p>`;
            fileListContainer.innerHTML = html;
            
            // Show preview area
            document.getElementById('filePreviewArea').style.display = 'block';
            
            // Clear file input to allow re-selection
            event.target.value = '';
        }
        
        // Upload files with individual categories
        async function uploadFilesWithCategories() {
            if (!selectedFiles || selectedFiles.length === 0) {
                showStatus('error', 'No files selected');
                return;
            }
            
            if (!selectedClient) {
                showStatus('error', 'Please select a client first');
                return;
            }
            
            showLoading(`Uploading ${selectedFiles.length} files...`);
            
            let successCount = 0;
            let overwriteCount = 0;
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileName = file.name;
                
                // Get category from dropdown
                const categorySelect = document.getElementById(`fileCategory_${i}`);
                const category = categorySelect ? categorySelect.value : 'documents';
                
                const blobPath = `FCS-OriginalClients/${selectedClient.folder}/${category}/${fileName}`;
                const uploadUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${blobPath}${AZURE_STORAGE.sasToken}`;
                
                try {
                    // Check if file exists
                    const checkResponse = await fetch(uploadUrl, { method: 'HEAD' });
                    
                    let shouldUpload = true;
                    if (checkResponse.ok) {
                        shouldUpload = confirm(`File '${fileName}' already exists in ${category}. Overwrite?`);
                        if (shouldUpload) overwriteCount++;
                    }
                    
                    if (shouldUpload) {
                        const uploadResponse = await fetch(uploadUrl, {
                            method: 'PUT',
                            headers: {
                                'x-ms-blob-type': 'BlockBlob',
                                'Content-Type': file.type || 'application/octet-stream'
                            },
                            body: file
                        });
                        
                        if (uploadResponse.ok || uploadResponse.status === 201) {
                            successCount++;
                        }
                    }
                } catch (error) {
                    console.error(`Error uploading ${fileName}:`, error);
                }
                
                document.getElementById('loadingText').textContent = `Processing file ${i + 1} of ${selectedFiles.length}...`;
            }
            
            hideLoading();
            
            let message = `Upload complete: ${successCount} files uploaded`;
            if (overwriteCount > 0) message += `, ${overwriteCount} overwritten`;
            message += '. Files will be automatically indexed.';
            
            showStatus('success', message);
            
            // Clear selection and hide preview
            clearFileSelection();
            
            // Reload documents
            loadClientDocuments();
        }
        
        // Clear file selection
        function clearFileSelection() {
            selectedFiles = [];
            document.getElementById('filePreviewArea').style.display = 'none';
            document.getElementById('bulkFileInput').value = '';
        }
        
        // Drag and drop with file limit check
        const bulkUploadArea = document.getElementById('bulkUploadArea');
        
        bulkUploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            bulkUploadArea.classList.add('dragover');
        });
        
        bulkUploadArea?.addEventListener('dragleave', () => {
            bulkUploadArea.classList.remove('dragover');
        });
        
        bulkUploadArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            bulkUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Check file limit before processing
                if (files.length > MAX_FILES_PER_UPLOAD) {
                    showStatus('warning', `You dropped ${files.length} files. Maximum ${MAX_FILES_PER_UPLOAD} files allowed per upload. Please select fewer files.`);
                    return;
                }
                handleBulkFilesWithPreview({ target: { files } });
            }
        });

        // UI helpers
        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, type === 'warning' ? 7000 : 5000); // Longer display for warnings
        }
    </script>
</body>
</html>

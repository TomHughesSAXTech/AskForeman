<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Foreman - Admin Panel v3</title>
    <style>
        :root {
            --construction-orange: #ff6b35; --safety-yellow: #ffc107; --concrete-gray: #424242;
            --steel-gray: #616161; --blueprint-blue: #1565c0; --hi-vis-green: #76ff03;
            --warning-red: #d32f2f; --white: #ffffff; --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0; --dark-gray: #212121; --shadow: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.2);
        }
        body { font-family: 'Segoe UI', sans-serif; background: #263238; min-height: 100vh; }
        .login-container, .loading-overlay { display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-box { background: white; padding: 2rem; border-radius: 10px; box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; }
        .login-box h2 { color: var(--concrete-gray); margin-bottom: 1.5rem; text-align: center; }
        .login-box input, .login-box button { width: 100%; padding: 0.75rem; border-radius: 5px; font-size: 1rem; }
        .login-box input { margin-bottom: 1rem; border: 2px solid var(--medium-gray); }
        .login-box button { background: linear-gradient(135deg, var(--safety-yellow), #f57f17); color: var(--dark-gray); border: none; font-weight: 600; cursor: pointer; }
        .error-message { color: var(--warning-red); text-align: center; margin-top: 1rem; display: none; }
        .admin-container { display: none; flex-direction: column; min-height: 100vh; }
        .header { background: linear-gradient(135deg, var(--dark-gray), var(--concrete-gray)); color: white; padding: 1rem 2rem; box-shadow: var(--shadow-lg); display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--warning-red); }
        .header h1 { font-size: 1.8rem; color: var(--safety-yellow); }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--safety-yellow), #f57f17); color: var(--dark-gray); }
        .btn-success { background: var(--hi-vis-green); color: var(--dark-gray); }
        .btn-danger { background: var(--warning-red); color: white; }
        .content { flex: 1; padding: 2rem; display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; max-width: 1600px; margin: 0 auto; width: 100%; }
        .panel { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: var(--shadow-lg); }
        .panel h2 { color: var(--concrete-gray); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--safety-yellow); }
        .client-list { max-height: 600px; overflow-y: auto; }
        .client-item { padding: 1rem; border: 1px solid var(--medium-gray); border-radius: 5px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
        .client-item:hover { background: var(--light-gray); border-color: var(--construction-orange); }
        .client-item.selected { background: #fff3cd; border-color: var(--safety-yellow); }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--medium-gray); }
        .tab { padding: 0.75rem 1.5rem; background: var(--light-gray); border: none; cursor: pointer; font-weight: 600; color: var(--steel-gray); border-radius: 5px 5px 0 0; }
        .tab.active { background: white; color: var(--concrete-gray); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; color: var(--concrete-gray); margin-bottom: 0.25rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid var(--medium-gray); border-radius: 5px; }
        .form-group textarea { min-height: 80px; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--safety-yellow); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-message { display: none; padding: 1rem; border-radius: 5px; margin-top: 1rem; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .document-category { margin-bottom: 1.5rem; }
        .document-category h4 { background: var(--light-gray); padding: 0.5rem 1rem; border-radius: 5px; }
        .document-list, .staging-list { min-height: 50px; border: 1px solid var(--medium-gray); border-radius: 5px; padding: 0.5rem; margin-top: 0.5rem; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee; cursor: grab; }
        .file-item:last-child { border-bottom: none; }
        .help-text { font-size: 0.85rem; color: var(--steel-gray); margin-top: 0.25rem; }
    </style>
</head>
<body>
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>üîí Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Login</button>
            <div id="loginError" class="error-message">Invalid password.</div>
        </div>
    </div>

    <div id="adminContainer" class="admin-container">
        <header class="header">
            <h1>üõ†Ô∏è Ask Foreman Admin Panel</h1>
            <div>
                <button class="btn" onclick="window.location.href='index.html'" style="background:var(--blueprint-blue); color:white;">‚Üê Back to App</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="content">
            <div class="panel">
                <h2>üìÅ Client Projects</h2>
                <div id="clientList" class="client-list"><p>Loading clients...</p></div>
            </div>

            <div class="panel">
                <h2>üìã Client Management</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('details')">Details</button>
                    <button class="tab" onclick="switchTab('documents')">Documents</button>
                    <button class="tab" onclick="switchTab('operations')">Bulk Operations</button>
                </div>

                <div id="detailsTab" class="tab-content active">
                    <div id="clientDetails"><p class="help-text" style="text-align:center;">Select a client to view details.</p></div>
                </div>

                <div id="documentsTab" class="tab-content">
                    <div id="documentManagement"><p class="help-text" style="text-align:center;">Select a client to manage documents.</p></div>
                </div>

                <div id="operationsTab" class="tab-content">
                    <h3>üì§ Bulk Upload</h3>
                    <div class="form-group">
                        <label for="bulkUploadClientSelect">1. Select Client for Upload</label>
                        <select id="bulkUploadClientSelect" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label>2. Add Files to Staging Area</label>
                        <input type="file" id="bulkFileInput" multiple onchange="stageFiles(event)" class="btn" style="width:100%;">
                    </div>
                    <div id="stagingArea" style="display:none;">
                         <label>3. Review and Categorize Files</label>
                        <table style="width:100%;" class="table">
                            <thead><tr><th>File Name</th><th>Category</th></tr></thead>
                            <tbody id="stagingTableBody"></tbody>
                        </table>
                        <button class="btn btn-success" style="width:100%; margin-top:1rem;" onclick="startBulkUpload()">4. Start Upload & Index</button>
                    </div>
                     <hr style="margin: 2rem 0;">
                    <h3>üîß System Operations</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">
                        <button class="btn btn-success" onclick="reindexAllDocuments()">üîÑ Reindex All</button>
                        <button class="btn btn-primary" onclick="syncAzureStorage()">‚òÅÔ∏è Sync Clients</button>
                    </div>
                </div>
                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p id="loadingText" style="color: white; margin-top: 1rem;">Loading...</p>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'FCS2025!';
        const API_BASE = 'https://workflows.saxtechnology.com/webhook/ask-foreman';
        const AZURE_STORAGE = {
            account: 'saxtechfcs', container: 'fcs-clients',
            sasToken: '?sp=racwdl&st=2025-08-07T21:44:55Z&se=2030-08-08T05:59:55Z&spr=https&sv=2024-11-04&sr=c&sig=AeQA3cyePZQqGGmb6QPu5G4y1b0qB8Z5FIFZBdi6Cdo%3D'
        };

        let selectedClient = null;
        let clients = [];
        let stagedFiles = [];
        const CATEGORIES = ['drawings', 'estimates', 'proposals', 'specs', 'signed-contracts'];

        // --- Auth ---
        window.onload = () => { if (sessionStorage.getItem('adminAuth') === 'true') { showAdminPanel(); }};
        function login() {
            if (document.getElementById('passwordInput').value === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuth', 'true');
                showAdminPanel();
            } else {
                const errEl = document.getElementById('loginError');
                errEl.style.display = 'block';
                setTimeout(() => errEl.style.display = 'none', 3000);
            }
        }
        function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'flex';
            loadClients();
        }
        function logout() { sessionStorage.removeItem('adminAuth'); window.location.reload(); }

        // --- UI ---
        function switchTab(tab) {
            document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }
        function showLoading(text='Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
        function showStatus(type, message) {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = `status-message status-${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // --- Client Management ---
        async function loadClients() {
            showLoading('Loading clients...');
            try {
                const response = await fetch(`https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`);
                const xmlText = await response.text();
                const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
                const prefixes = xmlDoc.getElementsByTagName("BlobPrefix");
                clients = Array.from(prefixes).map(p => {
                    const clientName = p.getElementsByTagName("Name")[0].textContent.replace('FCS-OriginalClients/', '').replace('/', '');
                    return { id: clientName.toLowerCase(), name: clientName, folder: clientName };
                });
                renderClients();
            } catch (e) {
                showStatus('error', 'Failed to load clients.');
            } finally {
                hideLoading();
            }
        }

        function renderClients() {
            const listContainer = document.getElementById('clientList');
            const selectContainer = document.getElementById('bulkUploadClientSelect');
            listContainer.innerHTML = '';
            selectContainer.innerHTML = '<option value="">-- Select a Client --</option>';
            clients.forEach(c => {
                const item = document.createElement('div');
                item.className = 'client-item';
                item.textContent = c.name;
                item.onclick = () => selectClient(c, item);
                listContainer.appendChild(item);
                const option = new Option(c.name, c.id);
                selectContainer.add(option);
            });
        }

        async function selectClient(client, el) {
            selectedClient = client;
            document.querySelectorAll('.client-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            await loadClientDetails();
            await loadClientDocuments();
        }

        async function loadClientDetails() {
            try {
                const res = await fetch(`https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${selectedClient.folder}/.metadata.json${AZURE_STORAGE.sasToken}`);
                if (res.ok) {
                    const metadata = await res.json();
                    selectedClient.description = metadata.description || '';
                    selectedClient.projectType = metadata.projectType || 'Commercial';
                }
            } catch (e) { /* No metadata exists, use defaults */ }
            
            const container = document.getElementById('clientDetails');
            container.innerHTML = `
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="clientName" value="${selectedClient.name}" readonly>
                    <p class="help-text">Client/folder name cannot be changed.</p>
                </div>
                <div class="form-group">
                    <label>Project Type</label>
                    <select id="projectType">${CATEGORIES.map(c => `<option value="${c}" ${selectedClient.projectType === c ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`)}</select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription">${selectedClient.description || ''}</textarea>
                </div>
                <button class="btn btn-primary" onclick="updateClient()">üíæ Save Changes</button>
            `;
        }
        
        async function updateClient() {
            showLoading('Saving...');
            const data = {
                name: document.getElementById('clientName').value,
                projectType: document.getElementById('projectType').value,
                description: document.getElementById('projectDescription').value,
                lastUpdated: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${selectedClient.folder}/.metadata.json${AZURE_STORAGE.sasToken}`;
            const res = await fetch(url, { method: 'PUT', headers: { 'x-ms-blob-type': 'BlockBlob' }, body: blob });
            hideLoading();
            showStatus(res.ok ? 'success' : 'error', res.ok ? 'Client details saved.' : 'Failed to save.');
        }

        // --- Document Management ---
        async function loadClientDocuments() {
            showLoading('Loading documents...');
            const container = document.getElementById('documentManagement');
            container.innerHTML = ''; // Clear previous
            
            try {
                 const res = await fetch(`https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/${selectedClient.folder}/`);
                const xmlText = await res.text();
                const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
                const blobs = Array.from(xmlDoc.getElementsByTagName("Blob"));

                let filesByCategory = {};
                CATEGORIES.forEach(c => filesByCategory[c] = []);

                blobs.forEach(b => {
                    const path = b.getElementsByTagName("Name")[0].textContent;
                    const name = path.split('/').pop();
                    if(name === '.metadata.json') return;
                    
                    const category = path.split('/')[2] || 'uncategorized';
                    if (filesByCategory[category]) {
                        filesByCategory[category].push({ name, path });
                    }
                });

                CATEGORIES.forEach(c => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'document-category';
                    categoryDiv.innerHTML = `<h4>${c.charAt(0).toUpperCase() + c.slice(1)}</h4>`;
                    const listDiv = document.createElement('div');
                    listDiv.className = 'document-list';
                    listDiv.dataset.category = c;
                    listDiv.ondragover = e => e.preventDefault();
                    listDiv.ondrop = e => handleFileDrop(e, c);
                    
                    if(filesByCategory[c].length > 0) {
                        filesByCategory[c].forEach(f => {
                            const fileEl = document.createElement('div');
                            fileEl.className = 'file-item';
                            fileEl.textContent = f.name;
                            fileEl.draggable = true;
                            fileEl.ondragstart = e => e.dataTransfer.setData('text/plain', f.path);
                            listDiv.appendChild(fileEl);
                        });
                    } else {
                        listDiv.innerHTML = `<p class="help-text">No files in this category.</p>`;
                    }
                    categoryDiv.appendChild(listDiv);
                    container.appendChild(categoryDiv);
                });

            } catch(e) {
                container.innerHTML = `<p class="help-text status-error">Could not load documents.</p>`;
            } finally {
                hideLoading();
            }
        }
        
        async function handleFileDrop(event, newCategory) {
            event.preventDefault();
            const sourcePath = event.dataTransfer.getData('text/plain');
            const fileName = sourcePath.split('/').pop();
            const oldCategory = sourcePath.split('/')[2];

            if (oldCategory === newCategory) return;
            
            const newPath = `FCS-OriginalClients/${selectedClient.folder}/${newCategory}/${fileName}`;
            showLoading(`Moving ${fileName} to ${newCategory}...`);

            try {
                // Copy operation
                const copyUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${newPath}${AZURE_STORAGE.sasToken}`;
                const copySource = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${sourcePath}`;
                const copyRes = await fetch(copyUrl, { method: 'PUT', headers: { 'x-ms-copy-source': copySource, 'x-ms-blob-type': 'BlockBlob' }});
                if(!copyRes.ok) throw new Error(`Copy failed: ${copyRes.statusText}`);
                
                // Delete operation
                const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${sourcePath}${AZURE_STORAGE.sasToken}`;
                const deleteRes = await fetch(deleteUrl, { method: 'DELETE' });
                if(!deleteRes.ok) throw new Error(`Delete failed: ${deleteRes.statusText}`);

                showStatus('success', `${fileName} moved successfully.`);
                await loadClientDocuments(); // Refresh view
            } catch (e) {
                showStatus('error', `Move failed: ${e.message}`);
            } finally {
                hideLoading();
            }
        }

        // --- Bulk Operations ---
        function stageFiles(event) {
            stagedFiles.push(...Array.from(event.target.files));
            document.getElementById('stagingArea').style.display = 'block';
            const tableBody = document.getElementById('stagingTableBody');
            tableBody.innerHTML = '';
            stagedFiles.forEach((file, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${file.name}</td>
                    <td>
                        <select id="category_for_${index}" class="form-control">
                            ${CATEGORIES.map(c => `<option value="${c}">${c.charAt(0).toUpperCase() + c.slice(1)}</option>`).join('')}
                        </select>
                    </td>
                `;
            });
        }
        
        async function startBulkUpload() {
            const clientId = document.getElementById('bulkUploadClientSelect').value;
            if (!clientId) {
                showStatus('error', 'Please select a client before starting the upload.');
                return;
            }
            const client = clients.find(c => c.id === clientId);

            showLoading(`Uploading ${stagedFiles.length} files...`);
            let successCount = 0;
            for (let i = 0; i < stagedFiles.length; i++) {
                const file = stagedFiles[i];
                const category = document.getElementById(`category_for_${i}`).value;
                const path = `FCS-OriginalClients/${client.folder}/${category}/${file.name}`;
                const url = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${path}${AZURE_STORAGE.sasToken}`;
                
                // Overwrite check
                const headRes = await fetch(url, { method: 'HEAD' });
                if(headRes.ok) {
                    if(!confirm(`File "${file.name}" already exists in ${category}. Overwrite?`)) continue;
                }

                const uploadRes = await fetch(url, { method: 'PUT', headers: { 'x-ms-blob-type': 'BlockBlob', 'Content-Type': file.type }, body: file });
                if (uploadRes.ok) successCount++;
                 document.getElementById('loadingText').textContent = `Uploading ${i + 1} of ${stagedFiles.length}...`;
            }
            
            hideLoading();
            showStatus('success', `${successCount} of ${stagedFiles.length} files uploaded successfully. Re-indexing will occur in the background.`);
            // Clear staging
            stagedFiles = [];
            document.getElementById('stagingArea').style.display = 'none';
            document.getElementById('stagingTableBody').innerHTML = '';
            document.getElementById('bulkFileInput').value = '';
        }

        async function reindexAllDocuments() {
            if (!confirm('Reindex all documents for all clients? This can take a long time.')) return;
            showStatus('success', 'Full system re-index has been queued.');
            // This would call a backend endpoint that can run for a long time.
        }

        async function syncAzureStorage() {
             if (!confirm('Sync client list from Azure?')) return;
             await loadClients();
        }

    </script>
</body>
</html>


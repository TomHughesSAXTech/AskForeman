<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Foreman - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --construction-orange: #ff6b35;
            --safety-yellow: #ffc107;
            --concrete-gray: #424242;
            --steel-gray: #616161;
            --blueprint-blue: #1565c0;
            --hi-vis-green: #76ff03;
            --warning-red: #d32f2f;
            --white: #ffffff;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #212121;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #37474f 0%, #263238 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 400px;
        }

        .login-box h2 {
            color: var(--concrete-gray);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .login-box input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 2px solid var(--medium-gray);
            border-radius: 5px;
            font-size: 1rem;
        }

        .login-box button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
            color: var(--dark-gray);
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            color: var(--warning-red);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* Admin Panel */
        .admin-container {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--dark-gray) 0%, var(--concrete-gray) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--warning-red);
        }

        .header h1 {
            font-size: 1.8rem;
            color: var(--safety-yellow);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
            color: var(--dark-gray);
        }

        .btn-success {
            background: var(--hi-vis-green);
            color: var(--dark-gray);
        }

        .btn-danger {
            background: var(--warning-red);
            color: white;
        }
        
        .btn-secondary {
            background: var(--steel-gray);
            color: white;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }

        .content {
            flex: 1;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
        }

        .panel h2 {
            color: var(--concrete-gray);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--safety-yellow);
        }

        .client-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .client-item {
            padding: 1rem;
            border: 1px solid var(--medium-gray);
            border-radius: 5px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .client-item:hover {
            background: var(--light-gray);
            border-color: var(--construction-orange);
        }

        .client-item.selected {
            background: #fff3cd;
            border-color: var(--safety-yellow);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--medium-gray);
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: var(--light-gray);
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--steel-gray);
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background: white;
            color: var(--concrete-gray);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--concrete-gray);
            margin-bottom: 0.25rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--medium-gray);
            border-radius: 5px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--safety-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-message {
            display: none;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .document-table {
            width: 100%;
            border-collapse: collapse;
        }

        .document-table th,
        .document-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        .document-table th {
            background: var(--light-gray);
            font-weight: 600;
        }

        .file-upload-area {
            border: 2px dashed var(--medium-gray);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            background: #e3f2fd;
            border-color: var(--blueprint-blue);
        }

        .operation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .help-text {
            font-size: 0.85rem;
            color: var(--steel-gray);
            margin-top: 0.25rem;
        }
    </style>
    <!-- External configuration for sensitive keys -->
    <script src="admin-config.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>üîí Admin Access</h2>
            <input type="password" id="passwordInput" placeholder="Enter admin password" onkeypress="if(event.key==='Enter') login()">
            <button onclick="login()">Login</button>
            <div id="loginError" class="error-message">Invalid password. Please try again.</div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminContainer" class="admin-container">
        <header class="header">
            <h1>üõ†Ô∏è Ask Foreman Admin Panel</h1>
            <div>
                <button class="btn btn-primary" onclick="window.location.href='index.html'">‚Üê Back to App</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="content">
            <!-- Client List Panel -->
            <div class="panel">
                <h2>üìÅ Client Projects</h2>
                <button class="btn btn-primary" onclick="createNewClient()" style="width: 100%; margin-bottom: 1rem;">
                    ‚ûï Create New Client
                </button>
                <div id="clientList" class="client-list">
                    <!-- Client items will be loaded here -->
                </div>
            </div>

            <!-- Client Details Panel -->
            <div class="panel">
                <h2>üìã Client Management</h2>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('details')">Details</button>
                    <button class="tab" onclick="switchTab('documents')">Documents</button>
                    <button class="tab" onclick="switchTab('operations')">System Operations</button>
                </div>

                <!-- Details Tab -->
                <div id="detailsTab" class="tab-content active">
                    <div id="clientDetails">
                        <p style="color: var(--steel-gray); text-align: center; padding: 2rem;">
                            Select a client from the list to view details
                        </p>
                    </div>
                </div>

                <!-- Documents Tab -->
                <div id="documentsTab" class="tab-content">
                    <div id="documentManagement">
                        <p style="color: var(--steel-gray); text-align: center; padding: 2rem;">
                            Select a client to manage documents
                        </p>
                    </div>
                </div>

                <!-- Operations Tab -->
                <div id="operationsTab" class="tab-content">
                    <div class="mass-operations">
                        <h3>üîß System Operations</h3>
                        <div class="operation-buttons">
                            <div>
                                <button class="btn btn-success" onclick="reindexAllDocuments()" style="width: 100%;">
                                    üîÑ Reindex All Documents
                                </button>
                                <p class="help-text">Extract text from all PDFs/docs and update search index</p>
                            </div>
                            <div>
                                <button class="btn btn-primary" onclick="syncAzureStorage()" style="width: 100%;">
                                    ‚òÅÔ∏è Sync Azure Storage
                                </button>
                                <p class="help-text">Scan Azure for new clients and update document counts</p>
                            </div>
                            <div>
                                <button class="btn" onclick="exportClientData()" style="width: 100%; background: #6c757d; color: white;">
                                    üì• Export Client Data
                                </button>
                                <p class="help-text">Download client list as JSON</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <h4>üì§ Bulk Upload Documents</h4>
                            
                            <!-- Client Selection for Upload -->
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 5px;">
                                <p style="font-weight: 600; margin-bottom: 0.5rem;">Select Client for Upload:</p>
                                <select id="uploadClientSelect" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid var(--medium-gray); border-radius: 5px;">
                                    <option value="">-- Select a Client --</option>
                                </select>
                            </div>
                            
                            <div class="file-upload-area" id="bulkUploadArea" onclick="handleUploadClick()" style="opacity: 0.5; cursor: not-allowed;">
                                <p>üìÅ Drop files here or click to browse</p>
                                <p style="font-size: 0.9rem; color: var(--steel-gray);">Select a client first, then choose category for each file</p>
                            </div>
                            <input type="file" id="bulkFileInput" multiple style="display: none;" onchange="handleBulkFilesWithPreview(event)">
                            
                            <!-- File Preview Area -->
                            <div id="filePreviewArea" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--light-gray); border-radius: 5px;">
                                <h5 style="margin-bottom: 1rem;">üìã Files to Upload:</h5>
                                <div id="fileList"></div>
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button class="btn btn-success" onclick="uploadFilesWithCategories()">üì§ Upload All Files</button>
                                    <button class="btn btn-danger" onclick="clearFileSelection()">‚ùå Clear Selection</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage" class="status-message"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <p id="loadingText" style="color: white; margin-top: 1rem;">Loading...</p>
        </div>
    </div>

    <script>
        // Configuration
        const ADMIN_PASSWORD = 'FCS2025!';
        const API_BASE = 'https://workflows.saxtechnology.com/webhook/ask-foreman';
        const AZURE_STORAGE = {
            account: 'saxtechfcs',
            container: 'fcs-clients',
            sasToken: '?sp=racwdl&st=2025-08-08T05:00:57Z&se=2030-08-08T13:15:57Z&spr=https&sv=2024-11-04&sr=c&sig=lJKK9jDZ59pJSNkKSgwaQIrCdBaJzx4XPzgEB2%2FrnIg%3D'
        };
        
        // Azure Function key is loaded from external config file or sessionStorage
        // If not found, use empty string (will fail gracefully with proper error message)
        let AZURE_FUNCTION_KEY = window.AdminConfig?.AZURE_FUNCTION_KEY || '';
        
        // Check sessionStorage as fallback
        if (!AZURE_FUNCTION_KEY) {
            try {
                const storedConfig = sessionStorage.getItem('adminConfig');
                if (storedConfig) {
                    const config = JSON.parse(storedConfig);
                    AZURE_FUNCTION_KEY = config.AZURE_FUNCTION_KEY || '';
                }
            } catch (e) {
                console.log('No config in sessionStorage');
            }
        }
        
        // Debug: Log if key is configured (without exposing the actual key)
        console.log('Azure Function key configured:', AZURE_FUNCTION_KEY ? 'Yes' : 'No');

        let selectedClient = null;
        let clients = [];

        // Authentication
        function login() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuth', 'true');
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'flex';
                loadClients();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function logout() {
            sessionStorage.removeItem('adminAuth');
            window.location.reload();
        }

        // Check auth on load
        window.onload = function() {
            if (sessionStorage.getItem('adminAuth') === 'true') {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminContainer').style.display = 'flex';
                loadClients();
            }
            
            // Setup upload client selector
            setupUploadClientSelector();
        };

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Load clients from Azure
        async function loadClients() {
            showLoading('Loading clients...');
            try {
                const url = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=FCS-OriginalClients/&delimiter=/`;
                
                const response = await fetch(url);
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const prefixes = xmlDoc.getElementsByTagName("BlobPrefix");
                
                clients = [];
                for (let i = 0; i < prefixes.length; i++) {
                    const nameElement = prefixes[i].getElementsByTagName("Name")[0];
                    if (nameElement) {
                        const fullPath = nameElement.textContent.replace(/\/$/, '');
                        const pathParts = fullPath.split('/');
                        if (pathParts.length >= 2 && pathParts[0] === 'FCS-OriginalClients') {
                            const clientName = pathParts[1];
                            clients.push({
                                id: clientName,  // Keep original capitalization
                                name: clientName,
                                folder: clientName,
                                projectType: 'Commercial',
                                description: ''
                            });
                        }
                    }
                }
                
                renderClients();
                updateUploadClientSelector();
            } catch (error) {
                console.error('Error loading clients:', error);
                showStatus('error', 'Failed to load clients');
            } finally {
                hideLoading();
            }
        }

        function renderClients() {
            const listContainer = document.getElementById('clientList');
            listContainer.innerHTML = '';
            
            clients.forEach(client => {
                const item = document.createElement('div');
                item.className = 'client-item';
                item.onclick = () => selectClient(client);
                
                item.innerHTML = `
                    <div style="font-weight: 600; color: var(--concrete-gray);">${client.name}</div>
                    <div style="font-size: 0.9rem; color: var(--steel-gray);">
                        Type: ${client.projectType}
                    </div>
                `;
                
                listContainer.appendChild(item);
            });
        }

        function selectClient(client) {
            selectedClient = client;
            
            // Update UI selection
            document.querySelectorAll('.client-item').forEach(item => item.classList.remove('selected'));
            event.target.closest('.client-item').classList.add('selected');
            
            // Load client details
            loadClientDetails();
            loadClientDocuments();
        }

        async function loadClientDetails() {
            const detailsContainer = document.getElementById('clientDetails');
            
            // Load metadata from Azure Blob Storage (stored as JSON file)
            try {
                const metadataUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${selectedClient.folder}/.metadata.json${AZURE_STORAGE.sasToken}`;
                const response = await fetch(metadataUrl);
                
                if (response.ok) {
                    const metadata = await response.json();
                    selectedClient.description = metadata.description || '';
                    selectedClient.projectType = metadata.projectType || 'Commercial';
                } else if (response.status === 404) {
                    // Metadata doesn't exist yet - this is normal for new clients
                    console.log('Metadata not found for client - will be created on first save');
                    selectedClient.description = '';
                    selectedClient.projectType = 'Commercial';
                }
            } catch (error) {
                // Network error or other issue
                console.log('Could not load metadata, using defaults:', error.message);
                selectedClient.description = '';
                selectedClient.projectType = 'Commercial';
            }
            
            detailsContainer.innerHTML = `
                <div class="form-group">
                    <label>Client Name</label>
                    <input type="text" id="clientName" value="${selectedClient.name}">
                </div>
                <div class="form-group">
                    <label>Folder Name (in Azure)</label>
                    <input type="text" id="folderName" value="${selectedClient.folder}" readonly style="background: #f0f0f0;">
                    <p class="help-text">‚ö†Ô∏è Folder name cannot be changed after creation</p>
                </div>
                <div class="form-group">
                    <label>Project Type</label>
                    <select id="projectType">
                        <option value="Commercial" ${selectedClient.projectType === 'Commercial' ? 'selected' : ''}>Commercial</option>
                        <option value="Residential" ${selectedClient.projectType === 'Residential' ? 'selected' : ''}>Residential</option>
                        <option value="Industrial" ${selectedClient.projectType === 'Industrial' ? 'selected' : ''}>Industrial</option>
                        <option value="Healthcare" ${selectedClient.projectType === 'Healthcare' ? 'selected' : ''}>Healthcare</option>
                        <option value="Educational" ${selectedClient.projectType === 'Educational' ? 'selected' : ''}>Educational</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription">${selectedClient.description || ''}</textarea>
                    <p class="help-text">‚òÅÔ∏è Description is saved in Azure as metadata file</p>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="updateClient()">üíæ Save Changes</button>
                    <button class="btn btn-danger" onclick="deleteClient()">üóëÔ∏è Delete Client</button>
                    <button class="btn btn-success" onclick="reindexClientDocuments()">üîÑ Reindex Documents</button>
                </div>
            `;
        }

        async function loadClientDocuments() {
            const documentsContainer = document.getElementById('documentManagement');
            showLoading('Loading documents...');
            
            try {
                const prefix = `FCS-OriginalClients/${selectedClient.folder}/`;
                const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}`;
                
                const response = await fetch(listUrl);
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const blobs = xmlDoc.getElementsByTagName("Blob");
                
                // Organize documents by category/folder (using capitalized folder names as in Azure)
                const documentsByCategory = {
                    'Drawings': [],
                    'Estimates': [],
                    'Proposals': [],
                    'Specs': [],
                    'Signed-Contracts': [],
                    'Documents': [],
                    'Other': []
                };
                
                // Parse and categorize documents
                for (let i = 0; i < blobs.length; i++) {
                    const nameEl = blobs[i].getElementsByTagName("Name")[0];
                    const propsEl = blobs[i].getElementsByTagName("Properties")[0];
                    
                    if (nameEl) {
                        const fullPath = nameEl.textContent;
                        const pathParts = fullPath.split('/');
                        
                        // Skip if it's just the folder itself or metadata
                        if (pathParts.length < 3 || fullPath.includes('.metadata')) continue;
                        
                        const category = pathParts[2]; // FCS-OriginalClients/ClientName/Category/file.pdf
                        const fileName = pathParts[pathParts.length - 1];
                        
                        if (fileName && fileName.length > 0 && !fileName.startsWith('.')) {
                            let size = '0 KB';
                            let modified = 'Unknown';
                            
                            if (propsEl) {
                                const sizeEl = propsEl.getElementsByTagName("Content-Length")[0];
                                const modEl = propsEl.getElementsByTagName("Last-Modified")[0];
                                
                                if (sizeEl) {
                                    const bytes = parseInt(sizeEl.textContent) || 0;
                                    size = formatFileSize(bytes);
                                }
                                if (modEl) {
                                    modified = new Date(modEl.textContent).toLocaleDateString();
                                }
                            }
                            
                            const doc = {
                                fullPath: fullPath,
                                fileName: fileName,
                                size: size,
                                modified: modified,
                                category: category
                            };
                            
                            // Add to appropriate category
                            if (documentsByCategory[category]) {
                                documentsByCategory[category].push(doc);
                            } else {
                                documentsByCategory['Other'].push(doc);
                            }
                        }
                    }
                }
                
                // Build HTML with categorized documents
                let html = `<h3>üìÑ Documents for ${selectedClient.name}</h3>`;
                
                const totalDocs = Object.values(documentsByCategory).reduce((sum, docs) => sum + docs.length, 0);
                
                if (totalDocs === 0) {
                    html += '<p style="color: var(--steel-gray); text-align: center; padding: 2rem;">No documents found</p>';
                } else {
                    // Category display names and icons (matching Azure folder names)
                    const categoryInfo = {
                        'Drawings': { name: 'Drawings', icon: 'üìê' },
                        'Estimates': { name: 'Estimates', icon: 'üí∞' },
                        'Proposals': { name: 'Proposals', icon: 'üìä' },
                        'Specs': { name: 'Specifications', icon: 'üìã' },
                        'Signed-Contracts': { name: 'Signed Contracts', icon: 'üìù' },
                        'Documents': { name: 'General Documents', icon: 'üìÅ' },
                        'Other': { name: 'Other Files', icon: 'üìé' }
                    };
                    
                    // Display each category
                    for (const [category, docs] of Object.entries(documentsByCategory)) {
                        if (docs.length === 0) continue;
                        
                        const info = categoryInfo[category] || { name: category, icon: 'üìÑ' };
                        
                        html += `
                            <div style="margin-top: 2rem;">
                                <h4 style="color: var(--concrete-gray); border-bottom: 2px solid var(--safety-yellow); padding-bottom: 0.5rem; margin-bottom: 1rem;">
                                    ${info.icon} ${info.name} (${docs.length} files)
                                </h4>
                                <table class="document-table">
                                    <thead>
                                        <tr>
                                            <th>File Name</th>
                                            <th>Size</th>
                                            <th>Modified</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        for (const doc of docs) {
                            html += `
                                <tr>
                                    <td>${doc.fileName}</td>
                                    <td>${doc.size}</td>
                                    <td>${doc.modified}</td>
                                    <td>
                                        <button class="btn btn-small btn-success" onclick="reindexDocument('${doc.fullPath}')">üîÑ Reindex</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteDocument('${doc.fullPath}')">üóëÔ∏è Delete</button>
                                    </td>
                                </tr>
                            `;
                        }
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                }
                
                documentsContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading documents:', error);
                documentsContainer.innerHTML = `<p style="color: var(--warning-red);">Error loading documents: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        // Client operations
        async function updateClient() {
            const clientData = {
                name: document.getElementById('clientName').value,
                projectType: document.getElementById('projectType').value,
                description: document.getElementById('projectDescription').value,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to Azure Blob Storage as JSON metadata file
            showLoading('Saving client details...');
            try {
                const metadataBlob = new Blob([JSON.stringify(clientData, null, 2)], { type: 'application/json' });
                const metadataUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/FCS-OriginalClients/${selectedClient.folder}/.metadata.json${AZURE_STORAGE.sasToken}`;
                
                const response = await fetch(metadataUrl, {
                    method: 'PUT',
                    headers: {
                        'x-ms-blob-type': 'BlockBlob',
                        'Content-Type': 'application/json'
                    },
                    body: metadataBlob
                });
                
                if (response.ok || response.status === 201) {
                    // Update in memory
                    selectedClient.name = clientData.name;
                    selectedClient.projectType = clientData.projectType;
                    selectedClient.description = clientData.description;
                    
                    showStatus('success', 'Client details saved to Azure successfully');
                    renderClients();
                } else {
                    throw new Error('Failed to save metadata');
                }
            } catch (error) {
                showStatus('error', `Failed to save: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function deleteClient() {
            if (!confirm(`Delete client "${selectedClient.name}"? This will delete all documents and cannot be undone.`)) {
                return;
            }
            
            showLoading('Deleting client and all associated files...');
            
            try {
                // First, list all blobs in the client folder
                const prefix = `FCS-OriginalClients/${selectedClient.folder}/`;
                const listUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(prefix)}`;
                
                const listResponse = await fetch(listUrl);
                const xmlText = await listResponse.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const blobs = xmlDoc.getElementsByTagName("Blob");
                
                let deletedCount = 0;
                let failedCount = 0;
                
                // Delete each blob
                for (let i = 0; i < blobs.length; i++) {
                    const nameEl = blobs[i].getElementsByTagName("Name")[0];
                    if (nameEl) {
                        const blobPath = nameEl.textContent;
                        const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${blobPath}${AZURE_STORAGE.sasToken}`;
                        
                        try {
                            const deleteResponse = await fetch(deleteUrl, {
                                method: 'DELETE',
                                headers: {
                                    'x-ms-delete-snapshots': 'include'
                                }
                            });
                            
                            if (deleteResponse.ok || deleteResponse.status === 202) {
                                deletedCount++;
                                console.log(`Deleted: ${blobPath}`);
                            } else {
                                failedCount++;
                                console.error(`Failed to delete: ${blobPath}`);
                            }
                        } catch (error) {
                            failedCount++;
                            console.error(`Error deleting ${blobPath}:`, error);
                        }
                    }
                    
                    // Update progress
                    document.getElementById('loadingText').textContent = `Deleting files... (${deletedCount} deleted, ${failedCount} failed)`;
                }
                
                // Also try to delete from FCS-ConvertedClients folder
                const convertedPrefix = `FCS-ConvertedClients/${selectedClient.folder}/`;
                const convertedListUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}${AZURE_STORAGE.sasToken}&restype=container&comp=list&prefix=${encodeURIComponent(convertedPrefix)}`;
                
                try {
                    const convertedResponse = await fetch(convertedListUrl);
                    const convertedXml = await convertedResponse.text();
                    const convertedDoc = parser.parseFromString(convertedXml, "text/xml");
                    const convertedBlobs = convertedDoc.getElementsByTagName("Blob");
                    
                    for (let i = 0; i < convertedBlobs.length; i++) {
                        const nameEl = convertedBlobs[i].getElementsByTagName("Name")[0];
                        if (nameEl) {
                            const blobPath = nameEl.textContent;
                            const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${blobPath}${AZURE_STORAGE.sasToken}`;
                            
                            try {
                                const deleteResponse = await fetch(deleteUrl, {
                                    method: 'DELETE',
                                    headers: {
                                        'x-ms-delete-snapshots': 'include'
                                    }
                                });
                                
                                if (deleteResponse.ok || deleteResponse.status === 202) {
                                    deletedCount++;
                                    console.log(`Deleted converted: ${blobPath}`);
                                }
                            } catch (error) {
                                console.error(`Error deleting converted ${blobPath}:`, error);
                            }
                        }
                    }
                } catch (error) {
                    console.log('No converted files or error accessing converted folder:', error);
                }
                
                if (deletedCount > 0) {
                    showStatus('success', `Client deleted successfully. ${deletedCount} files removed.`);
                    selectedClient = null;
                    loadClients();
                    // Clear the details panel
                    document.getElementById('clientDetails').innerHTML = '<p style="color: var(--steel-gray); text-align: center; padding: 2rem;">Select a client from the list to view details</p>';
                    document.getElementById('documentManagement').innerHTML = '<p style="color: var(--steel-gray); text-align: center; padding: 2rem;">Select a client to manage documents</p>';
                } else if (failedCount > 0) {
                    showStatus('error', `Failed to delete client. ${failedCount} files could not be deleted.`);
                } else {
                    showStatus('success', 'Client folder was empty or already deleted.');
                    selectedClient = null;
                    loadClients();
                }
            } catch (error) {
                console.error('Delete client error:', error);
                showStatus('error', `Failed to delete client: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function createNewClient() {
            // Create a modal for client creation
            const modalHTML = `
                <div id="createClientModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                ">
                    <div style="
                        background: white;
                        border-radius: 8px;
                        padding: 2rem;
                        width: 90%;
                        max-width: 500px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <h2 style="margin-top: 0; color: var(--concrete-gray);">Create New Client</h2>
                        
                        <div class="form-group">
                            <label>Client Name <span style="color: red;">*</span></label>
                            <input type="text" id="newClientName" placeholder="e.g., Johnson Construction" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Project Type</label>
                            <select id="newProjectType" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="Commercial">Commercial</option>
                                <option value="Residential">Residential</option>
                                <option value="Industrial">Industrial</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Educational">Educational</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Project Description</label>
                            <textarea id="newProjectDescription" placeholder="Brief description of the project..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                            <button onclick="closeCreateClientModal()" class="btn btn-secondary">Cancel</button>
                            <button onclick="submitCreateClient()" class="btn btn-primary" id="createSubmitBtn">Create Client</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('newClientName').focus();
        }
        
        function closeCreateClientModal() {
            const modal = document.getElementById('createClientModal');
            if (modal) modal.remove();
        }
        
        async function submitCreateClient() {
            const clientName = document.getElementById('newClientName').value.trim();
            const projectType = document.getElementById('newProjectType').value;
            const projectDescription = document.getElementById('newProjectDescription').value.trim();
            
            if (!clientName) {
                showStatus('error', 'Client name is required');
                return;
            }
            
            const submitBtn = document.getElementById('createSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            
            try {
                // Use the same webhook URL as the main app
                const response = await fetch('https://workflows.saxtechnology.com/webhook/ask-foreman/clients/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        clientName: clientName,
                        projectName: clientName, // Use client name as project name for backwards compatibility
                        projectType: projectType,
                        projectDescription: projectDescription
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || 'Server error'}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (e) {
                    // If response is not JSON, treat as success
                    data = { client: { id: clientName.replace(/\s+/g, '-') } };
                }
                
                // Close modal
                closeCreateClientModal();
                
                // Show success message
                showStatus('success', `Client "${clientName}" created successfully! The folder is being created in Azure Storage...`);
                
                // Wait a moment for Azure to create the folder, then reload clients
                setTimeout(async () => {
                    await loadClients();
                    
                    // Try to select the new client
                    const newClientFolder = data.client?.folderName || data.client?.id || clientName;
                    const clientItem = clients.find(c => 
                        c.folder === newClientFolder || 
                        c.name === clientName ||
                        c.folder.toLowerCase() === newClientFolder.toLowerCase()
                    );
                    
                    if (clientItem) {
                        // Select the new client
                        selectedClient = clientItem;
                        loadClientDetails();
                        loadClientDocuments();
                        
                        // Update UI to show selection
                        document.querySelectorAll('.client-item').forEach(item => {
                            if (item.textContent.includes(clientName)) {
                                item.classList.add('selected');
                            } else {
                                item.classList.remove('selected');
                            }
                        });
                        
                        showStatus('success', `Client "${clientName}" is now selected and ready for management.`);
                    } else {
                        showStatus('info', `Client "${clientName}" was created. It may take a moment to appear in the list. Please refresh if needed.`);
                    }
                    
                    // Also update the upload client selector
                    updateUploadClientSelector();
                }, 2000);
                
            } catch (error) {
                console.error('Create client error:', error);
                showStatus('error', `Failed to create client: ${error.message}`);
                
                // Re-enable the button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Client';
            }
        }

        // Document operations
        async function reindexDocument(filePath) {
            if (!confirm(`Reindex this document?\n\nWhat it does:\n- Extracts text content from the document\n- Updates the search index\n- Makes the document searchable in chat\n\nFile: ${filePath.split('/').pop()}`)) {
                return;
            }
            
            showStatus('success', 'Document queued for reindexing');
        }

        async function deleteDocument(filePath) {
            if (!confirm(`Delete this document?\n\nFile: ${filePath.split('/').pop()}`)) {
                return;
            }
            
            showLoading('Deleting document...');
            try {
                const deleteUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${filePath}${AZURE_STORAGE.sasToken}`;
                
                const response = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'x-ms-delete-snapshots': 'include'
                    }
                });
                
                if (response.ok || response.status === 202) {
                    showStatus('success', 'Document deleted successfully');
                    loadClientDocuments();
                } else {
                    throw new Error(`Delete failed with status ${response.status}`);
                }
            } catch (error) {
                showStatus('error', `Failed to delete: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function reindexClientDocuments() {
            if (!confirm(`Reindex all documents for "${selectedClient.name}"?\n\nThis will process all documents and update the search index.`)) {
                return;
            }
            
            showStatus('success', 'Client documents queued for reindexing');
        }

        // System operations
        async function reindexAllDocuments() {
            if (!confirm(`Reindex ALL documents in the system?\n\nWhat this does:\n- Processes every document in Azure storage\n- Extracts text content from PDFs, Word docs, Excel files\n- Updates the search index with latest content\n- Makes all documents searchable in the chat\n\nThis may take 30-60 minutes and impact system performance.`)) {
                return;
            }
            
            showStatus('success', 'System reindex initiated. This will run in the background.');
        }

        async function syncAzureStorage() {
            if (!confirm(`Sync with Azure Storage?\n\nWhat this does:\n- Scans all folders in Azure Blob Storage\n- Updates the client list\n- Identifies new or removed clients\n- Refreshes document counts\n\nUse this when files were added/removed outside the app.`)) {
                return;
            }
            
            await loadClients();
            showStatus('success', `Azure Storage synced. Found ${clients.length} clients.`);
        }


        function exportClientData() {
            const dataStr = JSON.stringify(clients, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `clients_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showStatus('success', 'Client data exported');
        }

        // Store selected files for preview
        let selectedFiles = [];
        
        // Setup upload client selector
        function setupUploadClientSelector() {
            const selector = document.getElementById('uploadClientSelect');
            if (selector) {
                selector.addEventListener('change', function() {
                    const uploadArea = document.getElementById('bulkUploadArea');
                    if (this.value) {
                        uploadArea.style.opacity = '1';
                        uploadArea.style.cursor = 'pointer';
                    } else {
                        uploadArea.style.opacity = '0.5';
                        uploadArea.style.cursor = 'not-allowed';
                    }
                });
            }
        }
        
        // Update upload client selector with current clients
        function updateUploadClientSelector() {
            const selector = document.getElementById('uploadClientSelect');
            if (!selector) return;
            
            // Keep current selection if any
            const currentValue = selector.value;
            
            // Clear and rebuild options
            selector.innerHTML = '<option value="">-- Select a Client --</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.folder;
                option.textContent = client.name;
                selector.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (currentValue && clients.find(c => c.folder === currentValue)) {
                selector.value = currentValue;
            }
        }
        
        // Handle upload area click
        function handleUploadClick() {
            const selector = document.getElementById('uploadClientSelect');
            if (!selector || !selector.value) {
                showStatus('error', 'Please select a client first');
                return;
            }
            document.getElementById('bulkFileInput').click();
        }
        
        // Enhanced bulk upload with preview
        function handleBulkFilesWithPreview(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const selector = document.getElementById('uploadClientSelect');
            if (!selector || !selector.value) {
                showStatus('error', 'Please select a client first');
                event.target.value = '';
                return;
            }
            
            // Find the selected client for upload
            const uploadClient = clients.find(c => c.folder === selector.value);
            if (!uploadClient) {
                showStatus('error', 'Selected client not found');
                event.target.value = '';
                return;
            }
            
            // Store files for preview with client info
            selectedFiles = Array.from(files);
            selectedFiles.uploadClient = uploadClient;
            
            // Build preview UI
            const fileListContainer = document.getElementById('fileList');
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr>';
            html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--medium-gray);">File Name</th>';
            html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--medium-gray);">Size</th>';
            html += '<th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid var(--medium-gray);">Category</th>';
            html += '</tr></thead><tbody>';
            
            selectedFiles.forEach((file, index) => {
                const fileName = file.name;
                const fileSize = formatFileSize(file.size);
                
                // Auto-detect category based on filename
                let autoCategory = 'Documents';
                const lowerName = fileName.toLowerCase();
                if (lowerName.includes('drawing') || lowerName.includes('plan')) {
                    autoCategory = 'Drawings';
                } else if (lowerName.includes('estimate')) {
                    autoCategory = 'Estimates';
                } else if (lowerName.includes('proposal')) {
                    autoCategory = 'Proposals';
                } else if (lowerName.includes('spec')) {
                    autoCategory = 'Specs';
                } else if (lowerName.includes('contract')) {
                    autoCategory = 'Signed-Contracts';
                }
                
                const selectedCategory = autoCategory;
                
                html += '<tr>';
                html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--light-gray);">${fileName}</td>`;
                html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--light-gray);">${fileSize}</td>`;
                html += `<td style="padding: 0.5rem; border-bottom: 1px solid var(--light-gray);">`;
                html += `<select id="fileCategory_${index}" style="padding: 0.25rem; border: 1px solid var(--medium-gray); border-radius: 3px;">`;
                html += `<option value="Drawings" ${selectedCategory === 'Drawings' ? 'selected' : ''}>üìê Drawings</option>`;
                html += `<option value="Estimates" ${selectedCategory === 'Estimates' ? 'selected' : ''}>üí∞ Estimates</option>`;
                html += `<option value="Proposals" ${selectedCategory === 'Proposals' ? 'selected' : ''}>üìä Proposals</option>`;
                html += `<option value="Specs" ${selectedCategory === 'Specs' ? 'selected' : ''}>üìã Specs</option>`;
                html += `<option value="Signed-Contracts" ${selectedCategory === 'Signed-Contracts' ? 'selected' : ''}>üìù Contracts</option>`;
                html += `<option value="Documents" ${selectedCategory === 'Documents' ? 'selected' : ''}>üìÅ Documents</option>`;
                html += `</select>`;
                html += `</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            fileListContainer.innerHTML = html;
            
            // Show preview area
            document.getElementById('filePreviewArea').style.display = 'block';
            
            // Clear file input to allow re-selection
            event.target.value = '';
        }
        
        // Upload files with individual categories
        async function uploadFilesWithCategories() {
            if (!selectedFiles || selectedFiles.length === 0) {
                showStatus('error', 'No files selected');
                return;
            }
            
            const uploadClient = selectedFiles.uploadClient;
            if (!uploadClient) {
                showStatus('error', 'No client selected for upload');
                return;
            }
            
            showLoading(`Uploading ${selectedFiles.length} files...`);
            
            let successCount = 0;
            let overwriteCount = 0;
            
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileName = file.name;
                
                // Get category from dropdown
                const categorySelect = document.getElementById(`fileCategory_${i}`);
                const category = categorySelect ? categorySelect.value : 'Documents';
                
                const blobPath = `FCS-OriginalClients/${uploadClient.folder}/${category}/${fileName}`;
                const uploadUrl = `https://${AZURE_STORAGE.account}.blob.core.windows.net/${AZURE_STORAGE.container}/${blobPath}${AZURE_STORAGE.sasToken}`;
                
                try {
                    console.log(`Uploading ${fileName} to ${category}`);
                    
                    // Check if file exists
                    const checkResponse = await fetch(uploadUrl, { method: 'HEAD' });
                    
                    let shouldUpload = true;
                    if (checkResponse.ok) {
                        shouldUpload = confirm(`File '${fileName}' already exists in ${category}. Overwrite?`);
                        if (shouldUpload) overwriteCount++;
                    }
                    
                    if (shouldUpload) {
                        const uploadResponse = await fetch(uploadUrl, {
                            method: 'PUT',
                            headers: {
                                'x-ms-blob-type': 'BlockBlob',
                                'Content-Type': file.type || 'application/octet-stream',
                                'x-ms-blob-content-type': file.type || 'application/octet-stream'
                            },
                            body: file
                        });
                        
                        console.log(`Upload response for ${fileName}:`, uploadResponse.status);
                        
                        if (uploadResponse.ok || uploadResponse.status === 201) {
                            successCount++;
                            console.log(`Successfully uploaded ${fileName}`);
                        } else {
                            const errorText = await uploadResponse.text();
                            console.error(`Failed to upload ${fileName}:`, uploadResponse.status, errorText);
                        }
                    } else {
                        console.log(`Skipped ${fileName} (user cancelled)`);
                    }
                } catch (error) {
                    console.error(`Error uploading ${fileName}:`, error);
                    // Show user the specific error
                    showStatus('error', `Failed to upload ${fileName}: ${error.message}`);
                }
                
                document.getElementById('loadingText').textContent = `Processing file ${i + 1} of ${selectedFiles.length}...`;
            }
            
            hideLoading();
            
            let message = `Upload complete: ${successCount} files uploaded`;
            if (overwriteCount > 0) message += `, ${overwriteCount} overwritten`;
            message += '. Files will be automatically indexed.';
            
            showStatus('success', message);
            
            // Clear selection and hide preview
            clearFileSelection();
            
            // Reload documents if we have a selected client
            if (selectedClient) {
                loadClientDocuments();
            }
        }
        
        // Clear file selection
        function clearFileSelection() {
            selectedFiles = [];
            document.getElementById('filePreviewArea').style.display = 'none';
            document.getElementById('bulkFileInput').value = '';
        }
        

        // Drag and drop
        const bulkUploadArea = document.getElementById('bulkUploadArea');
        
        bulkUploadArea?.addEventListener('dragover', (e) => {
            e.preventDefault();
            bulkUploadArea.classList.add('dragover');
        });
        
        bulkUploadArea?.addEventListener('dragleave', () => {
            bulkUploadArea.classList.remove('dragover');
        });
        
        bulkUploadArea?.addEventListener('drop', (e) => {
            e.preventDefault();
            bulkUploadArea.classList.remove('dragover');
            
            const selector = document.getElementById('uploadClientSelect');
            if (!selector || !selector.value) {
                showStatus('error', 'Please select a client first');
                return;
            }
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // Create a fake event object to pass to handleBulkFilesWithPreview
                const fakeEvent = {
                    target: {
                        files: files,
                        value: ''
                    }
                };
                handleBulkFilesWithPreview(fakeEvent);
            }
        });

        // UI helpers
        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>

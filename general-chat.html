<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ask Foreman - General Construction Knowledge</title>
    
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --construction-orange: #ff6b35;
        --safety-yellow: #ffc107;
        --concrete-gray: #424242;
        --steel-gray: #616161;
        --blueprint-blue: #1565c0;
        --hi-vis-green: #76ff03;
        --warning-red: #d32f2f;
        --white: #ffffff;
        --light-gray: #f5f5f5;
        --medium-gray: #e0e0e0;
        --dark-gray: #212121;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #37474f 0%, #263238 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: repeating-linear-gradient(
            45deg,
            transparent,
            transparent 35px,
            rgba(255, 193, 7, 0.03) 35px,
            rgba(255, 193, 7, 0.03) 70px
          ),
          repeating-linear-gradient(
            -45deg,
            transparent,
            transparent 35px,
            rgba(255, 107, 53, 0.03) 35px,
            rgba(255, 107, 53, 0.03) 70px
          );
        pointer-events: none;
      }

      .header {
        background: linear-gradient(
          135deg,
          var(--dark-gray) 0%,
          var(--concrete-gray) 100%
        );
        color: white;
        padding: 1rem 2rem;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--safety-yellow);
        position: relative;
        z-index: 10;
      }

      .header::before {
        content: "";
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 4px;
        background: repeating-linear-gradient(
          90deg,
          var(--safety-yellow) 0px,
          var(--safety-yellow) 20px,
          var(--dark-gray) 20px,
          var(--dark-gray) 40px
        );
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 1.5rem;
      }

      .logo-icon {
        width: 120px;
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        overflow: hidden;
      }

      .logo-icon img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .logo h1 {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--safety-yellow);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        letter-spacing: 1px;
      }

      .logo .tagline {
        font-size: 1rem;
        color: var(--medium-gray);
        font-weight: 500;
        margin-top: -0.25rem;
      }

      .nav-buttons {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-btn {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, var(--safety-yellow), #f57f17);
        color: var(--dark-gray);
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
      }

      .container {
        flex: 1;
        display: grid;
        grid-template-columns: 400px 1fr;
        gap: 2rem;
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
        width: 100%;
        position: relative;
        z-index: 1;
      }

      .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .card {
        background: var(--white);
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        border: 2px solid var(--medium-gray);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--construction-orange);
      }

      /* Quick Tools Section */
      .quick-tools {
        margin-top: 1rem;
      }

      .quick-tools h3 {
        color: var(--concrete-gray);
        margin-bottom: 1rem;
        font-size: 1.2rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .quick-tools h3::before {
        content: "üõ†Ô∏è";
        font-size: 1.5rem;
      }

      .tool-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .tool-item {
        background: linear-gradient(
          135deg,
          var(--light-gray) 0%,
          var(--white) 100%
        );
        border: 2px solid var(--medium-gray);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .tool-item:hover {
        border-color: var(--construction-orange);
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.2);
      }

      .tool-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: block;
      }

      .tool-name {
        font-weight: 600;
        color: var(--concrete-gray);
        font-size: 0.9rem;
      }

      /* Knowledge Graph Tips */
      .knowledge-tips {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid var(--blueprint-blue);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .knowledge-tips h4 {
        color: var(--blueprint-blue);
        margin-bottom: 0.75rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .knowledge-tips h4::before {
        content: "üåê";
        font-size: 1.2rem;
      }

      .tips-list {
        list-style: none;
      }

      .tips-list li {
        padding: 0.5rem 0;
        color: var(--steel-gray);
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(21, 101, 192, 0.1);
      }

      .tips-list li:last-child {
        border-bottom: none;
      }

      .tips-list li::before {
        content: "üí°";
        margin-right: 0.5rem;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 150px);
        position: relative;
      }

      .chat-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--construction-orange);
      }

      .chat-header {
        background: linear-gradient(
          135deg,
          var(--concrete-gray) 0%,
          var(--steel-gray) 100%
        );
        color: white;
        padding: 1.5rem;
        border-radius: 10px 10px 0 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 4px solid var(--safety-yellow);
      }

      .chat-header h2 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .chat-header h2::before {
        content: "üåê";
        font-size: 1.8rem;
      }

      .chat-messages {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        display: flex;
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message.assistant .message-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(
          135deg,
          var(--safety-yellow) 0%,
          #f57f17 100%
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        font-size: 20px;
        color: var(--dark-gray);
      }

      .message-content {
        max-width: 70%;
        padding: 1rem 1.25rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(
          135deg,
          #ffab70 0%,
          #ff8a50 100%
        );
        color: white;
        border-bottom-right-radius: 3px;
      }

      .message.assistant .message-content {
        background: white;
        color: var(--concrete-gray);
        border-bottom-left-radius: 3px;
        border: 1px solid var(--medium-gray);
      }

      .message-time {
        font-size: 0.75rem;
        color: #95a5a6;
        margin-top: 0.5rem;
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 0.25rem;
        padding: 1rem;
        background: white;
        border-radius: 10px;
        width: fit-content;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-left: 3.5rem;
      }

      .typing-indicator.active {
        display: flex;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--construction-orange);
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      .chat-input-container {
        padding: 1.5rem;
        background: white;
        border-radius: 0 0 10px 10px;
        border-top: 2px solid var(--medium-gray);
      }

      .chat-context-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: var(--light-gray);
        border-radius: 8px;
        border: 1px solid var(--medium-gray);
      }

      .chat-context-selector label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--concrete-gray);
        white-space: nowrap;
      }

      .chat-context-selector select {
        padding: 0.5rem;
        border: 1px solid var(--medium-gray);
        border-radius: 5px;
        font-size: 0.9rem;
        background: white;
        color: var(--concrete-gray);
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
      }

      .chat-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .chat-input-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        width: 100%;
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 2px solid var(--medium-gray);
        border-radius: 25px;
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .chat-input:focus {
        outline: none;
        border-color: var(--construction-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .image-attach-button {
        background: linear-gradient(135deg, var(--blueprint-blue), #0d47a1);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 50%;
        cursor: pointer;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 1.2rem;
      }

      .image-attach-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(21, 101, 192, 0.4);
      }

      .send-button, .stop-button {
        background: linear-gradient(
          135deg,
          #ffab70 0%,
          #ff8a50 100%
        );
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(255, 171, 112, 0.3);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--medium-gray);
      }

      .stop-button {
        background: var(--warning-red);
        display: none;
      }

      .stop-button.show {
        display: flex;
      }

      .image-preview-area {
        display: none;
        padding: 1rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e8f4fd 100%);
        border: 2px dashed var(--blueprint-blue);
        border-radius: 8px;
        margin-bottom: 1rem;
        position: relative;
        min-height: 120px;
        max-height: 300px;
        overflow-x: auto;
        white-space: nowrap;
      }

      .image-preview-area.active {
        display: block;
      }

      .ai-disclaimer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        font-size: 0.85rem;
        color: var(--dark-gray);
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
          padding: 1rem;
        }

        .sidebar {
          order: 2;
        }

        .chat-container {
          height: 500px;
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <img src="ForemanAI.png" alt="Ask Foreman" />
        </div>
        <div>
          <h1>ASK FOREMAN AI</h1>
          <p class="tagline">General Construction Knowledge</p>
        </div>
      </div>
      <div class="nav-buttons">
        <a href="landing.html" class="nav-btn">üè† Home</a>
        <a href="index.html" class="nav-btn">üìä Estimating</a>
        <a href="project-management.html" class="nav-btn">üìÅ Projects</a>
      </div>
    </header>

    <div class="container">
      <aside class="sidebar">
        <div class="card">
          <div class="quick-tools">
            <h3>Quick Tools</h3>
            <div class="tool-grid">
              <div class="tool-item" onclick="useTool('calculator')">
                <span class="tool-icon">üßÆ</span>
                <span class="tool-name">Construction Calculator</span>
              </div>
              <div class="tool-item" onclick="useTool('search')">
                <span class="tool-icon">üîç</span>
                <span class="tool-name">Google Search</span>
              </div>
              <div class="tool-item" onclick="useTool('converter')">
                <span class="tool-icon">üìè</span>
                <span class="tool-name">Unit Converter</span>
              </div>
              <div class="tool-item" onclick="useTool('codes')">
                <span class="tool-icon">üìã</span>
                <span class="tool-name">Building Codes</span>
              </div>
            </div>
          </div>

          <div class="knowledge-tips">
            <h4>Knowledge Graph Pro Tips</h4>
            <ul class="tips-list">
              <li>Ask about paint coverage rates for specific surfaces</li>
              <li>Compare fireproofing materials across projects</li>
              <li>Get insulation R-value recommendations</li>
              <li>Calculate resinous flooring square footage</li>
              <li>Find similar project specifications</li>
              <li>Cross-reference material costs and suppliers</li>
            </ul>
          </div>
        </div>
      </aside>

      <main class="card chat-container">
        <div class="chat-header">
          <h2>General Construction Assistant</h2>
          <span style="font-size: 0.9rem; opacity: 0.8">
            Knowledge Graph Enabled - Search All Projects
          </span>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message assistant">
            <div class="message-avatar">üî®</div>
            <div class="message-content">
              <div class="formatted-content">
                <p><strong>Hi, I'm your AI Foreman!</strong></p>
                <p>I have access to general construction knowledge AND can search across all your projects using the Knowledge Graph.</p>
                <p>I specialize in:</p>
                <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                  <li>üé® Commercial & Industrial Painting</li>
                  <li>üî• Fireproofing Systems</li>
                  <li>üèóÔ∏è Insulation Solutions</li>
                  <li>üè¢ Resinous Flooring</li>
                </ul>
                <p><strong>üí° Try asking:</strong> "What paint was used in the ABC project?" or "Calculate coverage for 5000 sq ft of epoxy flooring"</p>
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>

        <div class="chat-input-container">
          <div id="imagePreviewArea" class="image-preview-area"></div>
          
          <div class="chat-input-wrapper">
            <div class="chat-context-selector">
              <label for="chatContextSelect">üéØ Focus on:</label>
              <select id="chatContextSelect">
                <option value="general">General Knowledge</option>
                <option value="all-clients">üåê Knowledge Graph (All Projects)</option>
              </select>
            </div>
            <div class="chat-input-row">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Ask about painting, fireproofing, insulation, flooring, or search across projects..."
              />
              <input type="file" id="imageFileInput" accept="image/*" style="display: none;" multiple />
              <button class="image-attach-button" id="attachButton" title="Attach images">
                üìé
              </button>
              <button class="send-button" id="sendButton">
                <span>Send</span>
                <span>‚Üí</span>
              </button>
              <button class="stop-button" id="stopButton">
                <span>Stop</span>
                <span>‚èπ</span>
              </button>
            </div>
          </div>

          <div class="ai-disclaimer">
            <span class="disclaimer-icon">‚ö†Ô∏è</span>
            <span class="disclaimer-text">
              Ask Foreman AI <strong>can make mistakes</strong> and you should verify important information.
            </span>
          </div>
        </div>
      </main>
    </div>

    <!-- Enhanced Image Handler Script with Azure Computer Vision -->
    <script src="js/chat-image-handler-v2.js"></script>
    
    <!-- Knowledge Graph Integration -->
    <script src="js/knowledge-graph.js"></script>
    
    <!-- Comprehensive Fixes for UI/UX and Performance -->
    <script src="js/comprehensive-fixes.js"></script>
    
    <script>
      // Configuration
      const API_CONFIG = {
        chatWebhookUrl: "https://workflows.saxtechnology.com/webhook/ask-foreman/chat",
        indexName: "construction-docs-index",
      };

      // Chat context
      let chatContext = "general";
      let isGenerating = false;
      let abortController = null;

      // DOM Elements
      const chatInput = document.getElementById("chatInput");
      const sendButton = document.getElementById("sendButton");
      const stopButton = document.getElementById("stopButton");
      const chatMessages = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      const chatContextSelect = document.getElementById("chatContextSelect");
      const imageFileInput = document.getElementById("imageFileInput");
      const attachButton = document.getElementById("attachButton");
      const imagePreviewArea = document.getElementById("imagePreviewArea");

      // Quick Tools Integration
      function useTool(tool) {
        let message = "";
        switch(tool) {
          case 'calculator':
            message = "I need help with construction calculations";
            break;
          case 'search':
            message = "Search Google for the latest construction industry standards";
            break;
          case 'converter':
            message = "Convert 100 square feet to square meters";
            break;
          case 'codes':
            message = "What are the current building codes for fireproofing in commercial buildings?";
            break;
        }
        chatInput.value = message;
        chatInput.focus();
      }

      // Chat context selection
      chatContextSelect.addEventListener("change", (e) => {
        chatContext = e.target.value;
        if (chatContext === "all-clients") {
          addSystemMessage("üåê Knowledge Graph activated! I can now search across ALL projects for patterns, materials, costs, and specifications.");
          chatInput.placeholder = "Search across all projects...";
        } else {
          addSystemMessage("üìö General construction knowledge mode. I'll provide industry-standard guidance and best practices.");
          chatInput.placeholder = "Ask about painting, fireproofing, insulation, flooring...";
        }
      });

      // Image attachment
      attachButton.addEventListener("click", () => {
        imageFileInput.click();
      });

      imageFileInput.addEventListener("change", (e) => {
        handleImageFiles(e.target.files);
      });

      // Handle image paste
      document.addEventListener("paste", (e) => {
        const items = e.clipboardData.items;
        for (let item of items) {
          if (item.type.indexOf("image") !== -1) {
            const blob = item.getAsFile();
            handleImageFiles([blob]);
          }
        }
      });

      function handleImageFiles(files) {
        // Implementation for image handling
        console.log("Images attached:", files);
        imagePreviewArea.classList.add("active");
        // Add preview logic here
      }

      // Send message
      async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message) return;
        if (isGenerating) return;

        isGenerating = true;
        abortController = new AbortController();
        
        sendButton.disabled = true;
        stopButton.classList.add("show");
        
        addMessage(message, "user");
        chatInput.value = "";
        
        typingIndicator.classList.add("active");
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        try {
          const response = await fetch(API_CONFIG.chatWebhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              client: chatContext === "all-clients" ? "all-clients" : "general",
              useKnowledgeGraph: chatContext === "all-clients",
              conversationId: `general_${Date.now()}`,
              sessionId: "general-chat",
            }),
            signal: abortController.signal
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          
          typingIndicator.classList.remove("active");
          addMessage(data.response || "I couldn't generate a response. Please try again.", "assistant");
          
        } catch (error) {
          typingIndicator.classList.remove("active");
          if (error.name === 'AbortError') {
            addSystemMessage("Response generation stopped.");
          } else {
            addMessage("Sorry, I encountered an error. Please try again.", "assistant");
          }
          console.error("Chat error:", error);
        } finally {
          isGenerating = false;
          sendButton.disabled = false;
          stopButton.classList.remove("show");
          abortController = null;
        }
      }

      // Stop generation
      stopButton.addEventListener("click", () => {
        if (abortController) {
          abortController.abort();
        }
      });

      // Message handling
      function addMessage(content, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        if (sender === "assistant") {
          messageDiv.innerHTML = `
            <div class="message-avatar">üî®</div>
            <div class="message-content">
              <div class="formatted-content">${formatContent(content)}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="formatted-content">${escapeHtml(content)}</div>
              <div class="message-time">${time}</div>
            </div>
          `;
        }

        if (typingIndicator.parentNode === chatMessages) {
          chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
          chatMessages.appendChild(messageDiv);
        }
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addSystemMessage(content) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant";
        messageDiv.innerHTML = `
          <div class="message-avatar">‚öôÔ∏è</div>
          <div class="message-content" style="background: linear-gradient(135deg, var(--safety-yellow), #f57f17); color: var(--dark-gray);">
            <div class="formatted-content"><strong>${content}</strong></div>
            <div class="message-time">${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
          </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function formatContent(content) {
        if (!content) return '';
        content = String(content);
        
        // Basic formatting
        content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        content = content.replace(/\*(.+?)\*/g, '<em>$1</em>');
        content = content.replace(/`(.+?)`/g, '<code style="background: #f6f8fa; padding: 2px 6px; border-radius: 3px;">$1</code>');
        content = content.replace(/\n/g, '<br>');
        
        return content;
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Enter key handling
      chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Initialize
      window.addEventListener("load", () => {
        chatInput.focus();
      });
    </script>
  </body>
</html>
